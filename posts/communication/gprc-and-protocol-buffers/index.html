<!doctype html><html lang=zh-cn dir=auto><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="最近工作中需要用到 gPRC，赶紧学了一下，顺便做了些笔记。 gPRC 与 Protocol Buffers 经常一起使用，二者的关系非常密切。因为 gPRC 不仅将 Protocol Buffers 作为自己的 IDL（Int">
<meta name=theme-color content="#ffcd00">
<meta property="og:title" content="gPRC 与 Protocol Buffers • Nicholas Zhan">
<meta property="og:description" content="最近工作中需要用到 gPRC，赶紧学了一下，顺便做了些笔记。 gPRC 与 Protocol Buffers 经常一起使用，二者的关系非常密切。因为 gPRC 不仅将 Protocol Buffers 作为自己的 IDL（Int">
<meta property="og:url" content="https://zhannicholas.github.io/posts/communication/gprc-and-protocol-buffers/">
<meta property="og:site_name" content="Nicholas Zhan">
<meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/85f2cc2a45fd9533b91a65214224f9d7?s=256"><meta property="article:section" content="posts"><meta property="article:tag" content="RPC"><meta property="article:tag" content="Communication"><meta property="article:published_time" content="2021-09-18T22:34:56+08:00"><meta property="article:modified_time" content="2021-09-18T22:34:56+08:00"><meta name=twitter:card content="summary">
<meta name=generator content="Hugo 0.88.1">
<title>gPRC 与 Protocol Buffers • Nicholas Zhan</title>
<link rel=canonical href=https://zhannicholas.github.io/posts/communication/gprc-and-protocol-buffers/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/assets/css/main.ab98e12b.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style>
</head>
<body class="page type-posts has-sidebar">
<div class=site><div id=sidebar class=sidebar>
<a class=screen-reader-text href=#main-menu>跳到主菜单</a>
<div class=container><section class="widget widget-about sep-after">
<header>
<div class=logo>
<a href=/>
<img src=/images/logo.png>
</a>
</div>
<h2 class="title site-title">
<a href=/>
Nicholas Zhan
</a>
</h2>
<div class=desc>
Java Developer, Runner, Cyclist
</div>
</header>
</section>
<section class="widget widget-search sep-after">
<header>
<h4 class="title widget-title">搜索</h4>
</header>
<form action=/search id=search-form class=search-form>
<label>
<span class=screen-reader-text>搜索</span>
<input id=search-term class=search-term type=search name=q placeholder=搜索&mldr;>
</label></form>
</section>
<section class="widget widget-sidebar_menu sep-after"><nav id=sidebar-menu class="menu sidebar-menu" aria-label=侧边栏菜单>
<div class=container>
<ul><li class="item has-children">
<a href=/java/>Java</a><button class=sub-menu-toggler>
<span class=screen-reader-text>expand sub menu</span>
<span class=sign></span>
</button>
<ul class=sub-menu><li class=item>
<a href=/java/jakartaee/>Jakarta EE</a></li><li class=item>
<a href=/java/jvm/>JVM</a></li><li class=item>
<a href=/java/concurrency/>并发</a></li></ul></li><li class=item>
<a href=/rust/>Rust</a></li><li class=item>
<a href=/distributed_computing/>分布式计算</a></li><li class=item>
<a href=/operating_systems/>操作系统</a></li><li class="item has-children">
<a href=/computer_networks/>计算机网络</a><button class=sub-menu-toggler>
<span class=screen-reader-text>expand sub menu</span>
<span class=sign></span>
</button>
<ul class=sub-menu><li class=item>
<a href=/computer_networks/http/>HTTP</a></li><li class=item>
<a href=/computer_networks/fundamentals/>基础知识</a></li></ul></li></ul>
</div>
</nav>
</section><section class="widget widget-taxonomy_cloud sep-after">
<header>
<h4 class="title widget-title">标签</h4>
</header>
<div class="container list-container">
<ul class="list taxonomy-cloud"><li>
<a href=/tags/communication/ style=font-size:1em>Communication</a>
</li><li>
<a href=/tags/c%E7%AE%97%E6%B3%95/ style=font-size:1.3846153846153846em>C算法</a>
</li><li>
<a href=/tags/english/ style=font-size:1em>English</a>
</li><li>
<a href=/tags/gc/ style=font-size:1.1538461538461537em>GC</a>
</li><li>
<a href=/tags/git/ style=font-size:1em>Git</a>
</li><li>
<a href=/tags/http/ style=font-size:1.5384615384615385em>HTTP</a>
</li><li>
<a href=/tags/hugo/ style=font-size:1em>Hugo</a>
</li><li>
<a href=/tags/jakartaee/ style=font-size:1.1538461538461537em>JakartaEE</a>
</li><li>
<a href=/tags/java/ style=font-size:2em>Java</a>
</li><li>
<a href=/tags/jdbc/ style=font-size:1em>JDBC</a>
</li><li>
<a href=/tags/jvm/ style=font-size:1.2307692307692308em>JVM</a>
</li><li>
<a href=/tags/leetcode/ style=font-size:1.1538461538461537em>Leetcode</a>
</li><li>
<a href=/tags/life/ style=font-size:1em>Life</a>
</li><li>
<a href=/tags/linux/ style=font-size:1.2307692307692308em>Linux</a>
</li><li>
<a href=/tags/mybatis/ style=font-size:1em>MyBatis</a>
</li><li>
<a href=/tags/networks/ style=font-size:1.1538461538461537em>Networks</a>
</li><li>
<a href=/tags/os/ style=font-size:1.4615384615384617em>OS</a>
</li><li>
<a href=/tags/ostep/ style=font-size:1.1538461538461537em>OSTEP</a>
</li><li>
<a href=/tags/python/ style=font-size:1em>Python</a>
</li><li>
<a href=/tags/redis/ style=font-size:1.5384615384615385em>Redis</a>
</li><li>
<a href=/tags/rpc/ style=font-size:1em>RPC</a>
</li><li>
<a href=/tags/rust/ style=font-size:1.4615384615384617em>Rust</a>
</li><li>
<a href=/tags/sicp/ style=font-size:1em>SICP</a>
</li><li>
<a href=/tags/spring/ style=font-size:1em>Spring</a>
</li><li>
<a href=/tags/spring-boot/ style=font-size:1em>Spring Boot</a>
</li><li>
<a href=/tags/tomcat/ style=font-size:1em>Tomcat</a>
</li><li>
<a href=/tags/zookeeper/ style=font-size:1em>ZooKeeper</a>
</li><li>
<a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/ style=font-size:1.0769230769230769em>分布式计算</a>
</li><li>
<a href=/tags/%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF/ style=font-size:1.0769230769230769em>多处理器编程的艺术</a>
</li><li>
<a href=/tags/%E5%B7%A5%E7%A8%8B%E6%80%9D%E7%BB%B4/ style=font-size:1em>工程思维</a>
</li><li>
<a href=/tags/%E5%B9%B6%E5%8F%91/ style=font-size:1.4615384615384617em>并发</a>
</li><li>
<a href=/tags/%E6%90%9C%E7%B4%A2/ style=font-size:1em>搜索</a>
</li><li>
<a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ style=font-size:1.0769230769230769em>数据库</a>
</li><li>
<a href=/tags/%E6%B8%B8%E8%AE%B0/ style=font-size:1em>游记</a>
</li><li>
<a href=/tags/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ style=font-size:1.0769230769230769em>现代操作系统</a>
</li><li>
<a href=/tags/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85/ style=font-size:1em>生产者消费者</a>
</li><li>
<a href=/tags/%E7%AE%97%E6%B3%95%E5%AF%BC%E8%AE%BA/ style=font-size:1.2307692307692308em>算法导论</a>
</li><li>
<a href=/tags/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/ style=font-size:1em>设计原则</a>
</li><li>
<a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ style=font-size:1.9230769230769231em>设计模式</a>
</li></ul>
</div>
</section>
</div>
<div class=sidebar-overlay></div>
</div><div class=main><nav id=main-menu class="menu main-menu" aria-label=主菜单>
<div class=container>
<a class=screen-reader-text href=#content>跳到内容</a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text>Toggle Sidebar</span>
<span class=open><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</span>
<span class=close><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</span>
</button>
<ul><li class=item>
<a href=/>主页</a>
</li><li class="item current">
<a aria-current=page href=/posts/>博客</a>
</li><li class=item>
<a href=/notebook/>笔记本</a>
</li><li class=item>
<a href=/itinerary/>游山玩水</a>
</li></ul>
</div>
</nav><div class=header-widgets>
<div class=container>
<style>.widget-breadcrumbs li:after{content:'\2f '}</style>
<section class="widget widget-breadcrumbs sep-after">
<nav id=breadcrumbs>
<ol><li><a href=/>主页</a></li><li><a href=/posts/>博客</a></li><li><span>gPRC 与 Protocol Buffers</span></li></ol>
</nav>
</section></div>
</div>
<header id=header class="header site-header">
<div class="container sep-after">
<div class=header-info><p class="site-title title">Nicholas Zhan</p><p class="desc site-desc">Java Developer, Runner, Cyclist</p>
</div>
</div>
</header>
<main id=content>
<article lang=zh-cn class=entry>
<header class="header entry-header">
<div class="container sep-after">
<div class=header-info>
<h1 class=title>gPRC 与 Protocol Buffers</h1>
</div>
<div class=entry-meta>
<span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<span class=screen-reader-text>Posted on </span>
<time class=entry-date datetime=2021-09-18T22:34:56+08:00>2021, Sep 18</time>
</span>
<span class=byline><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M21 21V20c0-2.76-4-5-9-5s-9 2.24-9 5v1"/><path d="M16 6.37A4 4 0 1112.63 3 4 4 0 0116 6.37z"/></svg>
<span class=screen-reader-text> by </span><a href=/authors/zhannicholas>Nicholas Zhan</a></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>
6 mins read
</span>
</div>
</div>
</header>
<details class="container entry-toc">
<summary class=title>
<span>目录</span>
</summary>
<nav id=TableOfContents>
<ul>
<li><a href=#grpc>gRPC</a>
<ul>
<li><a href=#grpc-调用过程>gRPC 调用过程</a></li>
<li><a href=#定义服务>定义服务</a></li>
</ul>
</li>
<li><a href=#protocol-buffers>Protocol Buffers</a>
<ul>
<li><a href=#消息类型的定义>消息类型的定义</a></li>
<li><a href=#字段类型>字段类型</a></li>
<li><a href=#在-java-中使用-protocol-buffers>在 Java 中使用 Protocol Buffers</a></li>
</ul>
</li>
<li><a href=#参考资料>参考资料</a></li>
</ul>
</nav>
</details>
<div class="container entry-content">
<p>最近工作中需要用到 gPRC，赶紧学了一下，顺便做了些笔记。</p>
<p>gPRC 与 Protocol Buffers 经常一起使用，二者的关系非常密切。因为 gPRC 不仅将 Protocol Buffers 作为自己的 IDL（Interface Definition Language），还将其用作底层的消息交换格式。</p>
<h2 id=grpc>gRPC</h2>
<blockquote>
<p>A hight performance, open source universal RPC framework.</p>
</blockquote>
<p><a href=https://grpc.io>gPRC</a> 是一个由 Google 出品的 RPC（Remote Procedure Call） 框架。在笔者写这篇文章的时候，gPRC 还是<a href=https://cncf.io/>云原生计算基金会（CNCF）</a> 的一个孵化项目。</p>
<p>gRPC 的核心思想和其它的 RPC 框架一样，都是定义一个服务，然后声明可以被远程调用的方法以及方法的参数和返回类型。服务端实现定义的接口并处理客户端的调用，而客户端则有一个桩对象（stub），它提供了与服务端相同的方法。</p>
<h3 id=grpc-调用过程>gRPC 调用过程</h3>
<p>gRPC 的使用者通常会在服务端实现 <code>.proto</code> 文件中描述的服务 API，然后在客户端进行 API 的调用。每一个 API 都涉及服务端和客户端两方面，服务端负责实现，而客户端进行调用，它们是一一对应的。</p>
<p>服务端不仅会实现 <code>.proto</code> 所描述的服务中声明的方法，还会运行一个处理客户端调用的服务器。gRPC 会解码传入请求，执行服务方法，并编码服务响应。而在客户端这一侧，会有一个实现了相同服务方法本地对象（一般叫 <code>stub</code>，有些语言也称 <code>client</code>）。客户端会直接调用这个本地对象上的方法，使用恰当的 Protocol Buffers 消息类型包裹方法参数。gRPC 会将请求发送给服务端，并获取服务端的响应数据。</p>
<p>下面这张图来自 gRPC 官网，它不仅展示出了 gRPC 中客户端与服务端交互的过程，还暗示了 gRPC 是跨语言的：</p>
<p><img src=/images/gRPC/gRPC-call-process.svg alt=gRPC></p>
<p>当下分布式系统和微服务架构非常流行，RPC 的这一大特点使得我们创建分布式应用和服务更加简单。</p>
<h3 id=定义服务>定义服务</h3>
<p>默认情况下，gRPC 使用 Protocol Buffers 描述服务接口和消息负载（message payload）的结构。我们也可以按照实际需要，选择其它的语言来描述接口和消息的结构。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=color:#66d9ef>service</span> HelloService {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>rpc</span> SayHello (HelloRequest) <span style=color:#66d9ef>returns</span> (HelloResponse);<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>HelloRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> greeting <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>HelloResponse</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> reply <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>以上代码使用 Protocol Buffers 描述了 <code>HelloRequest</code> 和 <code>HelloResponse</code> 这两个消息的结构，以及服务接口 <code>HelloService</code>。在服务接口 <code>HelloService</code> 中，有一个简单的方法叫 <code>SayHello</code>，它从客户端接收 <code>HelloRequest</code> 并以 <code>HelloResponse</code> 响应。<code>SayHello</code> 作为一个入门的例子，给我们展示的是 gRPC 中最简单的通信模式——Unary RPC。</p>
<p>实际上，gRPC 中有四种通信模式：</p>
<ul>
<li><strong>Unary RPC</strong>：客户端向服务端发送单个请求，并从服务端获取单个响应。用 Protocol Buffers 描述服务接口的方法，就是：<code>rpc SayHello (HelloRequest) returns (HelloResponse)</code>。</li>
<li><strong>Server Streaming RPC</strong>：客户端向服务端发送一个请求，并从服务端获得一个响应流。客户端会从这个响应流中读取一个消息序列，gRPC 会保证每个 RPC 调用中消息的顺序。用 Protocol Buffers 描述服务接口的方法，就是：<code>rpc SayHello (HelloRequest) returns (stream HelloResponse)</code></li>
<li><strong>Client Streaming RPC</strong>：客户端向流中写入一个消息序列，然后把它发给服务端，等待服务端返回单个响应。gRPC 依然会保证客户端流中消息的顺序。用 Protocol Buffers 描述服务接口的方法，就是：<code>rpc SayHello (stream HelloRequest) returns (HelloResponse)</code></li>
<li><strong>Bidirectional Streaming RPC</strong>：客户端以消息流的方式给服务端发送数据，而服务端也以消息流的方式响应数据。gRPC 会保证每个流当中消息的顺序。用 Protocol Buffers 描述服务接口的方法，就是：<code>rpc SayHello (stream HelloRequest) returns (stream HelloResponse)</code></li>
</ul>
<p>不难发现，流式通信与普通通信在描述时只有一个差别：是否有 <code>stream</code> 关键字。</p>
<h2 id=protocol-buffers>Protocol Buffers</h2>
<blockquote>
<p>Protocol buffers are a language-neutral, platform-neutral extensible mechanism for serializing structured data.</p>
</blockquote>
<p><a href=https://developers.google.com/protocol-buffers>Protocol Buffers</a> 是一种对结构化数据进行序列化的机制，它不仅跨语言、跨平台，还可扩展。</p>
<h3 id=消息类型的定义>消息类型的定义</h3>
<p>直接看官网的例子：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>SearchRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> query <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>int32</span> page_number <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>int32</span> result_per_page <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>以上定义了一个非常简单的消息类型（message type）。如果要使用 <code>proto3</code>，文件的第一非空白且非注释的行必须这么写，否则编译器会认为我们使用的是 <code>proto2</code>。在 <code>SearchRequest</code> 内部，声明了三个字段（键值对），每个字段都有自己的名字和类型。此外，每个字段还有一个与之相关联的数字（unique number），一个消息中的每个字段的数字各不相同。其实，这些数字是用来识别二进制格式的消息中的字段的，所以它们应该是唯一的，并且在消息类型投入使用之后不应该再被修改。</p>
<p>标识字段的数字也是有范围限制的，允许的范围是 $[1, 2^{29} - 1]$。其中，[19000, 19999] 是 Protocol Buffers 自己使用的，我们不可使用它们。范围在 [1, 15] 内的数字采用一个字节编码（编码内容包括数字本身和字段类型），应当被用在使用最频繁的字段上；而范围在 [16, 2047] 内的数字在编码时采用两个字节，适合被用在使用没那么频繁的字段上。</p>
<h3 id=字段类型>字段类型</h3>
<p>消息的字段可以是标量类型（scalar type），也可以是复合类型（比如枚举类型或其它消息类型）。</p>
<h4 id=标量类型>标量类型</h4>
<p>以下表格列出了 Protocol Buffers 中的标量类型与其在 Java/Python 中对应的数据类型：</p>
<table>
<thead>
<tr>
<th>.proto Type</th>
<th>Java Type</th>
<th>Python Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>double</td>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>int32</td>
<td>int</td>
<td>int</td>
</tr>
<tr>
<td>int64</td>
<td>long</td>
<td>int/long</td>
</tr>
<tr>
<td>uint32</td>
<td>int</td>
<td>int/long</td>
</tr>
<tr>
<td>uint64</td>
<td>long</td>
<td>int/long</td>
</tr>
<tr>
<td>sint32</td>
<td>int</td>
<td>int</td>
</tr>
<tr>
<td>sint64</td>
<td>long</td>
<td>int/long</td>
</tr>
<tr>
<td>fixed32</td>
<td>int</td>
<td>int/long</td>
</tr>
<tr>
<td>fixed64</td>
<td>long</td>
<td>int/long</td>
</tr>
<tr>
<td>sfixed32</td>
<td>int</td>
<td>int</td>
</tr>
<tr>
<td>sfixed64</td>
<td>long</td>
<td>int/long</td>
</tr>
<tr>
<td>bool</td>
<td>boolean</td>
<td>bool</td>
</tr>
<tr>
<td>string</td>
<td>String</td>
<td>str/unicode</td>
</tr>
<tr>
<td>bytes</td>
<td>ByteString</td>
<td>str</td>
</tr>
</tbody>
</table>
<p>不同类型的具体细节可以参考 <a href=https://developers.google.com/protocol-buffers/docs/proto3#scalar>原表格</a>。</p>
<h4 id=枚举类型>枚举类型</h4>
<p>如果我们希望消息字段的值位于某个特定的集合中，则可以将该字段定义成枚举类型（enumeration）。例如：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>SearchRequest</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> query <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>int32</span> page_number <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>int32</span> result_per_page <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>enum</span> Corpus {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    UNIVERSAL <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    WEB <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    IMAGES <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    LOCAL <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    NEWS <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    PRODUCTS <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    VIDEO <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  Corpus corpus <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>在定义枚举类型时，我们必须让数字 0 与枚举类型的第一个元素相关联。因为 0 是数值类型的默认值，0 与第一个元素相关联的目的是为了维持对 <code>proto2</code> 的兼容性。</p>
<h4 id=默认值>默认值</h4>
<p>不同的数据类型有着不同的默认值。当 Protocol Buffers 解析消息时，如果发现编码后的消息中并不存在某个字段，则会将对应字段的值设置为字段类型的默认值。不同类型的默认值如下：</p>
<table>
<thead>
<tr>
<th>字段类型</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>string</td>
<td>empty string</td>
</tr>
<tr>
<td>bytes</td>
<td>empty bytes</td>
</tr>
<tr>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>numeric types</td>
<td>zero</td>
</tr>
<tr>
<td>enum</td>
<td>first defined enum value, which must be 0</td>
</tr>
<tr>
<td>message</td>
<td>not set</td>
</tr>
<tr>
<td>repeated field</td>
<td>empty</td>
</tr>
</tbody>
</table>
<h3 id=在-java-中使用-protocol-buffers>在 Java 中使用 Protocol Buffers</h3>
<p>Protocol Buffers 的编译器 <code>protoc</code> 能够根据目标语言为我们生成 <code>.proto</code> 文件对应的代码。对于 Java 来说，<code>protoc</code> 会为每一种消息类型都生成一个 <code>.java</code> 文件，每个 <code>.java</code> 文件中都有一个对应的 <code>Builder</code> 负责创建消息类的实例。</p>
<p>直接来看官网的一个例子：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto>syntax <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;proto3&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#f92672>package</span> tutorial;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> java_multiple_files <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> java_package <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.example.tutorial.protos&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>option</span> java_outer_classname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AddressBookProtos&#34;</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Person</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> name <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>int32</span> id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> email <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>enum</span> PhoneType {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    MOBILE <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    HOME <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    WORK <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>message</span> <span style=color:#a6e22e>PhoneNumber</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> <span style=color:#66d9ef>string</span> number <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#66d9ef>optional</span> PhoneType type <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  }<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>repeated</span> PhoneNumber phones <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>AddressBook</span> {<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>repeated</span> Person people <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span>}<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>这段代码首先告诉编译器使用 <code>proto3</code>，然后声明了当前 <code>.proto</code> 文件所属的包（package），用于解决不同项目之间可能出现的命名冲突，它的作用和 Java 中的包很相似。不过你会发现，后面还有一个 <code>java_package</code>，它给出了 Java 的包名，用于存放生成的 Java 类文件。如果没有这一行，编译器会使用 <code>package</code> 的值作为 Java 的包名。</p>
<p><code>java_outer_classname</code> 则定义了表示整个 <code>.proto</code> 文件的 Java 类名，而 <code>java_multiple_files</code> 则告诉编译器要将每个生成的 Java 类都放到一个单独的 <code>.java</code> 文件中。</p>
<h4 id=builder>Builder</h4>
<p>编译器 <code>protoc</code> 生成的所有 Java 消息类都是 <strong>不可变</strong> 的。这意味着，消息对象在被构造出来之后，就不能被修改，就像 Java 中的 <code>String</code> 一样。要构建一个消息对象，我们必须先构造出对应的 <code>Builder</code> 对象，使用 <code>Builder</code> 为字段赋值，最后调用 <code>Builder</code> 的 <code>build()</code> 方法完成对象的创建。</p>
<h2 id=参考资料>参考资料</h2>
<ol>
<li><a href=https://grpc.io/docs/>gPRC Documentation</a>.</li>
<li><a href=https://developers.google.com/protocol-buffers/docs/overview>Protocol Buffers Guide</a>.</li>
</ol>
</div>
<footer class=entry-footer>
<div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg>
<span class=screen-reader-text>分类: </span><a class=category href=/categories/rpc/>RPC</a>, <a class=category href=/categories/communication/>Communication</a></div>
<div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=screen-reader-text>标签: </span><a class=tag href=/tags/rpc/>RPC</a>, <a class=tag href=/tags/communication/>Communication</a></div>
</div>
</footer>
</article>
<nav class=entry-nav>
<div class=container><div class="prev-entry sep-before">
<a href=/posts/redis/key_expiration_and_eviction_in_redis/>
<span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>
Previous</span>
<span class=screen-reader-text>上一篇: </span>Redis 中的 key 过期与淘汰机制</a>
</div></div>
</nav>
</main>
<footer id=footer class=footer>
<div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label=社交菜单>
<ul><li>
<a href=https://github.com/zhannicholas target=_blank rel="noopener me">
<span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a>
</li><li>
<a href=https://t.me/zhannicholas target=_blank rel="noopener me">
<span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7.85 12c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg>
</a>
</li><li>
<a href=mailto:zhan_nicholas@outlook.com target=_blank rel="noopener me">
<span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</a>
</li><li>
<a href=https://linkedin.com/in/%e4%bc%9f%e4%bc%9f-%e8%a9%b9-27871a104 target=_blank rel="noopener me">
<span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
</a>
</li></ul>
</nav>
</section><div class=copyright>
<p> &copy; 2018-2021 Nicholas Zhan </p>
</div>
</div>
</footer>
</div>
</div><script>window.__assets_js_src="/assets/js/"</script>
<script src=/assets/js/main.c3bcf2df.js></script><script src=/js/custom.js></script><script type=text/x-mathjax-config>
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"processEscapes":true}})
</script>
<script type=text/javascript async src="//unpkg.com/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>
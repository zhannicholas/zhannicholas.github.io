<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>理解 Geohash | NZ's Digital Garden</title><meta name=description content><meta property="og:title" content="理解 Geohash | NZ's Digital Garden"><meta name=twitter:title content="理解 Geohash | NZ's Digital Garden"><meta itemprop=name content="理解 Geohash | NZ's Digital Garden"><meta name=application-name content="理解 Geohash | NZ's Digital Garden"><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content="NZ's Digital Garden"><meta property="og:description" content><meta property="og:site_name" content="NZ's Digital Garden"><meta property="og:url" content="https://zhannicholas.github.io/posts/geography/understanding_geohash/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.8458c1237ecc4766957580cbadcdbc3827551cb1e8f51d9fa5c37d7473a022e9.css" integrity="sha256-hFjBI37MR2aVdYDLrc28OCdVHLHo9R2fpcN9dHOgIuk="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">NZ's Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-primary-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-primary-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">理解 Geohash</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%bb%8f%e5%ba%a6%e4%b8%8e%e7%ba%ac%e5%ba%a6>经度与纬度</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%ae%97%e6%b3%95%e5%8e%9f%e7%90%86>算法原理</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%ae%a1%e7%ae%97%e5%87%ba%e7%bb%8f%e5%ba%a6%e5%92%8c%e7%ba%ac%e5%ba%a6%e5%90%84%e8%87%aa%e5%af%b9%e5%ba%94%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e7%bc%96%e7%a0%81>计算出经度和纬度各自对应的二进制编码</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%ba%a4%e5%8f%89%e5%90%88%e5%b9%b6%e7%bb%8f%e5%ba%a6%e5%92%8c%e7%ba%ac%e5%ba%a6%e7%9a%84%e4%ba%8c%e8%bf%9b%e5%88%b6%e7%bc%96%e7%a0%81>交叉合并经度和纬度的二进制编码</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b0%86%e4%ba%8c%e8%bf%9b%e5%88%b6%e7%bc%96%e7%a0%81%e5%88%86%e7%bb%84%e5%b9%b6%e8%ae%a1%e7%ae%97%e5%87%ba%e5%af%b9%e5%ba%94%e7%9a%84-base32-%e7%bc%96%e7%a0%81>将二进制编码分组并计算出对应的 Base32 编码</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#geohash-%e8%a7%a3%e7%a0%81>Geohash 解码</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#geohash-%e7%9a%84%e9%95%bf%e5%ba%a6%e4%b8%8e%e4%bd%8d%e7%bd%ae%e7%b2%be%e5%ba%a6>Geohash 的长度与位置精度</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#geohash-%e7%9a%84%e5%b1%80%e9%99%90%e6%80%a7>Geohash 的局限性</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%be%b9%e7%95%8c%e9%97%ae%e9%a2%98>边界问题</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%9d%9e%e7%ba%bf%e6%80%a7%e9%97%ae%e9%a2%98>非线性问题</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p><a href=https://en.wikipedia.org/wiki/Geohash target=_blank>Geohash</a>
是 Gustavo Niemeyer 在 2008 年发明的一个地理编码系统（geocode system），它将经度和纬度这个二维的地理坐标编码成一个由数字和字母组成的字符串。虽然 geohash 是从经纬度计算出来的，但是 geohash 并不能像经纬度那样能够表示出某个点在地图上的确切位置。实际上，Geohash 表示的是一个<strong>区域</strong>，这个区域内所有的点都有着相同的 geohash 值。这意味着，geohash 可以帮助用户隐藏确切的位置信息，从而更好地保护用户的隐私。虽然我们可以通过 geohash 得知用户所在的区域，但是我们却无法知道用户到底在这个区域中的哪个点。</p><p>很多基于位置的个性化服务都是基于 geohash 实现的。比如查找附近的人，寻找附近的餐厅等等。以查找附近的人为例，如果两个人所处位置的 geohash 相同，那么我们可以认为这两个人在空间上是相近的。至于具体有多近，这取决于 geohash 所表示的位置精度。通过改变 geohash 的长度，我们可以表示任意精度的位置：geohash 越短，其表示的区域越大，位置精度越低；相反，geohash 越长，其表示的区域越小，位置精度越高。</p><p>以天府广场（latitude: 30.6599157, longitude: 104.0638546）为例，下图展示了通过不断增加 geohash 长度提高展示位置精度的过程：
<img src=https://zhannicholas.github.io/images/geography/geohash_precise.png alt></p><ul><li>当 geohash 长度为 1 时，选择 <code>w</code></li><li>当 geohash 长度为 2 时，选择 <code>wm</code></li><li>当 geohash 长度为 3 时，选择 <code>wm6</code></li><li>当 geohash 长度为 4 时，选择 <code>wm6n</code></li><li>当 geohash 长度为 5 时，选择 <code>wm6nj</code></li><li>当 geohash 长度为 6 时，选择 <code>wm6nj2</code></li></ul><blockquote><p>需要注意的是，同一个地点在不同地图下的经纬度可能是不一样的。本文采用的是 <a href=https://www.openstreetmap.org/ target=_blank>OpenStreeMap</a>
。</p></blockquote><h2 id=经度与纬度>经度与纬度</h2><p>经纬度是由地球表面经线和纬线相交组成的一个坐标系统。每根经线和纬线都有不同的度数，叫经度和纬度。</p><p><img src=https://zhannicholas.github.io/images/geography/1024px-Latitude_and_Longitude_of_the_Earth.svg.png alt=https://commons.wikimedia.org/wiki/File:Latitude_and_Longitude_of_the_Earth.svg></p><p>地球是一个球体，经线连接南北两极，是半圆弧状。经过英国首都伦敦格林尼治天文台原址的那一条经线被定为 0° 经线，又叫本初子午线。本初子午线往东为东半球，往西为西半球。东西两个半球的经度范围均在 0° 至 180° 之间，合计360度。一般将西半球的经度范围记为 <code>[-180°, 0°)</code>，而将东半球的为 <code>(0°, 180°]</code>。</p><p>纬线与经线垂直的圆圈，任意两根纬线互相平行。赤道（实际上是地球表面的点随着地球自转产生的轨迹中最长的圆周线）是最大的纬线圈，纬度为 0°。赤道将地球分为南北两个半球，南北两个半球的纬度范围都是 90°，合计 180°。从赤道出发，向两极靠近，纬度越来越大，纬线圈越来越小。一般将南半球的纬度范围记为 <code>[-90°, 0°)</code>，而将北半球的纬度记为 <code>(0°, 90°]</code>。
南极点的纬度记为 90°S（或 -90°），北极点的纬度记为 90°N（或 +90°）。</p><h2 id=算法原理>算法原理</h2><p>Geohash 是一种将二维的经纬度编码成一个字符串的地理编码方法，核心思想是区间二分：将地球编码看成一个二维平面，然后将这个平面递归均分为更小的子块。</p><p>当我们对一个地理坐标进行 geohash 编码时，先分别计算出经度和纬度各自的二进制编码，然后按照“从第 0 位开始，偶数位放经度，奇数位放纬度”的规则将经度和纬度的编码交叉组合，得到一个完整的二进制编码。接着，将二进制编码按照五个一组进行划分，算出每一组二进制编码的十进制值并将其作为索引查找 base32 编码表中对应的值。最后将这些值拼接在一起就得到了 geohash 值。</p><p>不难看出，geohash 越长，对地图的划分次数就越多。划分的次数多了，矩形区域就小了，位置精度也就上去了。那么是不是 geohash 越长越好呢？当然不是，我们应该根据实际的应用场景来选择合适的长度。如果使用内存存储 geohash，geohash 越长，其所占的空间就越大。为了保护用户的位置隐私，也需要将位置精度控制在合理的范围内。</p><p>接下来还是以成都市天府广场的位置为例，来看看 geohash 具体是如何计算的。</p><h3 id=计算出经度和纬度各自对应的二进制编码>计算出经度和纬度各自对应的二进制编码</h3><p>计算经度或纬度的二进制编码的方法如下：</p><ol><li>确定初始区间，经度为 <code>[-180°, +180°]</code>，纬度为 <code>[-90°, +90°]</code>。</li><li>将初始区间对半拆分得到左半区间和右半区间，根据目标位置的经度或纬度是落在左区间还是右区间，决定当前位的二进制编码。左区间取 0，右区间取 1。</li><li>对上一步中目标位置所在的子区间进行对半划分，按照同样的方式计算出下一位的二进制编码。</li><li>重复划分上面的步骤，直到达到期望的编码长度。</li></ol><p>首先对纬度进行二进制编码：</p><ol><li>将 <code>[-90°, 90°]</code> 对半拆分得到 <code>[-90°, 0°]</code> 和 <code>[0°, 90°]</code>，30.6599157 位于右区间，取 1 。</li><li>将 <code>[0°, 90°]</code> 对半拆分得到 <code>[0°, 45°]</code> 和 <code>[45°, 90°]</code>，30.6599157 位于左区间，取 0 。</li><li>……</li></ol><p>按照这个流程，计算天府广场纬度 30.6599157 的 15 位二进制编码的过程：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>迭代    左端点          区间中点         右端点           0/1
</span></span><span style=display:flex><span>1       -90.000000      0.000000        90.000000        1
</span></span><span style=display:flex><span>2       0.000000        45.000000       90.000000        0
</span></span><span style=display:flex><span>3       0.000000        22.500000       45.000000        1
</span></span><span style=display:flex><span>4       22.500000       33.750000       45.000000        0
</span></span><span style=display:flex><span>5       22.500000       28.125000       33.750000        1
</span></span><span style=display:flex><span>6       28.125000       30.937500       33.750000        0
</span></span><span style=display:flex><span>7       28.125000       29.531250       30.937500        1
</span></span><span style=display:flex><span>8       29.531250       30.234375       30.937500        1
</span></span><span style=display:flex><span>9       30.234375       30.585938       30.937500        1
</span></span><span style=display:flex><span>10      30.585938       30.761719       30.937500        0
</span></span><span style=display:flex><span>11      30.585938       30.673828       30.761719        0
</span></span><span style=display:flex><span>12      30.585938       30.629883       30.673828        1
</span></span><span style=display:flex><span>13      30.629883       30.651855       30.673828        1
</span></span><span style=display:flex><span>14      30.651855       30.662842       30.673828        0
</span></span><span style=display:flex><span>15      30.651855       30.657349       30.662842        1
</span></span></code></pre></div><p>通过以上计算，纬度 30.6599157 的二进制编码为：<code>10101 01110 01101</code>。</p><p>同理，我们也可以计算出经度 104.0638546 的 15 位二进制编码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>迭代    左端点           区间中点        右端点           0/1
</span></span><span style=display:flex><span>1       -180.000000     0.000000        180.000000       1
</span></span><span style=display:flex><span>2       0.000000        90.000000       180.000000       1
</span></span><span style=display:flex><span>3       90.000000       135.000000      180.000000       0
</span></span><span style=display:flex><span>4       90.000000       112.500000      135.000000       0
</span></span><span style=display:flex><span>5       90.000000       101.250000      112.500000       1
</span></span><span style=display:flex><span>6       101.250000      106.875000      112.500000       0
</span></span><span style=display:flex><span>7       101.250000      104.062500      106.875000       1
</span></span><span style=display:flex><span>8       104.062500      105.468750      106.875000       0
</span></span><span style=display:flex><span>9       104.062500      104.765625      105.468750       0
</span></span><span style=display:flex><span>10      104.062500      104.414062      104.765625       0
</span></span><span style=display:flex><span>11      104.062500      104.238281      104.414062       0
</span></span><span style=display:flex><span>12      104.062500      104.150391      104.238281       0
</span></span><span style=display:flex><span>13      104.062500      104.106445      104.150391       0
</span></span><span style=display:flex><span>14      104.062500      104.084473      104.106445       0
</span></span><span style=display:flex><span>15      104.062500      104.073486      104.084473       0
</span></span></code></pre></div><p>经度 104.0638546 的二进制编码为 <code>11001 01000 00000</code>。</p><h3 id=交叉合并经度和纬度的二进制编码>交叉合并经度和纬度的二进制编码</h3><p>从第 0 位开始，<strong>偶数位放经度，奇数位放纬度</strong>，得到完整的二进制编码：</p><p><img src=https://zhannicholas.github.io/images/geography/encode_longitude_and_latitude_to_binary.png alt></p><h3 id=将二进制编码分组并计算出对应的-base32-编码>将二进制编码分组并计算出对应的 Base32 编码</h3><p>上面的二进制编码看起来很长，不方便记忆。为了压缩编码长度，geohash 采用了自己的 Base32 编码，将二进制编码转换成方便识别的文本。Geohash 所用的编码表由数字和字母组成，不过去掉了 a，i，l 和 o 四个字母：</p><p><img src=https://zhannicholas.github.io/images/geography/geohash_base32.png alt></p><p>有了编码表后，我们将之前组合得到的二进制编码，五个一组，计算出每一组的十进制值，然后查表得到最终的编码 <code>wm6n2j</code>：</p><p><img src=https://zhannicholas.github.io/images/geography/binary_to_geohash.png alt></p><h2 id=geohash-解码>Geohash 解码</h2><p>Geohash 的解码实际上编码的逆过程，先通过 Base32 编码表找出每个字符的十进制值，然后将十进制转为二进制，最后通过二进制计算出对应的区域范围。</p><p>前面我们计算出天府广场的 geohash 是 <code>wm6n2j</code>，现在将其还原为经纬度：</p><p><img src=https://zhannicholas.github.io/images/geography/geohash_decode.png alt></p><p>最后一步将二进制还原为十进制，从左往右遍历二进制编码，将当前区间对半划分，若为 0，取左区间为下一步划分用的区间，为 1 则将右区间作为下一步划分用的区间。经度的初始区间为 <code>[-180°, +180°]</code>，纬度的初始区间为 <code>[-90°, +90°]</code>。</p><p>将二进制编码的纬度 <code>10101 01110 01101</code> 还原，得到它表示的纬度范围是 <code>(30.657349, 30.662842)</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>0/1    最小值           最大值
</span></span><span style=display:flex><span>1      0.000000        90.000000
</span></span><span style=display:flex><span>0      0.000000        45.000000
</span></span><span style=display:flex><span>1      22.500000       45.000000
</span></span><span style=display:flex><span>0      22.500000       33.750000
</span></span><span style=display:flex><span>1      28.125000       33.750000
</span></span><span style=display:flex><span>0      28.125000       30.937500
</span></span><span style=display:flex><span>1      29.531250       30.937500
</span></span><span style=display:flex><span>1      30.234375       30.937500
</span></span><span style=display:flex><span>1      30.585938       30.937500
</span></span><span style=display:flex><span>0      30.585938       30.761719
</span></span><span style=display:flex><span>0      30.585938       30.673828
</span></span><span style=display:flex><span>1      30.629883       30.673828
</span></span><span style=display:flex><span>1      30.651855       30.673828
</span></span><span style=display:flex><span>0      30.651855       30.662842
</span></span><span style=display:flex><span>1      30.657349       30.662842
</span></span></code></pre></div><p>将二进制编码的经度 <code>11001 01000 00000</code> 还原，得到它表示的经度范围是 <code>(104.062500, 104.073486)</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>0/1    最小值           最大值
</span></span><span style=display:flex><span>1      0.000000        180.000000
</span></span><span style=display:flex><span>1      90.000000       180.000000
</span></span><span style=display:flex><span>0      90.000000       135.000000
</span></span><span style=display:flex><span>0      90.000000       112.500000
</span></span><span style=display:flex><span>1      101.250000      112.500000
</span></span><span style=display:flex><span>0      101.250000      106.875000
</span></span><span style=display:flex><span>1      104.062500      106.875000
</span></span><span style=display:flex><span>0      104.062500      105.468750
</span></span><span style=display:flex><span>0      104.062500      104.765625
</span></span><span style=display:flex><span>0      104.062500      104.414062
</span></span><span style=display:flex><span>0      104.062500      104.238281
</span></span><span style=display:flex><span>0      104.062500      104.150391
</span></span><span style=display:flex><span>0      104.062500      104.106445
</span></span><span style=display:flex><span>0      104.062500      104.084473
</span></span><span style=display:flex><span>0      104.062500      104.073486
</span></span></code></pre></div><p>最终，我们得出 <code>wm6n2j</code> 表示的是经度在 <code>(104.062500, 104.073486)</code> 之间，纬度在 <code>(30.657349, 30.662842)</code> 之间的一个矩形区域。</p><p>对比天府广场（latitude: 30.6599157, longitude: 104.0638546），它恰好在计算出来的范围之内。这个例子很好地说明了 geohash 是如何表示一个区域范围的。</p><h2 id=geohash-的长度与位置精度>Geohash 的长度与位置精度</h2><p>Geohash 的长度对位置的精度有着非常直接的影响。从下面这个表格可以看出，当编码长度为 1 时，精度高达 2500km，而当编码长度为 8 时，精度降到了 19m。</p><table><thead><tr><th>Geohash 长度</th><th>纬度位数</th><th>经度位数</th><th>纬度误差</th><th>精度误差</th><th>距离误差</th></tr></thead><tbody><tr><td>1</td><td>2</td><td>3</td><td>±23</td><td>±23</td><td>±2,500 km</td></tr><tr><td>2</td><td>5</td><td>5</td><td> ±2.8</td><td> ±5.6</td><td>±630 km</td></tr><tr><td>3</td><td>7</td><td>8</td><td> ±0.70</td><td> ±0.70</td><td>±78 km</td></tr><tr><td>4</td><td>10</td><td>10</td><td> ±0.087</td><td> ±0.18</td><td>±20 km</td></tr><tr><td>5</td><td>12</td><td>13</td><td> ±0.022</td><td> ±0.022</td><td>±2.4 km</td></tr><tr><td>6</td><td>15</td><td>15</td><td> ±0.0027</td><td> ±0.0055</td><td>±0.61 km</td></tr><tr><td>7</td><td>17</td><td>18</td><td> ±0.00068</td><td> ±0.00068</td><td>±0.076 km</td></tr><tr><td>8</td><td>20</td><td>20</td><td> ±0.000085</td><td> ±0.00017</td><td>±0.019 km</td></tr></tbody></table><h2 id=geohash-的局限性>Geohash 的局限性</h2><p>Geohash 非常好用，但它还是存在两个问题：边界问题和非线性问题。</p><h3 id=边界问题>边界问题</h3><p>Geohash 将邻近搜索（proximity search）转换为了字符串前缀匹配，和基于经纬度的算法相比，极大地提高了计算效率。由于 geohash 是将地图划分为矩形网格，并单独对每个矩形进行编码，这就会带来以下问题。比如下图中有 A、B、C 三个点，要查找离 B 最近的点。可以发现，距离较远的 A 和 B 有着相同的 geohash 编码，而较近的 C 的 geohash 编码却有所不同。</p><p><img src=https://zhannicholas.github.io/images/geography/people_nearby.png alt></p><p>这种问题一般出现在边界上。解决思路很简单，除了使用目标点的 geohash 进行匹配外，还需要检查相邻 8 个格子的 geohash 编码，这样才能选出最符合要求的答案。</p><h3 id=非线性问题>非线性问题</h3><p>Geohash 是基于经纬度的，它能反映出两个点在经纬度上面的距离，但是却不能反映出实际距离。在不同的纬度下，单位经度所表示的距离是不一样的。在赤道，单位经度对应的距离为 111.320km，而在 30°N 和 30°S，单位经度对应的距离为 110.852km。</p><p>这种非线性问题并不是 geohash 和经纬度系统的问题，而是在于将球体表面的坐标映射到二维平面的坐标的不均匀性。在不同的纬度下，指定长度的 geohash 所表示的矩形区域大小也是不一样的。矩形用南北方向的高度（height）和东西方向的宽度（width）来衡量。例如在赤道：</p><table><thead><tr><th>Geohash 长度</th><th>宽（Width）</th><th>高（Height）</th></tr></thead><tbody><tr><td>1</td><td>4604.5 km</td><td>5003.8 km</td></tr><tr><td>2</td><td>1249.4 km</td><td>625.5 km</td></tr><tr><td>3</td><td>156.4 km</td><td>156.4 km</td></tr><tr><td>4</td><td>39.1 km</td><td>19.5 km</td></tr><tr><td>5</td><td>4.9 km</td><td>4.9 km</td></tr><tr><td>6</td><td>1.2 km</td><td>610.8 m</td></tr><tr><td>7</td><td>152.7 m</td><td>152.7 m</td></tr><tr><td>8</td><td>38.2 m</td><td>19.1 m</td></tr><tr><td>9</td><td>4.8 m</td><td>4.8 m</td></tr><tr><td>10</td><td>1.2 m</td><td>596.5 mm</td></tr><tr><td>11</td><td>149.1 mm</td><td>149.1 mm</td></tr><tr><td>12</td><td>37.3 mm</td><td>18.6 mm</td></tr></tbody></table><p>Blake Haugen 在他的博客 <a href=https://bhaugen.com/blog/geohash-sizes/ target=_blank>Geohash Size Variation by Latitude</a>
中展示了不同纬度下不同长度的 geohash 所表示的矩形区域的大小。当 geohash 长度相同时，矩形的高度在不同纬度下是相同的，而矩形的宽度在不同纬度下并不相同。这一点从经纬度的划分上很好理解，假设地球是一个完美的球体，经线圈的周长是相同的，而纬线圈的周长在赤道最大，越靠近两极越小并不断趋近于零。</p><h2 id=参考资料>参考资料</h2><ol><li><a href=https://en.wikipedia.org/wiki/Geohash target=_blank>Wikipedia: Geohash</a></li><li><a href=https://chrishewett.com/blog/geohash-explorer/ target=_blank>Chris Hewett&amp;rsquo;s GeoHash Explorer</a></li><li><a href=https://bhaugen.com/blog/geohash-sizes/ target=_blank>Geohash Size Variation by Latitude</a></li><li><a href=https://zhuanlan.zhihu.com/p/39817945 target=_blank>基于快速GeoHash，如何实现海量商品与商圈的高效匹配</a></li><li><a href=https://eugene-eeo.github.io/blog/geohashing.html target=_blank>Notes on Geohashing</a></li><li><a href=https://www.iunera.com/kraken/fabric/geohashing/ target=_blank>The A-Z of Geohashing: What You Need to Know</a></li><li><a href=https://ryan-miao.gitee.io/geohash_tool/ target=_blank>百度地图 geohash 可视化工具</a></li></ol></div><hr><aside><h4>No linked references</h4></aside><br><aside class=related><h3 class="text-2xl font-black tracking-tight text-primary-500 capitalize dark:text-primary-300 sm:text-2xl">Related Content</h3><ul><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/geohash>Geohash</a></p></ul></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/pages class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p><p class="mt-2 text-base text-center text-gray-400">Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/sawhney17/logseq-schrodinger>logseq-schrodinger</a>.</p></div></footer></body></html>
<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>Mybatis |</title><meta name=description content><meta property="og:title" content="Mybatis | "><meta name=twitter:title content="Mybatis | "><meta itemprop=name content="Mybatis | "><meta name=application-name content="Mybatis | "><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:site_name" content><meta property="og:url" content="https://zhannicholas.github.io/posts/mybatis/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.70a967cc78af9ec5b1e1b5c3552172a911554a27d8e5bdf52000296bdd439d2a.css" integrity="sha256-cKlnzHivnsWx4bXDVSFyqRFVSifY5b31IAApa91DnSo="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt=" Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60"></div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Mybatis</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#mybatis-%e4%b8%89%e5%b1%82%e6%9e%b6%e6%9e%84>MyBatis 三层架构</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%9f%ba%e7%a1%80%e6%94%af%e6%92%91%e5%b1%82>基础支撑层</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%b1%bb%e5%9e%8b%e8%bd%ac%e6%8d%a2%e6%a8%a1%e5%9d%97>类型转换模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%97%a5%e5%bf%97%e6%a8%a1%e5%9d%97>日志模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#binding-%e6%a8%a1%e5%9d%97>Binding 模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%b5%84%e6%ba%90%e5%8a%a0%e8%bd%bd%e6%a8%a1%e5%9d%97>资源加载模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%95%b0%e6%8d%ae%e6%ba%90%e6%a8%a1%e5%9d%97>数据源模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%bc%93%e5%ad%98%e7%ae%a1%e7%90%86%e6%a8%a1%e5%9d%97>缓存管理模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%a7%a3%e6%9e%90%e5%99%a8%e6%a8%a1%e5%9d%97>解析器模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%ba%8b%e5%8a%a1%e7%ae%a1%e7%90%86%e6%a8%a1%e5%9d%97>事务管理模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%8d%e5%b0%84%e5%b7%a5%e5%85%b7%e6%a8%a1%e5%9d%97>反射工具模块</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%a0%b8%e5%bf%83%e5%a4%84%e7%90%86%e5%b1%82>核心处理层</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%85%8d%e7%bd%ae%e8%a7%a3%e6%9e%90>配置解析</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#sql-%e8%a7%a3%e6%9e%90%e4%b8%8e-scripting-%e6%a8%a1%e5%9d%97>SQL 解析与 scripting 模块</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#sql-%e6%89%a7%e8%a1%8c>SQL 执行</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%8f%92%e4%bb%b6>插件</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%8e%a5%e5%8f%a3%e5%b1%82>接口层</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#sqlsession>SqlSession</a></li></ul></li></ul></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>本文的绝大部分内容来自某网课，做笔记备忘，便于以后碰到相关问题更快地定位和排查问题。</p><h2 id=mybatis-三层架构>MyBatis 三层架构</h2><p>MyBatis 的整体架构分为三层，分别是：<strong>基础支撑层</strong>、<strong>逻辑处理层</strong> 和 <strong>接口层</strong>。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/MyBatis%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84%E5%9B%BE.png alt></p><h3 id=基础支撑层>基础支撑层</h3><p>基础支撑层为整个 MyBatis 框架提供最基础的功能，分为九个基础模块，每个模块都具有各自不同的能力。</p><h4 id=类型转换模块>类型转换模块</h4><blockquote><p>在使用 JDBC 操作数据库时，我们面临着三个不同层次的数据类型差异——数据库自己的数据类型、JDBC 定义的数据类型和 Java 数据类型。JDBC 在中间，作为规范标准，它可以屏蔽底层数据的差异，但 JDBC 类型与 Java 类型并不是一一对应的，所以需要进行适当的类型转换。</p></blockquote><p><a href=https://download.oracle.com/otn-pub/jcp/jdbc-4_2-mrel2-eval-spec/jdbc4.2-fr-spec.pdf target=_blank>JDBC Spec 4.2</a>
中定义了 JDBC 类型到 Java 类型的映射关系、Java 类型到 JDBC 类型的映射关系等等。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/MyBatis%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E6%A8%A1%E5%9D%97.png alt></p><p>类型转换模块实现了 MyBatis 中定义的 JDBC 类型与 Java 类型之间的相互转换：</p><ul><li>当 MyBatis 在将 SQL 模板与用户传入的参数相绑定（在我们使用 <code>PreparedStatement</code> 执行 SQL 之前，需要手动调用 <code>setInt()</code>、<code>setString()</code> 等方法绑定参数）时，类型转换模块会将 Java 类型数据转换为 JDBC 类型数据。</li><li>当取得查询结果后，类型转换模块会将 <code>ResultSet</code> 中的 JDBC 类型数据转换为 Java 类型数据。</li></ul><p>此外，类型转换模块还实现了别名的功能。我们可以在 <code>mybatis-config.xml</code> 配置文件中使用 <code>&lt;typeAlias></code> 标签为 Java 类的完整名称定义相应的别名。然后在后续编写 SQL 语句、定义 <code>&lt;resultMap></code> 的时候，就可以直接使用这些别名替代相应的 Java 类名，这样就非常易于代码的编写和维护。<code>TypeAliasRegistry</code> 是维护别名配置的核心实现，它提供了别名注册、别名查询等基本功能。</p><h5 id=typehandler>TypeHandler</h5><p>MyBatis 中的类型转换模块包含众多类型转换器，这些类型转换器都有一个父接口——<code>TypeHandler</code>。整个转换器的层次结构如下（为了简单，图中省略了不少类型转换器）：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/TypeHandler.png alt></p><p>其中，<code>BaseTypeHandler</code> 不仅实现了一些 <code>TypeHandler</code> 的公共逻辑，还实现了抽象类 <code>TypeReference</code>。</p><p>除了这些默认的 <code>TypeHandler</code> 之外，我们还可以在 <code>mybatis-config.xml</code> 中使用标签配置自定义的 <code>TypeHandler</code> 实现，也可以在定义 <code>Mapper.xml</code> 的时候指定 <code>typeHandler</code> 属性。不管是哪种方式，MyBatis 都会在初始化的过程中，获取所有已知的 <code>TypeHandler</code>，创建对应的实例并注册到 <code>TypeHandlerRegistry</code> 中，由 <code>TypeHandlerRegistry</code> 统一管理所有的 <code>TypeHandler</code> 实例。</p><h4 id=日志模块>日志模块</h4><p>MyBatis 提供的日志模块可以很方便地集成各种第三方 Java 日志框架，比如 Log4j、Log4j2、slf4j、java.util.logging 等。由于这些日志框架来源于不同的开源组织，给用户暴露的接口也不尽相同。所以 MyBatis 使用了 <strong>适配器模式</strong>（<a href=../../reading_notes/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0%e4%b9%8b%e4%b8%83%e9%80%82%e9%85%8d%e5%99%a8%e6%a8%a1%e5%bc%8f>设计模式读书笔记之适配器模式</a>
）对第三方日志框架接口进行了统一。</p><p>MyBatis 自己定义了一个 <code>Log</code> 接口，然后使用适配器模式针对不同的日志框架进行了适配，将第三方日志框架的日志接口转化为了它自己的 <code>Log</code> 接口，这样就成功集成了第三方日志框架的日志打印功能。</p><p><code>Log</code> 接口及相关适配器实现均位于 <code>org.apache.ibatis.logging</code> 包中。整体结构如下：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/Logging.png alt></p><p>其中，<code>LoggFactory</code> 负责创建 <code>Log</code> 对象，这个工厂类中有一段静态代码块，会依次加载各个第三方日志框架的适配器。</p><h4 id=binding-模块>Binding 模块</h4><p>在使用 MyBatis 时，我们无须编写 <code>Mapper</code> 接口的具体实现，Binding 模块会自动生成 <code>Mapper</code> 接口的动态代理对象，通过代理对象可以执行关联 <code>Mapper.xml</code> 文件（或 <code>Mapper</code> 接口中的注解）中的数据库操作。Binding 模块的核心类如下：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/binding-module.png alt></p><p><code>MapperRegistry</code>（在 MyBatis 初始化过程中构造） 主要负责统一维护 <code>Mapper</code> 接口以及这些 <code>Mapper</code> 对应的代理对象工厂 <code>MapperProxyFactory</code>。<code>MapperProxyFactory</code> 通过 JDK 动态代理的方式创建 <code>Mapper</code> 接口的代理对象 <code>MapperProxy</code>，<code>MapperProxy</code> 封装核心代理逻辑，将拦截到的目标方法委托给 <code>MapperMethod</code> 处理。</p><h5 id=mapperproxy>MapperProxy</h5><p><code>MapperProxy</code> 是生成 <code>Mapper</code> 接口代理对象的关键，它实现了 <code>InvocationHandler</code> 接口。<code>Mapper</code> 代理对象的执行入口正是 <code>MapperProxy</code> 的 <code>invoke()</code> 方法。该方法内部会针对所有的非 <code>Object</code> 方法调用 <code>cachedInvoker()</code> 方法获取对应的 <code>MapperMethodInvoker</code> 对象，并调用其 <code>invoke()</code> 方法执行代理逻辑以及目标方法。</p><p>在 <code>cachedInvoker()</code> 方法中，首先会查询 <code>methodCache</code> 缓存（类型为 <code>Map&lt;Method, MapperMethodInvoker></code>），如果查询的方法为 <code>default</code> 方法，则会根据当前使用的 JDK 版本，获取对应的 <code>MethodHandle</code>（相关文档：<a href=https://docs.oracle.com/javase/8/docs/api/java/lang/invoke/MethodHandle.html target=_blank>MethodHandle</a>
） 并封装成 <code>DefaultMethodInvoker</code> 对象写入缓存备用；如果查询的方法是非 <code>default</code> 方法，则创建 <code>PlainMethodInvoker</code> 对象写入缓存备用。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/MapperMethodInvoker.png alt></p><p><code>DefaultMethodInvoker</code> 与 <code>PlainMethodInvoker</code> 的内部实现稍有不同，前者通过 <code>MethodHandle</code> 完成调用，而后者通过 <code>MapperMethod</code> 完成调用。</p><h5 id=mappermethod>MapperMethod</h5><p><code>MapperMethod</code> 记录了 <code>Mapper</code> 接口中的对应方法，也是最终执行 SQL 语句的地方（<code>execute()</code>方法），<code>execute()</code> 方法会根据要执行的 SQL 语句的具体类型执行 <code>SqlSession</code> 的相应方法完成数据库操作。</p><p>在 <code>MapperMethod</code> 中，<code>command</code> 字段（<code>SqlCommand</code> 类型，它是 <code>MapperMethod</code> 的一个内部类）维护了关联 SQL 语句的相关信息。先简单看一下 <code>SqlCommand</code> 类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SqlCommand</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String name<span style=color:#f92672>;</span>          <span style=color:#75715e>// 关联 SQL 语句的唯一标识
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SqlCommandType type<span style=color:#f92672>;</span>  <span style=color:#75715e>// 关联 SQL 语句的操作类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>MyBatis 中的 SQL 语句有五种不同的操作类型：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> SqlCommandType <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  UNKNOWN<span style=color:#f92672>,</span> INSERT<span style=color:#f92672>,</span> UPDATE<span style=color:#f92672>,</span> DELETE<span style=color:#f92672>,</span> SELECT<span style=color:#f92672>,</span> FLUSH
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>MapperMethod</code> 中的 <code>method</code> 字段（<code>MethodSignature</code> 类型）则是维护了 <code>Mapper</code> 接口中方法的相关信息。它依赖 <code>ParamNameResolver</code> 这个解析方法参数列表的工具类。这里有必要单独说一下这个工具类。</p><p><code>ParamNameResolver</code> 中有一个 <code>name</code> 字段记录了各个参数参数在参数列表中的位置以及参数名称，其中 key 是参数在参数列表中的位置索引， value 为参数的名称。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SortedMap<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> names<span style=color:#f92672>;</span>
</span></span></code></pre></div><p>我们可以通过 <code>@Param</code> 注解指定一个参数名称，如果没有指定，则默认使用参数列表中的变量名称作为其名称，这与 <code>ParamNameResolver</code> 的 <code>useActualParamName</code> 有关，它是一个全局配置。如果将其配置为 <code>false</code>，则使用参数的下标索引作为其名称。此外，<code>names</code> 集合会跳过类型为 <code>RowBounds</code> 和 <code>ResultHandler</code> 类型的参数，如果使用下标作为索引作为参数名称的话，这时就会在 <code>names</code> 集合中出现 KV 不一致的情况。例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>aMethod(@Param(&#34;M&#34;) int a, @Param(&#34;N&#34;) int b) -&gt; {{0, &#34;M&#34;}, {1, &#34;N&#34;}}
</span></span><span style=display:flex><span>aMethod(int a, int b) -&gt; {{0, &#34;0&#34;}, {1, &#34;1&#34;}}
</span></span><span style=display:flex><span>aMethod(int a, RowBounds rb, int b) -&gt; {{0, &#34;0&#34;}, {2, &#34;1&#34;}}
</span></span></code></pre></div><h4 id=资源加载模块>资源加载模块</h4><p>资源加载模块主要是对类加载器进行封装，确定类加载器的使用顺序，并提供了加载类文件以及其他资源文件的功能。</p><h4 id=数据源模块>数据源模块</h4><p>数据源是持久层框架中最核心的组件之一，MyBatis 不仅提供了一套默认的数据源实现，还能够很方便地集成第三方数据源。在 Java 中，数据源这个抽象由 <code>javax.sql.DataSource</code> 接口表示，MyBatis 自带的数据源实现就实现了该接口。MyBatis 默认实现了两种类型的数据源——<code>UnpooledDataSource</code> 和 <code>PooledDataSource</code>。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/datasource-implementations.png alt></p><p>此外，对于这两种不同的数据源实现，MyBatis 还使用工厂方法模式（<a href=../../reading_notes/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0%e4%b9%8b%e4%b8%89%e5%b7%a5%e5%8e%82%e6%96%b9%e6%b3%95%e6%a8%a1%e5%bc%8f>设计模式读书笔记之工厂方法模式</a>
）提供了相应的工厂类：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/DataSourceFactory.png alt></p><p>使用工厂方法模式的好处在于，如果需要扩展新的数据源，只需要添加相应的 <code>DataSourceFactory</code> 接口实现类即可。这里的 <code>DataSource</code> 即工厂方法模式中的 <code>Product</code>。<code>DataSourceFactory</code> 定义了两个方法：<code>setProperties()</code> 用于配置数据源属性，<code>getDataSource()</code> 用于返回数据源对象。从上图可以看出，<code>PooledDataSourceFactory</code> 并没有直接实现 <code>DatasourceFactory</code> 接口，而是直接继承了 <code>UnpooledDataSourceFactory</code> 类。</p><h4 id=缓存管理模块>缓存管理模块</h4><p>缓存是优化数据库性能的常用手段之一，正确使用缓存可以将一部分数据库请求拦截在缓存层，减少数据库的压力，提升系统性能。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/cache-model.png alt=缓存原理></p><p>MyBatis 就提供了许多不同策略的缓存，这些缓存分为两个级别：一级缓存和二级缓存，它们都实现了 <code>Cache</code> 接口。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/Cache.png alt></p><p><code>Cache</code> 接口定义了 MyBatis 缓存最基本、最核心的行为，其中的核心方法主要是 <code>putObject()</code>、<code>getObject()</code> 和 <code>removeObject()</code>，分别用来添加、查询和删除缓存数据。MyBatis 在实现缓存模块时采用了装饰器模式（<a href=../../reading_notes/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0%e4%b9%8b%e5%8d%81%e8%a3%85%e9%a5%b0%e6%a8%a1%e5%bc%8f>设计模式读书笔记之装饰器模式</a>
），其中 <code>PerpetualCache</code> 扮演的正是装饰器模式中的 <code>ConcretComponent</code> 的角色，它实现了 <code>Cache</code> 接口缓存的基本能力。除 <code>PerpetualCache</code> 以外的其它 <code>Cache</code> 接口实现都是装饰器，扮演的是装饰器模式中的 <code>ConcreteDecorator</code> 的角色，不同装饰器提供了不同的功能扩展。</p><p>例如，<code>BlockingCache</code> 在原有缓存实现之上添加了阻塞线程的特性，<code>FifoCache</code> 添加了先进先出的特性，<code>LruCache</code> 添加了最近最少适用的淘汰机制等等。</p><h4 id=解析器模块>解析器模块</h4><p>MyBatis 中需要解析的配置文件分为两部分：一个是 <code>mybatis-config.xml</code> 配置文件，另一个是 <code>Mapper.xml</code> 配置文件。这两个文件都是由 MyBatis 的解析器模块进行解析的，其中主要是依赖 XPath 实现 XML 配置文件以及各类表达式的高效解析。</p><h4 id=事务管理模块>事务管理模块</h4><p>MyBatis 对数据库中的事务进行了一层简单的抽象，提供了简单易用的事务接口和实现。在 MyBatis 中，数据库事务被抽象为 <code>Transaction</code> 接口，它定义了提交事务、回滚事务以及获取底层数据库连接的方法。<code>TransactionFactory</code> 则是用于创建 <code>Transaction</code> 对象的工厂接口。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/Transaction.png alt></p><h4 id=反射工具模块>反射工具模块</h4><p>MyBatis 在 Java 反射的基础上进行了封装，为上层使用方提供了更加灵活、方便的 API 接口。反射工具箱的具体代码位于 <code>org.apache.ibatis.reflection</code> 包中。<code>Reflector</code> 是整个模块的基础，在使用反射模块操作一个 <code>Class</code> 之前，MyBatis 会将 <code>Class</code> 封装成一个 <code>Reflector</code>，为了提高反射执行的效率，<code>Reflector</code> 中缓存了 <code>Class</code> 的元数据信息。</p><p><code>Reflector</code> 将类的属性与方法等信息记录在自己的核心字段中，它的核心字段如下所示：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/Reflector.png alt></p><p><code>Reflector</code> 的构造函数以 <code>Class</code> 为参数，在构造方法内部会解析传入的 <code>Class</code> 对象，填充以上字段。</p><p>同样，为了提高 <code>Reflector</code> 的初始化速度，MyBatis 提供了 <code>ReflectorFactory</code> 工厂接口。该接口的默认实现 <code>DefaultReflectorFactory</code> 在内存中通过 <code>ConcurrentHashMap&lt;Class&lt;?>, Reflector></code>（即 <code>reflectorMap</code>）对 <code>Reflector</code> 对象进行了缓存，该接口的核心方法 <code>findForClass(Class&lt;?> type)</code> 就会根据传入 <code>Class</code> 查找 <code>reflectorMap</code> 缓存，若查找成功，则直接返回，否则创建相应的 <code>Reflector</code> 对象并放入缓存，以便下次使用。</p><p><code>ObjectFactory</code> 是 MyBatis 中的对象反射工厂接口，它提供了两个不同的 <code>create</code> 方法，我们可以用它来创建指定类型的对象。<code>DefaultObjectFactory</code> 是此接口的默认实现，底层会利用反射根据入参列表选择合适的构造函数实例化对象。我们可以在 <code>mybatis-config.xml</code> 中配置自定义的 <code>ObjectFactory</code> 接口的扩展实现类，达到自定义功能扩展的目的。</p><p>反射模块内还提供了几个用于解析属性的工具类：</p><ul><li><code>PropertyTokenizer</code>：负责解析由 <code>.</code> 和 <code>[]</code> 构成的表达式，支持对嵌套多层表达式的处理</li><li><code>PropertyCopier</code> 用于属性拷贝</li><li><code>PropertyNamer</code> 可以将方法名转换为属性名，亦能检测一个方法是否为 setter 或 getter 方法</li></ul><p>此外，反射模块还有 <code>MetaClass</code>，它封装了 Class 的元数据信息，以及 <code>ObjectWrapper</code>，它封装了对象的元数据信息。</p><h3 id=核心处理层>核心处理层</h3><p>MyBatis 的核心实现，涉及 MyBatis 的初始化以及执行一条 SQL 语句的全流程。</p><h4 id=配置解析>配置解析</h4><p>MyBatis 中有三处可以添加配置信息的地方：<code>mybatis-config.xml</code> 配置文件、<code>Mapper.xml</code> 配置文件，以及 <code>Mapper</code> 接口中的注解信息。MyBatis 会在初始化的时候加载这些配置信息，并在解析完成之后，将解析得到的配置到对象保存到 <code>Configuration</code> 对象中。</p><p>配置解析过程中用到了设计模式中的建造者模式（<a href=../../reading_notes/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0%e4%b9%8b%e5%85%ad%e5%bb%ba%e9%80%a0%e8%80%85%e6%a8%a1%e5%bc%8f>设计模式读书笔记之建造者模式</a>
）。</p><h5 id=mybatis-configxml-解析>mybatis-config.xml 解析</h5><p>MyBatis 初始化的第一个步骤就是加载和解析 <code>mybatis-config.xml</code> 这个全局配置文件。入口位于 <code>XMLConfigBuilder</code> 这个 Builder 对象，它由 <code>SqlSessionFactoryBuilder.build()</code> 方法创建。</p><p><code>XMLConfigBuilder</code> 会将 <code>mybatis-config.xml</code> 解析为对应的 <code>Configuration</code> 全局配置对象，然后 <code>SqlSessionFactoryBuilder</code> 会根据得到的 <code>Configuration</code> 对象创建一个 <code>DefaultSqlSessionFactory</code> 供上层使用。</p><p><code>XMLConfigBuiler</code> 继承自 <code>BaseBuilder</code> 抽象类，该类的继承关系如下：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/BaseBuilder.png alt></p><p><code>BaseBuilder</code> 提供了三方面的能力：</p><ul><li>关联 <code>Configuration</code> 对象</li><li>解析别名</li><li>解析 <code>TypeHandler</code></li></ul><p><code>mybatis-config.xml</code> 文件的解析是由 <code>XMLConfigBuilder.parse()</code> 方法触发的，其中的 <code>parseConfiguration()</code> 方法定义了解析 <code>mybatis-config.xml</code> 的完整流程。其核心步骤如下：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/parseConfiguration.png alt></p><h5 id=mapperxml-解析>Mapper.xml 解析</h5><p><code>mybatis-config.xml</code> 中可以定义多个 <code>&lt;mapper></code> 标签，指定 <code>Mapper</code> 配置文件的位置。MyBatis 会为每个 <code>Mapepr.xml</code> 映射文件都创建一个 <code>XMLMapperBuilder</code> 实例，从而完成相关解析工作。</p><h4 id=sql-解析与-scripting-模块>SQL 解析与 scripting 模块</h4><p>动态 SQL 是 MyBatis 最大的亮点，这个模块负责动态生成 SQL。具体来说，它会根据运行时用户传入的实参解析动态 SQL 中的标签，并形成 SQL 模板，然后处理 SQL 模板中的占位符，用实参填充占位符，得到真正可执行的 SQL 语句。</p><p>scripting 模块是 MyBatis 中动态生成 SQL 的核心模块，它会根据用户传入的实参解析动态 SQL 中的标签，形成 SQL 模板，然后用运行时的实参填充模板中的占位符，得到真正可以在数据库中执行的 SQL 语句。</p><h5 id=dynamiccontext>DynamicContext</h5><p>MyBatis 解析一条动态 SQL 语句的整个流程可能会非常长，其中涉及多层方法的调用、方法的递归、复杂的循环等，其中产生的中间结果需要有一个地方进行存储，那就是 <code>DynamicContext</code> 上下文对象。</p><p><code>DynamicContext</code> 有两个核心属性：一个是 <code>sqlBuilder</code> 字段（<code>StringJoiner</code> 类型），用来记录解析之后的 SQL 语句；另一个是 <code>bindings</code> 字段（<code>ContextMap</code> 类型），用来记录上下文中的一些 KV 信息。<code>ContextMap</code> 是 <code>DynamicContext</code> 定义的一个内部类，用来记录运行时用户传入的、用来替换“#{}”占位符的实参。</p><h5 id=sqlnode>SqlNode</h5><p>MyBatis 在处理动态 SQL 语句的时候，会将动态 SQL 标签解析为 <code>SqlNode</code> 对象，多个 <code>SqlNode</code> 对象通过组合模式（<a href=../../reading_notes/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af/%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e7%9a%84%e8%89%ba%e6%9c%af%e8%af%bb%e4%b9%a6%e7%ac%94%e8%ae%b0%e4%b9%8b%e4%b9%9d%e7%bb%84%e5%90%88%e6%a8%a1%e5%bc%8f>设计模式读书笔记之组合模式</a>
）组成树形结构供上层使用。<code>SqlNode</code> 接口充当的就是组合模式中的 <code>Component</code> 的角色，它的实现类非常多，很多都对应着一个动态 SQL 标签（组合模式中的 <code>Leaf</code> 角色），少数实现类扮演着组合模式中的 <code>Composite</code> 角色（比如 <code>MixedSqlNode</code>）。</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/SqlNode.png alt></p><ul><li><code>StaticTextSqlNode</code>用于表示非动态的 SQL 片段，其中维护了一个 <code>text</code> 字段（<code>String</code> 类型），用于记录非动态 SQL 片段的文本内容。</li><li><code>MixedSqlNode</code> 在整个 <code>SqlNode</code> 树中充当了树枝节点，也就是扮演了组合模式中 <code>Composite</code> 的角色，其中维护的 <code>List&lt;SqlNode></code> 集合了记录 <code>MixedSqlNode</code> 下所有的子 <code>SqlNode</code> 对象。</li><li><code>TextSqlNode</code> 抽象了包含 “${}”占位符的动态 SQL 片段，它通过一个 <code>text</code> 字段（<code>String</code> 类型）来记录包含“${}”占位符的 SQL 文本内容。</li><li><code>IfSqlNode</code> 对应了动态 SQL 语句中的 <code>&lt;if></code> 标签，MyBatis 的 <if>标签的 <code>test</code> 属性可以指定一个表达式，当表达式成立时，<code>&lt;if></code> 标签内的 SQL 片段才会出现在完整的 SQL 语句中。</li><li><code>TrimSqlNode</code> 对应 MyBatis 动态 SQL 语句中的 <code>&lt;trim></code> 标签。在使用 <code>&lt;trim></code> 标签的时候，我们可以指定 <code>prefix</code> 和 <code>suffix</code> 属性添加前缀和后缀，也可以指定 <code>prefixesToOverrides</code> 和 <code>suffixesToOverrides</code> 属性来删除多个前缀和后缀（使用“|”分割不同字符串）。</li><li><code>ForeachSqlNode</code> 对应 MyBatis 动态 SQL 语句中的 <code>&lt;foreach></code> 标签。我们可以在动态 SQL 语句中使用 <code>&lt;foreach></code> 标签对一个集合进行迭代。在迭代过程中，可以通过 <code>index</code> 属性值指定的变量作为元素的下标索引（迭代 <code>Map</code> 集合的话，就是 <code>Key</code> 值），使用 <code>item</code> 属性值指定的变量作为集合元素（迭代 <code>Map</code> 集合的话，就是 <code>Value</code> 值）。另外，我们还可以通过 <code>open</code> 和 <code>close</code> 属性在迭代开始前和结束后添加相应的字符串，也可以使用 <code>separator</code> 属性自定义分隔符。</li><li><code>ChooseSqlNode</code> 对应 MyBatis 动态 SQL 语句中的 <code>&lt;choose></code> 标签。其内部的<code>&lt;when></code> 标签会被解析成 <code>IfSqlNode</code> 对象，<code>&lt;otherwise></code> 标签会被解析成 <code>MixedSqlNode</code> 对象。</li><li><code>VarDeclSqlNode</code> 抽象了 <code>&lt;bind></code> 标签，其核心功能是将一个 OGNL 表达式的值绑定到一个指定的变量名上，并记录到 <code>DynamicContext</code> 中。</li></ul><h5 id=sqlsourcebuilder>SqlSourceBuilder</h5><p>动态 SQL 语句在被解析成 <code>SqlNode</code> 对象后，会经由 <code>SqlSourceBuilder</code> 进一步处理。<code>SqlSourceBuilder</code> 的核心操作主要有两个：</p><ul><li>解析“#{}”占位符中携带的各种属性。</li><li>将 SQL 语句中的“#{}”占位符替换成“?”占位符，替换之后的 SQL 语句就可以提交给数据库进行编译了。</li></ul><p><code>SqlSourceBuilder</code> 完成了“#{}”占位符的解析和替换之后，会将最终的 SQL 语句以及得到的 <code>ParameterMapping</code> 集合封装成一个 <code>StaticSqlSource</code> 对象并返回。</p><h5 id=sqlsource>SqlSource</h5><p>动态 SQL 经过 <code>SqlNode</code> 和 <code>SqlSourceBuilder</code> 之后，最终会由 <code>SqlSource</code> 进行最后的处理。<code>SqlSource</code> 接口中只定义了一个 <code>getBoundSql()</code> 方法，它控制着动态 SQL 语句解析的整个流程。它会根据从 <code>Mapper.xml</code> 映射文件（或注解）解析到的 SQL 语句以及执行 SQL 时传入的实参，返回一条可执行的 SQL。接口继承关系如下：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/SqlSource.png alt></p><h6 id=dynamicsqlsource>DynamicSqlSource</h6><p><code>DynamicSqlSource</code> 主要负责解析动态 SQL 语句以及“#{}”占位符。</p><p>动态 SQL 的判断标准：如果某个 SQL 片段包含了未解析的“${}”占位符或动态 SQL 标签，则为动态 SQL 语句。但是，只包含“#{}”占位符的 SQL 并不是动态 SQL。</p><h6 id=rawsqlsource>RawSqlSource</h6><p>与 <code>DynamicSqlSource</code> 不同，<code>RawSqlSourc</code> 处理的是非动态 SQL 语句，它解析 SQL 语句的时机是在初始化流程中。</p><h6 id=staticsqlsource>StaticSqlSource</h6><p>无论是 <code>DynamicSqlSource</code> 还是 <code>RawSqlSource</code>，底层都依赖 <code>SqlSourceBuilder</code> 解析之后得到的 <code>StaticSqlSource</code> 对象。<code>StaticSqlSource</code> 中维护了解析之后的 SQL 语句以及“#{}”占位符的属性信息。</p><h4 id=sql-执行>SQL 执行</h4><p>在 MyBatis 中，执行一条 SQL 的核心组件有 <code>Executor</code>、<code>StatementHandler</code>、<code>ParameterHandler</code> 和 <code>ResultSetHandler</code>。其中，<code>Executor</code> 会调用事务管理模块实现事务的相关通知，同时会通过缓存模块的一级缓存和二级缓存。SQL 语句的真正执行由 <code>StatementHandler</code> 实现，它会依赖 <code>ParameterHandler</code> 进行 SQL 模板的数据绑定，然后传到数据库执行，从数据库拿到 <code>ResultSet</code>。最后，<code>ResultSetHandler</code> 会将 <code>ResultSet</code> 映射为 Java 对象返回给调用方。下图展示了一条 SQL 执行的大致过程：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/sql-execution-process.png alt="SQL 语句执行过程"></p><h5 id=executor>Executor</h5><p>MyBatis 中有多个 <code>Executor</code> 接口的实现类，如下图所示：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/Executor.png alt></p><h6 id=baseexecutor>BaseExecutor</h6><p><code>BaseExecutor</code> 使用模板方法模式实现了 <code>Executor</code> 接口中的方法，其中，不变的部分是事务管理和缓存管理两部分的内容，由 <code>BaseExecutor</code> 实现；变化的部分则是具体的数据库操作，由 <code>BaseExecutor</code> 子类实现，涉及 <code>doUpdate()</code>、<code>doQuery()</code>、<code>doQueryCursor()</code> 和 <code>doFlushStatement()</code> 这四个方法。</p><h6 id=simpleexecutor>SimpleExecutor</h6><p><code>SimpleExecutor</code> 是 <code>Executor</code> 接口最简单的实现。</p><h6 id=reuseexecutor>ReuseExecutor</h6><p>重用 <code>Statement</code> 对象是一种常见的优化手段，不仅可以减少 SQL 预编译开销，还能降低 <code>Statement</code> 对象的创建和销毁频率，这在一定程度上可以提升系统性能。<code>ReuseExecutor</code> 就实现了重用 <code>Statement</code> 的优化。</p><p><code>ReuseExecutor</code> 中的 <code>do*()</code> 方法实现与 <code>SimpleExecutor</code> 实现完全一样，两者唯一的区别在于其中依赖的 <code>prepareStatement()</code> 方法：<code>SimpleExecutor</code> 每次都会创建全新的 <code>Statement</code> 对象，<code>ReuseExecutor</code> 则是先尝试查询 <code>statementMap</code> 缓存，如果缓存命中，则会重用其中的 <code>Statement</code> 对象。</p><h6 id=batchexecutor>BatchExecutor</h6><p>批处理是 JDBC 编程中的一种常见优化手段。不过，有一点需要特别注意：每次向数据库发送的 SQL 语句的条数是有上限的，如果批量执行的时候超过这个上限值，数据库就会抛出异常，拒绝执行这一批 SQL 语句，所以我们需要控制批量发送 SQL 语句的条数和频率。<code>BatchExecutor</code> 是用于实现批处理的 <code>Executor</code> 实现类。</p><h6 id=cachingexecutor>CachingExecutor</h6><p><code>CachingExecutor</code> 是一个 <code>Executor</code> 装饰器实现，会在其他 <code>Executor</code> 的基础之上添加二级缓存的相关功能。</p><h4 id=插件>插件</h4><p>我们可以通过自定义的插件来扩展 MyBatis，或者改变 MyBatis 的默认行为。插件模块中最核心的接口就是 <code>Interceptor</code> 接口，所有 MyBatis 插件都必须要实现的这个接口。</p><h3 id=接口层>接口层</h3><p>接口层中的接口都是 MyBatis 最常使用的一些接口，比如 <code>SqlSession</code> 和 <code>SqlSessionFactory</code> 等，其中最核心的接口是 <code>SqlSession</code>，我们可以通过它获取 <code>Mapper</code> 代理、执行 SQL 语句、控制事务开关等。</p><h4 id=sqlsession>SqlSession</h4><p><code>SqlSession</code> 是 MyBatis 对外提供的一个 API 接口，整个 MyBatis 接口层也是围绕 <code>SqlSession</code> 接口展开的，SqlSession 接口中定义了下面几类方法。</p><ul><li><p><code>select*()</code> 方法：用来执行查询操作的方法，<code>SqlSession</code> 会将结果集映射成不同类型的结果对象，例如，<code>selectOne()</code> 方法返回单个 Java 对象，<code>selectList()</code>、<code>selectMap()</code> 方法返回集合对象。</p></li><li><p><code>insert()</code>、<code>update()</code>、<code>delete()</code> 方法：用来执行 DML 语句。</p></li><li><p><code>commit()</code>、<code>rollback()</code> 方法：用来控制事务。</p></li><li><p><code>getMapper()</code>、<code>getConnection()</code>、<code>getConfiguration()</code> 方法：分别用来获取接口对应的 <code>Mapper</code> 对象、底层的数据库连接和全局的 <code>Configuration</code> 配置对象。</p></li></ul><p>MyBatis 提供了两个 <code>SqlSession</code> 接口的实现类，还提供了 <code>SqlSessionFactory</code> 来创建 <code>SqlSession</code> 对象。相关类的关系如下：</p><p><img src=https://zhannicholas.github.io/images/notebook/MyBatis/SqlSession-interface.png alt></p><p>其中，<code>DefaultSqlSession</code> 是 <code>SqlSession</code> 的默认实现，它维护了一个 <code>Executor</code> 对象，用来完成数据库操作以及事务管理。</p><p><code>DefaultSqlSessionFactory</code> 是创建 <code>DefaultSqlSession</code> 的具体实现。</p><p><code>SqlSessionManager</code> 同时实现了 <code>SqlSession</code> 和 <code>SqlSessionFactor</code>y 两个接口，也就是说，它同时具备操作数据库的能力和创建 <code>SqlSession</code> 的能力。</p></div><hr><aside><h4>No linked references</h4></aside><br><aside class=related></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer></body></html>
<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>HTTP：连接管理 | NZ's Digital Garden</title><meta name=description content><meta property="og:title" content="HTTP：连接管理 | NZ's Digital Garden"><meta name=twitter:title content="HTTP：连接管理 | NZ's Digital Garden"><meta itemprop=name content="HTTP：连接管理 | NZ's Digital Garden"><meta name=application-name content="HTTP：连接管理 | NZ's Digital Garden"><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content="NZ's Digital Garden"><meta property="og:description" content><meta property="og:site_name" content="NZ's Digital Garden"><meta property="og:url" content="https://zhannicholas.github.io/posts/computer_networks/http/connection_management/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.18fd6a148d228a21aa01f9bfa565483863277d2674e292f9fe859f7a8261cec6.css" integrity="sha256-GP1qFI0iiiGqAfm/pWVIOGMnfSZ04pL5/oWfeoJhzsY="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">NZ's Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-primary-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-primary-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">HTTP：连接管理</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#tcp%e8%bf%9e%e6%8e%a5>TCP连接</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#http%e8%bf%9e%e6%8e%a5%e5%a4%84%e7%90%86>HTTP连接处理</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#connection-header>Connection Header</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b8%b2%e8%a1%8c%e4%ba%8b%e5%8a%a1%e5%a4%84%e7%90%86%e4%b8%8e%e7%9f%ad%e8%bf%9e%e6%8e%a5>串行事务处理与短连接</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e8%a1%8c%e8%bf%9e%e6%8e%a5>并行连接</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%8c%81%e4%b9%85%e8%bf%9e%e6%8e%a5>持久连接</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e8%a1%8c%e8%bf%9e%e6%8e%a5-vs-%e6%8c%81%e4%b9%85%e8%bf%9e%e6%8e%a5>并行连接 vs 持久连接</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#http10%e4%b8%ad%e7%9a%84keep-alive%e8%bf%9e%e6%8e%a5>HTTP/1.0+中的Keep-Alive连接</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#http10%e6%8c%81%e4%b9%85%e8%bf%9e%e6%8e%a5>HTTP/1.0持久连接</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%ae%a1%e9%81%93%e5%8c%96%e8%bf%9e%e6%8e%a5>管道化连接</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%bf%9e%e6%8e%a5%e7%9a%84%e5%85%b3%e9%97%ad>连接的关闭</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%bc%82%e5%b8%b8%e5%85%b3%e9%97%ad%e8%bf%9e%e6%8e%a5>异常关闭连接</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%ad%a3%e5%b8%b8%e5%85%b3%e9%97%ad%e8%bf%9e%e6%8e%a5>正常关闭连接</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%ae%8c%e5%85%a8%e5%85%b3%e9%97%ad%e4%b8%8e%e5%8d%8a%e5%85%b3%e9%97%ad>完全关闭与半关闭</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>HTTP连接是HTTP报文传输的关键通道。</p><h2 id=tcp连接>TCP连接</h2><p>TCP/IP是全球计算机及网络设备都在使用的一个分层包交换协议集，几乎所有的HTTP通信都是由TCP/IP承载的。TCP连接时可靠的，它为HTTP提供了一条<em>可靠的比特传输管道</em>，从TCP连接一端传入的字节会在另一端以原有的顺序被正确地传送出来。</p><p>TCP会将数据切分为小的数据块发送，这些小的数据块就是<strong>IP数据包（IP packets）<strong>或</strong>IP数据报（IP datagrams）</strong>。这个时候，HTTP就位于<em>HTTP over TCP over IP</em>这个协议栈的最顶层，其安全版本HTTPS只是在HTTP和TCP之间插入了一个加密层（称为TLS或SSL）：</p><p><img src=https://zhannicholas.github.io/images/computer_networks/http/http-and-https-network-protocol-stacks.png alt="HTTP and HTTPS network protocol stacks"></p><p>HTTP在传送一条报文时，会以流的形式将报文内容通过一条打开的TCP连接按序传输。TCP在收到数据流之后，会先将数据流分割成小数据块（这些数据块被称为<strong>段（segments）</strong>），然后将段封装在IP数据包中，通过Internet进行传输。所有的这些工作都是由TCP/IP软件来处理的，每个TCP段都由IP数据报承载，从一个IP地址发送到另一个IP地址。每个IP数据包中都包括：</p><ul><li>一个IP数据报首部（通常为20字节）。</li><li>一个TCP段首部（通常为20字节）。</li><li>一个TCP数据块（0或多个字节）。</li></ul><p>TCP通过<em>端口号</em>来保持当前打开的TCP连接的正确运行。IP地址帮助我们找到正确的主机，而端口号帮助我们找到该主机上正确的应用程序。一条TCP连接由<code>&lt;source-IP-address, source-port, destination-IP-address, destination-port></code>四个值唯一标识。</p><h2 id=http连接处理>HTTP连接处理</h2><p>HTTP允许客户端和最终的源端服务器中间存在一个<strong>中间实体（intermediary）</strong>（代理、缓存等）链。HTTP报文从客户端开始在中间设备间逐跳转发，最终到达源端服务器。或者从源端服务器出发，经过中间设备间的逐跳转发，最终达到客户端。</p><h3 id=connection-header>Connection Header</h3><p>HTTP的<code>Connection</code>首部是一个通用首部，它允许发送方或客户端声明一些只用于某个特定连接的选项，并且这些选项不会（也不能）被其它的连接使用。这些选项就是<code>Connection</code>首部字段中的一个由逗号分隔的<em>连接标签</em>列表。例如：可以用<code>Connection: close</code>来表面发送方希望在响应报文发送之后关闭连接。</p><p><code>Connection</code>首部可以承载3中不同类型的标签：</p><ul><li>HTTP首部字段名：列出只与此连接有关的首部。</li><li>值<code>close</code>：说明当前的<code>request/response</code>操作完成之后就关闭这条连接。这是HTTP/1.0中的默认值。</li><li>任意标签值：描述此连接的非标准选项。</li></ul><p>如果<em>连接标签</em>列表中包含了一些HTTP首部字段的名称，那么这些首部字段就包含了一些与连接有关的信息，这些信息是不能被转发出去的。在将HTTP报文被转发出去之前，代理必须删除<code>Connection</code>首部中列出的所有HTTP首部字段。<code>Connection</code>首部是一个逐跳首部，只适用于单各链路并且不应该被顺着链路向下传输。</p><h3 id=串行事务处理与短连接>串行事务处理与短连接</h3><p>HTTP最早期的模型是<strong>短连接（Short-lived connections）</strong>。每一个HTTP请求都由它自己独立的连接完成，这意味着每发起一个HTTP请求之前都会进行一次TCP握手。这些连接的生命周期很短：每发起一个请求时都会创建一个新的连接，并在收到响应时立即关闭。</p><p>TCP协议握手本身就是很耗时的，所以TCP可以通过保持更多的热连接来适应负载。而短连接破坏了TCP具备的能力，因为新的冷连接降低了其性能。如果每个事务都需要（串行地建立）一条新的连接，那么TCP的连接时延和慢启动时延就会叠加起来。</p><p>短连接是HTTP/1.0的默认模型（如果没有指定<code>Connection</code>头，或它的值被设置为<code>close</code>）。而在HTTP/1.1中，只有当<code>Connection</code>被设为为<code>close</code>时才会用到短连接模型。</p><p><img src=https://zhannicholas.github.io/images/computer_networks/http/short-lived-connections.png alt="Short-lived connections"></p><p>短连接对TCP性能有先天的限制：每打开一个TCP连接都是相当耗费资源的操作。为了解决短连接模型的低效率问题，出现了几种新的模型：</p><ul><li><strong>并行连接（Parallel connections）</strong>：通过多条TCP连接发起并发的HTTP请求。</li><li><strong>持久连接（Persistent connections）</strong>：重用TCP连接，以消除打开及关闭TCP连接时的时延。</li><li><strong>管道化连接（Pipelined connections）</strong>：通过共享的TCP连接发起并发的HTTP请求。</li><li><strong>复用连接（Multiplexed connections）</strong>：交替传送请求和响应报文。</li></ul><h3 id=并行连接>并行连接</h3><p>HTTP允许客户端打开多条连接，并行地执行多个HTTP事务，每个事务都有自己的TCP连接。</p><p><img src=https://zhannicholas.github.io/images/computer_networks/http/parallel-connections.png alt="Parallel connections"></p><p>例如，当一个网页里面包含多个组件的时候，如果并行连接能够克服单条连接的空载时间和宽带限制，网页的加载速度就会有所提高。时延可以重叠起来，如果单条连接没有充分利用带宽，空闲的带宽可以用来加载其它组件。</p><p>需要注意的是：并行连接可能会更快，但不一定总是更快。当一个较慢的客户端连接到较快的服务器上时，慢客户端的带宽可能很快被耗尽，接着就是带宽资源的竞争，这可能并不会带来性能的提升。因为，打开大量连接会消耗很多的内存资源，从而引发自身的性能问题。</p><p>很多浏览器都使用了并行连接，但它们一般都会将并行连接的总数限制在一个较小的值，而服务器可以随意关闭来自特定客户端的过量连接。</p><h3 id=持久连接>持久连接</h3><p>Web客户端经常会打开到同一个站点的连接，并且可能会在将来的一段时间内对该站点发起更多的请求，这种性质就是<strong>站点的局部性（site locality）</strong>。</p><p>因此，HTTP/1.1（以及HTTP/1.0的各种增强版本）允许HTTP设备在事务处理结束之后保持TCP连接的打开状态，以便将来的HTTP请求可以重用现有的连接。在事务结束之后仍然保持在打开状态的TCP连接被称为<strong>持久连接（persistent connections）</strong>。非持久连接会在每个事务结束之后关闭，而持久连接会在不同事务之间保持打开状态，直到客户端或服务器决定将其关闭位置。</p><p>重用已经对目标服务器打开的空闲持久连接，客户端就可以避开建立连接阶段的高昂开销。此外，已经打开的连接可以避免慢启动的拥塞适应阶段，以便更快速地进行数据的传输。</p><p>持久连接有两种类型：</p><ul><li>比较老的HTTP/1.0+中的<code>keep-alive</code>连接。</li><li>HTTP/1.1中的<code>persistent</code>连接。</li></ul><h4 id=并行连接-vs-持久连接>并行连接 vs 持久连接</h4><p>并行连接虽然可能比较快，但并行连接也有一些缺点：</p><ul><li>每个事务都会打开/关闭一条新的连接，这会耗费时间和带宽。</li><li>由于TCP的慢启动特性，每条新连接的实际性能会有所降低。</li><li>可打开的并行连接的最大数量实际上是有限的。</li></ul><p>持久连接有一些比并行连接更好的地方。持久连接可以有效的降低时延和建立连接的开销，还可以很方便地控制打开连接的数量。但是，一直打开的大量空闲连接会带来新的问题，它们会消耗客户端与服务器的资源。因此，管理持久连接时要特别仔细。</p><h4 id=http10中的keep-alive连接>HTTP/1.0+中的Keep-Alive连接</h4><p><img src=https://zhannicholas.github.io/images/computer_networks/http/persistent-connections.png alt="Persistent connections"></p><p>和短连接相比，持久连接节省了打开/关闭连接和TCP慢启动阶段的开销。</p><p>在当前的HTTP/1.1规范中，keep-alive已经被弃用了。但是，keep-alive握手操作仍然在浏览器与服务器之间广泛使用。</p><p>实现了HTTP/1.0 keep-alive连接的客户端可以通过在请求头里面包含<code>Connection: Keep-Alive</code>来告诉服务器它希望连接保持打开状态。若服务器也愿意为下一条请求而保持连接的打开状态，它也会将<code>Connection: Keep-Alive</code>放入响应头。如果响应报文中没有<code>Connection: Keep-Alive</code>，那么客户端就会认为服务器不支持keep-alive并且服务器会在发回响应报文之后关闭连接。</p><h5 id=keep-alive选项>Keep-Alive选项</h5><p>需要注意的是：<code>keep-alive</code>首部只是请求将连接保持在打开状态，而客户端和服务器不一定会同意进行keep-alive会话。它们可以在任何时候关闭空闲的keep-alive连接，也可以随意限制在keep-alive连接上处理的事务数量。</p><p>我们通过调整<code>Keep-Alive</code>通用首部中的一些由逗号分隔的参数来改变keep-alive行为：</p><ul><li><code>timeout</code>参数是在Keep-Alive响应头中发送的。它代表着一个服务器可能会将连接保持在打开状态的时间的估计值。这不是一个承诺值。</li><li><code>max</code>参数也是在Keep-Alive响应头中发送的。它表示服务器还希望为多少个事务而将连接表示在打开状态，事务的数量也是一个估计值，不是承诺值。</li><li><code>Keep-Alive</code>首部还支持任意未经处理的属性，这些属性主要用于诊断和调试，语法为<code>name [=value]</code>。</li></ul><p><code>Keep-Alive</code>首部是可选的，只有在<code>Connection: Keep-Alive</code>出现时才会被使用。例如下面这两行表示服务器最多还会为另外5个事务保持连接的打开状态，或者将连接的打开状态再保持120秒：</p><pre tabindex=0><code>Connection: Keep-Alive
Keep-Alive: max=5, timeout=120
</code></pre><h5 id=keep-alive连接的限制与规则>Keep-Alive连接的限制与规则</h5><p>使用keep-alive连接时有一些限制和需要特别说明的地方：</p><ul><li>在HTTP/1.0中，keep-alive不是默认使用的。客户端必须发送一个<code>Connection: Keep-Alive</code>请求头来激活keep-alive连接。</li><li><code>Connection: Keep-Alive</code>首部必须随所有希望保持持久连接的报文一起发送。如果客户端没有发送它，服务器会在完成该请求之后关闭连接。</li><li>客户端可以根据响应报文中是否有<code>Connection: Keep-Alive</code>首部来判断服务器是否已经在发出响应报文之后关闭连接。</li><li>只有在无需检测连接关闭就能确定报文的实体主体的长度时，连接才能被保持在打开状态。</li><li>代理和网关必须执行<code>Connection</code>首部上的规则。代理和网关必须在转发或缓存报文之前移除<code>Connection</code>首部中出现的首部字段及<code>Connection</code>首部本身。</li><li>一般来说，不应该在代理服务器无法保证支持<code>Connection</code>首部的情况下建立keep-alive连接，这么做是为了避免**哑代理（dumb proxies）**问题的出现。</li><li>从技术上说，应该忽略所有来自HTTP/1.0设备的<code>Connection</code>首部字段，因为它们可能是由比较老的代理服务器误转发的。</li><li>除非重复的请求会产生副作用，客户端必须准备好在接收到响应之前连接就关闭时重发请求。</li></ul><h4 id=http10持久连接>HTTP/1.0持久连接</h4><p>HTTP/1.0逐渐停止了对keep-alive连接的支持，并用一种名为**持久连接（persistent connection）**的设计取代了它。</p><p>与HTTP/1.0+的keep-alive连接不同，HTTP/1.1的持久连接在默认情况下是激活的。也就是说，除非特别指明，否则HTTP/1.1会假定所有的连接都是持久的。若要在事务处理结束之后关闭连接，HTTP/1.1应用程序必须在报文中显式地添加一个<code>Connection: close</code>首部。但是，客户端和服务器是可以在任何时候关闭空闲连接的，所以不发送<code>Connection: close</code>并不意味着服务器会永远将连接保持在打开状态。</p><h5 id=持久连接的限制与规则>持久连接的限制与规则</h5><p>在使用持久连接时，有一些点需要注意：</p><ul><li>在发送<code>Connection: close</code>请求头之后，客户端就不能在该连接上发送其它的请求了。</li><li>如果客户端不想在某条连接上发送另一个请求，那么它应该在当前的最后一个请求中发送<code>Connection: close</code>首部。</li><li>只有当连接上的所有报文都是正确的自定义的消息长度，连接才能被保持在打开状态。</li><li>HTTP/1.1代理必须能够区分关系客户端和服务器的持久连接，每条持久连接都只适用于单跳传输。</li><li>HTTP/1.1服务器不应该与HTTP/1.0客户端建立持久连接。</li><li>不管<code>Connection</code>首部内容如何，HTTP/1.1设备都可以在任意时刻关闭连接。</li><li>除非重复发起请求会产生副作用，否则如果客户端在收到整个响应之前连接就关闭了，客户端必须重新发起请求。</li><li>一个用户客户端对任何服务器或代理最多只能维持两条持久连接，以防止服务器过载。</li></ul><h3 id=管道化连接>管道化连接</h3><p>HTTP/1.1允许在持久连接之上使用可选的<strong>管道化连接（Pipelined connections）</strong>：在响应到达之前，可以将多条请求放入队列，当第一条请求经过网络流向服务器时，其它的请求也可以开始发送了。在高延迟的网络条件下，管道化连接可以降低网络的环回时间，提高性能。</p><p><img src=https://zhannicholas.github.io/images/computer_networks/http/pipelined-connections.png alt="Pipelined connections"></p><p>在使用管道化连接时，有一些地方需要注意：</p><ul><li>如果HTTP客户端无法确认连接是持久的，它就不应该使用管道。</li><li>服务器必须按照与请求相同的顺序回送HTTP响应。因为HTTP报文中没有序列号标签，所以响应不能失序。</li><li>HTTP客户端必须做好连接可能在任意时刻关闭的准备，并重发所有未完成的管道化请求。</li><li>HTTP客户端不应该使用管道化的方式发送会产生副作用的请求。</li></ul><h2 id=连接的关闭>连接的关闭</h2><h3 id=异常关闭连接>异常关闭连接</h3><p>所以的HTTP客户端、服务器或代理都可以在任意时刻关闭一条TCP传输连接，HTTP应用程序必须做好正确处理连接非正常关闭的情况。</p><p>每条HTTP响应都应该有精确的<code>Content-Length</code>首部，用来描述响应主体的大小。一些老的HTTP服务器会省略这个首部，这样就要通过服务器发出的连接关闭来确定数据的真实末尾。</p><h3 id=正常关闭连接>正常关闭连接</h3><p>TCP连接是双向的。TCP连接的每一端都有一个输入队列和一个输出队列，分别用于数据的读写。放在一端输出队列中的数据最终会出现在另一端的输入队列中。</p><p><img src=https://zhannicholas.github.io/images/computer_networks/http/tcp-connections-are-bidirectional.png alt="TCP connections are bidirectional"></p><h4 id=完全关闭与半关闭>完全关闭与半关闭</h4><p>应用程序可以关闭TCP输入与输出信道中的任意一个，或将两个都关闭。套接字调用<code>close()</code>会将TCP连接的输入与输出信道都关闭，这就是<em>完全关闭</em>。而套接字调用<code>shutdown()</code>只会单独关闭输入或输出信道，这就是<em>半关闭</em>。</p><p>关闭连接的输出信道总是安全的：另一端的对等实体会在读取完缓存区中的所有数据之后得到一个流结束的通知，从而知道信道已经关闭；除非应用程序知道另一端不会再发送其它数据了，关闭连接的输出信道是比较危险的：另一端的对等实体向已关闭的输入信道发送数据时，操作系统会回送一条"connection reset by peer"的消息。大部分操作系统都会将这种情况作为严重错误来处理，并删除对端还未读取的所有缓存数据。</p><h2 id=参考资料>参考资料</h2><ol><li>David Gourley, Brian Totty. <em>HTTP: The Definitive Guide</em>. O&rsquo;Reilly Media, 2002.</li><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Connection_management_in_HTTP_1.x target=_blank>HTTP/1.x 的连接管理</a>
.</li></ol></div><hr><aside><h4>No linked references</h4></aside><br><aside class=related><h3 class="text-2xl font-black tracking-tight text-primary-500 capitalize dark:text-primary-300 sm:text-2xl">Related Content</h3><ul><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/computer_networks/http/client_certification_and_cookies>HTTP：客户端身份识别与Cookie</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/computer_networks/http/caching>HTTP：缓存</a></p></ul></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/pages class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p><p class="mt-2 text-base text-center text-gray-400">Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/sawhney17/logseq-schrodinger>logseq-schrodinger</a>.</p></div></footer></body></html>
<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/images/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/images/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/images/favicon/favicon-16x16.png><meta name=theme-color content="#ffffff"><title itemprop=name>Java 中的 synchronized</title><meta property="og:title" content="Java 中的 synchronized"><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta itemprop=name content="Java 中的 synchronized NZ's Digital Garden"><meta name=application-name content="Java 中的 synchronized NZ's Digital Garden"><meta name=author content="Nicholas Zhan"><meta name=description content><meta itemprop=description content><meta name=url content="https://zhannicholas.github.io/posts/java/concurrency/synchronization/"><link rel=canonical href=https://zhannicholas.github.io itemprop=url><script type=application/ld+json>{"@context":"https://schema.org","@type":"Dentist","name":"NZ\u0027s Digital Garden","description":"","slogan":"","openingHours":"","telephone":"","email":"","vatID":"","url":"https:\/\/zhannicholas.github.io","logo":"https:\/\/zhannicholas.github.io/images/logo_small.png","image":"https:\/\/zhannicholas.github.io/images/logo_full.png","address":{"@type":"PostalAddress","streetAddress":" ","addressLocality":"","addressRegion":"","postalCode":"","addressCountry":""},"geo":{"@type":"GeoCoordinates","latitude":"","longitude":""},"sameAs":[]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/zhannicholas.github.io"},{"@type":"ListItem","position":3,"name":"Posts","item":"https:\/\/zhannicholas.github.io\/posts\/"},{"@type":"ListItem","position":4,"name":"Java","item":"https:\/\/zhannicholas.github.io\/posts\/java\/"},{"@type":"ListItem","position":5,"name":"Concurrency","item":"https:\/\/zhannicholas.github.io\/posts\/java\/concurrency\/"},{"@type":"ListItem","position":6,"name":"Synchronization","item":"https:\/\/zhannicholas.github.io\/posts\/java\/concurrency\/synchronization\/"}]}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/main.min.710986944c2e6da1b8df15c5e0c7999affdc4e9ebac27cc9e6df4208f465c990609147ac1865f2be657443a9658b90c9492b300f4990327501d2b36e9be544f8.css" integrity="sha512-cQmGlEwubaG43xXF4MeZmv/cTp66wnzJ5t9CCPRlyZBgkUesGGXyvmV0Q6lli5DJSSswD0mQMnUB0rNum+VE+A==" media=screen><script type=module>
  import Alpine from '/js/alpinejs.js';
  window.Alpine = Alpine;
  Alpine.start();
</script><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(console.log("add dark"),document.documentElement.classList.add("dark")):(console.log("remove dark"),document.documentElement.classList.remove("dark"))</script></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt="'s Digital Garden Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">'s Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts/>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/notes/>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library/>Library</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/til/>Today I Learned</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now/>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about/>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Java 中的 synchronized</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#synchronized-%e5%85%b3%e9%94%ae%e5%ad%97><code>Synchronized</code> 关键字</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#java%e5%af%b9%e8%b1%a1%e5%a4%b4>Java对象头</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%94%81%e7%9a%84%e7%8a%b6%e6%80%81%e7%ba%a7%e5%8d%87%e7%ba%a7%e8%bf%87%e7%a8%8b>锁的状态级升级过程</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%97%a0%e9%94%81>无锁</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%81%8f%e5%90%91%e9%94%81>偏向锁</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%bd%bb%e9%87%8f%e7%ba%a7%e9%94%81>轻量级锁</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%87%8d%e9%87%8f%e7%ba%a7%e9%94%81>重量级锁</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%94%81%e5%8d%87%e7%ba%a7%e5%b0%8f%e7%bb%93>锁升级小结</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%bb%8ejvm%e8%a7%86%e8%a7%92%e7%9c%8b%e5%90%8c%e6%ad%a5>从JVM视角看同步</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%90%8c%e6%ad%a5%e6%96%b9%e6%b3%95>同步方法</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%90%8c%e6%ad%a5%e4%bb%a3%e7%a0%81%e5%9d%97>同步代码块</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>Java语言提供了多种线程间通信机制（同步、while轮询、等待/通知、管道等等），其中最基础的通信方式就是 <strong>同步（synchronization）</strong>。Java中的同步是通过<code>monitor</code>来实现的，每个Java对象都有一个与之相关联的<code>monitor</code>，线程可以在其上进行加锁和释放锁的操作。同一时刻只能有一个线程持有某个<code>monitor</code>的锁，任何其它尝试给该<code>monitor</code>加锁的线程在获得锁之前都会被阻塞。一个线程可以多次给某个<code>monitor</code>加锁，这就是锁的重入，多次加锁对应着多次解锁，因为每次<code>unlock</code>操作只会消除一次<code>lock</code>的效应。</p><h2 id=synchronized-关键字><code>Synchronized</code> 关键字</h2><p>Java提供了一种内置的锁机制来支持原子性：同步代码块（Synchronized Block）。同步代码块就是用 <code>synchronized</code> 关键字修饰的代码块，它包括两个部分：作为锁的对象引用和由这个锁保护的代码块。</p><p>用关键字 <code>synchronized</code> 修饰的方法是一种横跨整个方法体的同步代码块，其中该同步代码块的锁就是和该方法相关的对象（方法执行期间 <code>this</code> 关键字所代表的对象）。静态 <code>synchronized</code> 方法以 <code>Class</code> 对象为锁：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>staticMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// do something
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以下是以 <code>lock</code> 对象为锁：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>synchronized</span><span style=color:#960050;background-color:#1e0010>（</span>lock<span style=color:#960050;background-color:#1e0010>）</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// access or modify the shared state that is protected by the lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>而以下是以调用同步方法的<u>实例本身</u>为锁：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>instanceMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// do somehing ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>同步代码块是可重入的。</p><h2 id=java对象头>Java对象头</h2><p><em><a href=https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-2.html#jvms-2.5 target=_blank>The Java® Virtual Machine Specification (Java SE 11 Edition)</a></em> 本身并没有规定程序运行时对象的具体内存布局，因此在不同的虚拟机实现中，对象和数组的内存布局可能有所不同。下面主要关注 HotSpot VM 这一 JVM 实现。</p><p>HotSpot VM 使用了一种名为 <strong><a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops target=_blank>OOPs(Ordinary Object Pointers)</a></strong> 的数据结构表示指向对象的指针。虚拟机使用 <a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/oop.hpp#L55 target=_blank>oopDesc</a>
这个特殊的数据结构来描述所有的指针（包括对象和数组）。每个 oopDesc 都包含以下信息：</p><ul><li><a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/markOop.hpp target=_blank>mark word</a>
。这一类用于存储对象自身的运行时数据，比如 HashCode、GC 分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳等，<u>在运行期间，Mark Work 里面存储的数据会随着锁标志的变化而变化</u>。</li><li><a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/klass.hpp target=_blank>klass word</a>
。这一部分主要包含的是语言级别的类信息（比如类名、修饰符、父类信息等），即类型的元数据，Java 通过这个指针确定对象是哪个类的实例。该部分可能被压缩。</li></ul><p>对于 Java 对象（用 <a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/instanceOop.hpp target=_blank>instanceOop</a>
表示）而言，对象头包括 mark word、klass word，可能还有对齐填充。</p><p>对于 Java 数组（用 <a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/arrayOop.hpp target=_blank>arrayOop</a>
表示）而言，对象头包括 mark word、klass word、<code> sizeof(int)</code> 大小（一般为 4 字节）的数组长度，可能还有对齐填充。数组的对象头中还必须有一块用于记录数组长度的数据，因为 JVM 可以通过普通 Java 对象的元数据信息确定 Java 对象的大小，但是数组的长度是不确定的。</p><h2 id=锁的状态级升级过程>锁的状态级升级过程</h2><p>锁一共有4种状态，级别从低到高分别是：无锁、偏向锁、轻量级锁和重量级锁。<u>锁的状态只支持升级，不支持降级</u>。</p><p>以下是锁的四种状态下 markd word 的简要内容：</p><table><thead><tr><th>锁状态</th><th>存储内容</th><th>最后两位（锁标志）</th></tr></thead><tbody><tr><td>无锁</td><td>hashCode、GC分代年龄、是否偏向锁（0）</td><td>01</td></tr><tr><td>偏向锁</td><td>偏向线程ID、偏向时间戳、GC分代年龄、是否偏向锁（1）</td><td>01</td></tr><tr><td>轻量级锁</td><td>指向栈中锁记录的指针</td><td>00</td></tr><tr><td>重量级锁</td><td>指向互斥量（重量级锁）的指针</td><td>10</td></tr></tbody></table><p>mark word 的具体细节可以查看 <a href=https://github.com/openjdk/jdk11/blob/master/src/hotspot/share/oops/markOop.hpp#L35 target=_blank>OpenJDK 源码</a>
，32 位和 64 位模式下存储的内容是不一样的。</p><h3 id=无锁>无锁</h3><p>不对资源进行锁定，所有的线程都能访问并修改共享资源，但每次只有一个线程能修改成功。</p><p>在无锁状态下，线程会不断尝试修改共享资源。如果没有冲突，就修改成功并退出，否则
继续循环尝试直到修改成功。</p><h3 id=偏向锁>偏向锁</h3><p>大多数情况下，锁不仅不存在竞争，而且总是被同一个线程多次获得。偏向锁就是指同一个同步代码块一直被一个线程访问，那么该线程就会自动能够获取锁，这能降低获取锁的代价。</p><p>当一个线程访问同步代码块并获取锁时，会在对象头和栈帧的锁记录里面存储偏向的线程ID，以后该线程在进入和退出同步代码块时不需要进行CAS操作来加锁和解锁，只需要简单的检测一下对象头的Mark Word里是否存储着指向当前线程的偏向锁。如果测试成功，表示线程已经获得了锁，否者则需要再检测 Mark Word 中偏向锁的标识是否为1（如果未设置，则使用 CAS 竞争锁，否则尝试使用 CAS 将对象头的偏向锁指向当前线程）。</p><p>偏向锁使用了一种等到竞争出现才释放锁的机制，所以当其它线程尝试竞争偏向锁时，持有偏向锁的线程才会释放锁。偏向锁的撤销需要等到全局安全点（这个时间点上没有正在执行的字节码）上才能进行。它会先暂停拥有偏向锁的线程，判断锁对象是否处于被锁定的状态。撤销偏向锁后恢复到无锁或轻量级锁状态。</p><p>由于难以维护，Java 15 已经准备<a href=https://openjdk.java.net/jeps/374 target=_blank>弃用偏向锁</a>
了。</p><h3 id=轻量级锁>轻量级锁</h3><p>当偏向锁被其它线程访问时，偏向锁就会升级为轻量级锁，其它线程会通过自旋的方式尝试获取锁，不会阻塞。</p><p>当线程进入同步代码块时，若同步对象的锁状态为无锁状态，JVM 会再当前线程的栈帧中建立一个名为 Lock Record 的空间，用于存储对象目前的 Mark Word 的副本，然后将对象头中的 Mark Word 复制进去。复制成功后，JVM 会使用 CAS 操作尝试将对象的 Mark Word 更新为指向 Lock Record 的指针，并将 Lock Record 里的 owner 指针指向对象的 Mark Word。如果更新成功，该线程就获得了锁，对象头中的 Mark Word 会被设置为 <strong><code>00</code></strong>，表示此对象处于轻量级锁状态。若更新失败，JVM 会检查对象头的 Mark Word 是否指向当前线程的栈帧，如果是就说明当前线程已经拥有锁，就直接进入同步代码块继续执行，否则说明有多个线程在竞争该锁。</p><p>若当前只有一个等待线程，则该等待线程会以自旋的方式进行等待。当自旋超过一定次数，或者一个线程持有锁，一个线程在自旋，第三个线程又来访问时，轻量级锁会升级为重量级锁。</p><h3 id=重量级锁>重量级锁</h3><p>当锁升级为重量级锁时，Mark Word 存储的时指向重量级锁的指针，等待的线程会进入阻塞状态。</p><h3 id=锁升级小结>锁升级小结</h3><p>偏向锁通过比对 Mark Word 来解决加锁问题，避免 CAS 操作；轻量级锁通过 CAS 操作和自旋解决加锁问题，避免线程阻塞和唤醒带来的性能损耗；重量级锁则阻塞拥有锁的线程以外的所有线程。</p><h2 id=从jvm视角看同步>从JVM视角看同步</h2><p>JVM中的同步操作是通过 <code>monitor</code> 的进入与退出来实现的。其实现方式又可分为显式（通过使用 <code>monitorenter</code> 和 <code>monitorexit</code> 指令）和隐式（通过方法的调用与返回指令）两种。根据被修饰的代码块的形式不同，<code>synchronized</code> 关键字的使用可以分为两种情况：同步方法（<code>synchronized</code> 修饰的是静态方法或实例方法）和同步语句（<code>synchronized</code> 修饰的是一个代码块）。</p><h3 id=同步方法>同步方法</h3><p>方法级别的同步操作是隐式实现的，不涉及 <code>monitorenter</code> 和 <code>monitorexit</code> 指令的使用，同步就是方法调用与返回的一部分。在运行时常量池中的 <code>method_info</code> 结构中，有一个叫做 <code>ACC_SYNCHRONIZED</code> 的标志位。方法调用指令会去检查这个标志位，当一个设置了 <code>ACC_SYNCHRONIZED</code> 的方法被调用时，执行线程会先进入 <code>monitor</code>，然后调用方法本身，最后不管方法是否正常执行完成都会退出 <code>monitor</code>。在执行线程拥有 <code>monitor</code> 的时间段内，其它线程是不可能再进入该 <code>monitor</code> 的。</p><p>下面的 <code>SyncMethodDemo</code> 中包含两个同步方法，其中 <code>staticMethod</code> 是作用于类的静态同步方法，<code>instanceMethod</code> 是作用于对象实例的同步方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SyncMethodDemo</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>staticMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;static synchronized method&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>instanceMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;synchronized instance method&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>使用 <code>javap -v -c SyncMethodDemo.class</code> 得到两个方法的字节码如下：</p><pre tabindex=0><code class=language-class data-lang=class>static synchronized void staticMethod();
    descriptor: ()V
    flags: (0x0028) ACC_STATIC, ACC_SYNCHRONIZED
    Code:
      stack=2, locals=0, args_size=0
         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #3                  // String static synchronized method
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
         8: return
      LineNumberTable:
        line 3: 0
        line 4: 8

synchronized void instanceMethod();
  descriptor: ()V
  flags: (0x0020) ACC_SYNCHRONIZED
  Code:
    stack=2, locals=1, args_size=1
        0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
        3: ldc           #5                  // String synchronized instance method
        5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V
        8: return
    LineNumberTable:
      line 7: 0
      line 8: 8
    LocalVariableTable:
      Start  Length  Slot  Name   Signature
          0       9     0  this   LSyncMethodDemo;
</code></pre><p>可以看到，在字节码中，方法加了一个 <code>ACC_SYNCHRONIZED</code> 标志。静态同步方法 <code>staticMethod</code> 和 <code>instanceMethod</code> 区别不大，只不过是多了一个 <code>ACC_STATIC</code> 标志。</p><h3 id=同步代码块>同步代码块</h3><p>下面是 <a href=https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-3.html#jvms-3.14 target=_blank>JVMS11</a>
中给出的一个例子。同步代码块</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onlyMe</span><span style=color:#f92672>(</span>Foo f<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>synchronized</span><span style=color:#f92672>(</span>f<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        doSomething<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>会被编译成以下字节码：</p><pre tabindex=0><code class=language-class data-lang=class>Method void onlyMe(Foo)
0   aload_1             // Push f
1   dup                 // Duplicate it on the stack
2   astore_2            // Store duplicate in local variable 2
3   monitorenter        // Enter the monitor associated with f
4   aload_0             // Holding the monitor, pass this and...
5   invokevirtual #5    // ...call Example.doSomething()V
8   aload_2             // Push local variable 2 (f)
9   monitorexit         // Exit the monitor associated with f
10  goto 18             // Complete the method normally
13  astore_3            // In case of any throw, end up here
14  aload_2             // Push local variable 2 (f)
15  monitorexit         // Be sure to exit the monitor!
16  aload_3             // Push thrown value...
17  athrow              // ...and rethrow value to the invoker
18  return              // Return in the normal case
Exception table:
From    To      Target      Type
4       10      13          any
13      16      13          any
</code></pre><p>不管方法正常退出还是异常退出，编译器都会确保每条 <code>monitorenter</code> 指令都有一条对应的 <code>monitorexit</code> 被执行。</p><h2 id=参考资料>参考资料</h2><ol><li>方腾飞, 魏鹏, 程晓明. Java并发编程的艺术. 机械工业出版社, 2015.</li><li>美团技术团队. <a href=https://tech.meituan.com/2018/11/15/java-lock.html target=_blank>不可不说的Java“锁”事</a>
.</li><li><a href=https://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html target=_blank>Intrinsic Locks and Synchronization</a>
.</li><li><a href=https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-3.html#jvms-3.14 target=_blank>The Java® Virtual Machine Specification (Java SE 11 Edition)</a>
.</li><li><a href=https://www.baeldung.com/java-memory-layout target=_blank>Memory Layout of Objects in Java</a>
.</li></ol></div></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200) ? true : false"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts/ class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes/ class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library/ class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer><script type=text/javascript src=https://zhannicholas.github.io/js/app.min.5ce6717c9c557de80f2d726a4693ef2581084ac7685dfb48c6a73140cf8a6bbd5bd8f76b0dbfe285737c83b968be59d2db22198e4e39d5b0bc42e7571630c4b1.js integrity="sha512-XOZxfJxVfegPLXJqRpPvJYEISsdoXftIxqcxQM+Ka71b2PdrDb/ihXN8g7lovlnS2yIZjk451bC8QudXFjDEsQ=="></script></body></html>
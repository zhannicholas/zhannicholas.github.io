<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>Java：锁 | NZ's Digital Garden</title><meta name=description content><meta property="og:title" content="Java：锁 | NZ's Digital Garden"><meta name=twitter:title content="Java：锁 | NZ's Digital Garden"><meta itemprop=name content="Java：锁 | NZ's Digital Garden"><meta name=application-name content="Java：锁 | NZ's Digital Garden"><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content="NZ's Digital Garden"><meta property="og:description" content><meta property="og:site_name" content="NZ's Digital Garden"><meta property="og:url" content="https://zhannicholas.github.io/posts/java/concurrency/locks/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.18fd6a148d228a21aa01f9bfa565483863277d2674e292f9fe859f7a8261cec6.css" integrity="sha256-GP1qFI0iiiGqAfm/pWVIOGMnfSZ04pL5/oWfeoJhzsY="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">NZ's Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-primary-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-primary-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Java：锁</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b9%90%e8%a7%82%e9%94%81%e4%b8%8e%e6%82%b2%e8%a7%82%e9%94%81>乐观锁与悲观锁</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b9%90%e8%a7%82%e9%94%81>乐观锁</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%82%b2%e8%a7%82%e9%94%81>悲观锁</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#lock%e6%8e%a5%e5%8f%a3><code>Lock</code>接口</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#synchronized-vs-lock><code>synchronized</code> vs <code>Lock</code></a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%9b%b8%e5%90%8c%e7%82%b9>相同点</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b8%8d%e5%90%8c%e7%82%b9>不同点</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#abstractqueuedsynchronizeraqs>AbstractQueuedSynchronizer(AQS)</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#aqs%e7%9a%84%e5%ae%9e%e7%8e%b0%e5%88%86%e6%9e%90><code>AQS</code>的实现分析</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%90%8c%e6%ad%a5%e9%98%9f%e5%88%97>同步队列</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%8b%ac%e5%8d%a0%e5%bc%8f%e5%90%8c%e6%ad%a5%e7%8a%b6%e6%80%81%e7%9a%84%e8%8e%b7%e5%8f%96%e4%b8%8e%e9%87%8a%e6%94%be>独占式同步状态的获取与释放</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%85%b1%e4%ba%ab%e5%bc%8f%e5%90%8c%e6%ad%a5%e7%8a%b6%e6%80%81%e8%8e%b7%e5%8f%96%e4%b8%8e%e9%87%8a%e6%94%be>共享式同步状态获取与释放</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#reentrantlock>ReentrantLock</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%87%8d%e5%85%a5>重入</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%94%81%e7%9a%84%e5%85%ac%e5%b9%b3%e6%80%a7>锁的公平性</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#readwritelock>ReadWriteLock</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#reentrantreadwritelock>ReentrantReadWriteLock</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#locksupport>LockSupport</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#contidion%e6%8e%a5%e5%8f%a3><code>Contidion</code>接口</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><blockquote><p>文章中涉及的源代码摘自 OpenJdk 11。</p></blockquote><h2 id=乐观锁与悲观锁>乐观锁与悲观锁</h2><p>乐观锁与悲观锁是一种广义上的概念，体现了我们看待线程同步的不同角度。</p><h3 id=乐观锁>乐观锁</h3><p>乐观锁采用的思想是：<strong>冲突检测</strong>。例如：如果 A 和 B 同时编辑同一份文件，使用乐观锁策略， A 和 B 都能得到文件的一份拷贝并可以自由的编辑。假设 A 先完成工作，那么他可以毫无困难的更新他的修改。而当 B 在 A 提交之后完成工作并向提交他的修改时，并发控制策略将会起作用，如果检测到冲突，B 的提交将会被拒绝。</p><p>乐观锁认为锁的持有者在使用数据的过程中不会有别的线程修改数据，所以不会添加锁，只有在提交数据时才会进行检测。Java 中的乐观锁大部分是通过 CAS (Compare And Swap) 实现的。CAS 是一种无锁算法，用来将某一内存地址的值从一个状态更新到另一个状态。CAS 操作包含三个参数：内存地址、预期原值和新值。如果内存地址的值和预期的原值相等的话，那么就可以把该位置的值更新为新值，否则不做任何修改。例如， <code>AtomicInteger</code> 类中的 <code>compareAndSet()</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>compareAndSet</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> expectedValue<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> newValue<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> U<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSetInt</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> VALUE<span style=color:#f92672>,</span> expectedValue<span style=color:#f92672>,</span> newValue<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>CAS 虽然高效，但是它存在一个问题：在其调用期间，目标内存地址的值改变了数次，但该地址的当前值却有可能与调用者之前获取到的值相等，这在某些情况下是有问题的。也就是说，CAS 无法探测到“某个值被修改，然后再被改回原值”的情况，这就是所谓的 <strong>ABA 问题</strong>。ABA 问题的常见处理方式是添加版本号，线程每次修改值之后就更新版本号，JDK 中的 <code>AtomicStampedReference</code> 类就是一个典型的例子，它内部维护了一个“版本号” Stamp，每次在比较时既比较当前值又比较版本号，这样就解决了 ABA 问题。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AtomicStampedReference</span><span style=color:#f92672>&lt;</span>V<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pair</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> T reference<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> stamp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Pair</span><span style=color:#f92672>(</span>T reference<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> stamp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>reference</span> <span style=color:#f92672>=</span> reference<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>stamp</span> <span style=color:#f92672>=</span> stamp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> Pair<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>T reference<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> stamp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Pair<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;(</span>reference<span style=color:#f92672>,</span> stamp<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>compareAndSet</span><span style=color:#f92672>(</span>V   expectedReference<span style=color:#f92672>,</span> V   newReference<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> expectedStamp<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> newStamp<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Pair<span style=color:#f92672>&lt;</span>V<span style=color:#f92672>&gt;</span> current <span style=color:#f92672>=</span> pair<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> expectedReference <span style=color:#f92672>==</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>reference</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            expectedStamp <span style=color:#f92672>==</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>stamp</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>((</span>newReference <span style=color:#f92672>==</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>reference</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>              newStamp <span style=color:#f92672>==</span> current<span style=color:#f92672>.</span><span style=color:#a6e22e>stamp</span><span style=color:#f92672>)</span> <span style=color:#f92672>||</span>
</span></span><span style=display:flex><span>             casPair<span style=color:#f92672>(</span>current<span style=color:#f92672>,</span> Pair<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>newReference<span style=color:#f92672>,</span> newStamp<span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>乐观锁适用于读多写少的场景，也适用于读写都多但并发冲突不激烈的场景。在冲突较少的情况下，乐观锁能让性能大幅提高。</p><h3 id=悲观锁>悲观锁</h3><p>悲观锁采用的思想是：<strong>冲突避免</strong>。例如：如果 A 和 B 都想编辑同一份文件，使用悲观锁策略，若 A 先获得文件的编辑权，那么 B 就不能对文件进行编辑了。只有当 A 编辑完成并提交之后，B 才能对该文件进行操作。</p><p>悲观锁是比较保守的，它认为在自己使用数据时会有别的线程来修改数据，因此在获取数据时会先加锁，确保数据不会被其它线程修改。Java 中，<code>synchronized</code> 和 <code>Lock</code> 的实现类采用的都是悲观锁策略。</p><p>悲观锁适用于并发写入多、竞争激烈的场景。在这些场景下，使用悲观锁可以避免大量无用的反复尝试带来的消耗。</p><h2 id=lock接口><code>Lock</code>接口</h2><p><code>Lock</code> 接口中定义了一组抽象的锁操作。与内置加锁机制不同的是，<code>Lock</code> 提供了一种无条件的、可轮询的、定时的以及可中断的锁获取操作，所有加锁和解锁的方法都是显式的。<code>Lock</code> 接口的定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Lock</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>lockInterruptibly</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryLock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryLock</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> timeout<span style=color:#f92672>,</span> TimeUnit unit<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	Condition <span style=color:#a6e22e>newCondition</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>ReentrantLock</code> 实现了 <code>Lock</code> 接口，并提供了与 <code>synchronized</code> 相同的互斥性和内存可见性。获取 <code>ReentrantLock</code> 的语义与进入同步代码块一致，释放 <code>RenentrantLock</code> 的语义也同退出同步代码块一致。与 <code>synchronized</code> 一样， <code>ReentrantLock</code> 也提供了可重入的加锁语义。但 <code>ReentrantLock</code> 比 <code>synchronized</code> 更加灵活，最典型的就是前者支持非公平和公平的锁获取机制，而后者只支持公平的锁获取机制。</p><p>以下是 <code>Lock</code> 接口的标准使用形式，它比内置锁更复杂，并且必须在 <code>finally</code> 块中释放锁。否则，如果在被保护的代码中抛出了异常，这个锁将无法释放。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>Lock lock <span style=color:#f92672>=</span> <span style=color:#f92672>...;</span>
</span></span><span style=display:flex><span>lock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e>// access the resource protected by this lock
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   lock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=synchronized-vs-lock><code>synchronized</code> vs <code>Lock</code></h2><h3 id=相同点>相同点</h3><p><code>synchronized</code> 与 <code>Lock</code> 有很多相同之处，其中有三点比较明显：</p><ol><li>二者都是用来保证对共享资源的并发访问是线程安全的。</li><li>二者都可以保证可见性。即线程 A 在进入 synchronized 代码块之前或在 synchronized 代码块内进行的操作，对于后续获得同一 monitor 锁的线程 B 来说是可见的；线程 A 在调用 <code>unlock()</code> 之前的所有操作对后续在同一个锁上调用 <code>lock()</code> 的线程 B 来说是可见的。</li><li>二者都是可重入的。</li></ol><h3 id=不同点>不同点</h3><ol><li>前者是 JVM 隐式实现的，而后者是 Java 语言提供的 API。</li><li>前者的锁只能是非公平的，而后者的一些实现可以允许锁是公平的。</li><li><code>synchronized</code> 使用的是 <code>Object</code> 对象的 <code>wait()</code>、<code>notify()</code>、<code>notifyAll()</code> 调度机制，而 <code>Lock</code> 使用的是 <code>Condition</code> 接口的 <code>await()</code>、<code>signal()</code>、<code>signalAll()</code> 完成线程之间的调度。</li><li><code>synchronized</code> 的作用限于同步代码块（包括方法），而 <code>Lock</code> 需要手动给出锁的起始和结束位置。前者的执行是托管给 JVM 的，后者是通过代码手动控制的。</li><li>前者会自动释放锁，而后者需要手动释放锁。</li><li>前者只能以阻塞的方式获得锁，后者可以使用非阻塞的方式去获得锁。</li></ol><p>&mldr;</p><h2 id=abstractqueuedsynchronizeraqs>AbstractQueuedSynchronizer(AQS)</h2><p><code>Lock</code> 接口的实现基本都是通过聚合一个 <code>AbstractQueuedSynchronizer</code> 的子类来完成线程访问控制的。</p><p>**<code>AQS</code>**是一个用于构建锁和同步器的框架，<code>ReentrantLock</code>、<code>Semaphore</code>、<code>CountDownLatch</code>、<code>ReentrantReadWriteLock</code>、<code>SynchronousQueue</code>等都是基于它实现的。</p><p>在基于<code>AQS</code>构建的同步器类中，最基本的操作包括各种形式的获取操作和释放操作。获取操作是一种依赖状态的操作，通常也会阻塞。相反，释放操作并不是一个阻塞操作，当执行释放操作时，所有在请求时被阻塞的线程都会开始执行。</p><p><code>AQS</code>负责管理同步器类中的状态，它用一个int类型的字段 <strong><code>state</code></strong> 来保存状态信息，可以通过<code>getState()</code>、<code>setState()</code>以及<code>CompareAndSetState()</code>等方法来进行操作。<code>state</code>可以表示任意状态。例如：<code>ReentrantLock</code>用它来表示所有者线程已经重复获取该锁的次数；<code>Semaphore</code>用它表示剩余的许可数量；<code>CountDownLatch</code>用它来表示计数器当前的值；<code>ReentrantReadWriteLock</code>用<code>state</code>的高16位表示读状态，也就是获取读锁的次数，低16位表示获取写锁的次数。<u>对于<code>AQS</code>来说，线程同步的关键就是对状态值<code>state</code>进行操作</u>。</p><p><code>AQS</code>是一个FIFO的双向队列，内部通过节点<code>head</code>和<code>tail</code>记录队首和队尾元素，队列元素的类型为<code>Node</code>。</p><h3 id=aqs的实现分析><code>AQS</code>的实现分析</h3><h4 id=同步队列>同步队列</h4><p><code>AQS</code>依赖内部的同步队列（一个FIFO的双向队列）来完成同步状态的管理，当前线程获取同步状态失败时，<code>AQS</code>会将当前线程以及等待状态等信息构成一个节点（<code>Node</code>）并将其加入同步队列，同时阻塞当前线程，当同步状态释放时，会把队首节点中的线程唤醒，使其再次尝试获取同步状态。</p><h5 id=node节点><code>Node</code>节点</h5><p><code>Node</code>节点是构成同步队列的基础，<code>AQS</code>拥有首节点（<code>head</code>）和尾节点（<code>tail</code>）。<code>head</code>节点是获取同步状态成功的节点，它在释放同步状态时，会唤醒后继节点，而被唤醒的后继节点会在获取同步状态成功时将自己设置为<code>head</code>节点。</p><p><code>Node</code>中的<code>thread</code>变量用来记录存放进<code>AQS</code>队列里面的线程。<code>Node</code>节点内部的<code>SHARED</code>用来标记该线程在共享模式阻塞，<code>EXCLUSIVE</code>用来标记线程在互斥模式阻塞。<code>waitStatus</code>记录当前节点的等待状态：</p><ul><li><strong>CANCELLED</strong>：由于在同步队列中等待的线程等待超时或者被中断，需要从同步队列中取消等待，节点进入该状态后将不在变化</li><li><strong>SIGNAL</strong>：后继节点的线程处于等待状态，而当前节点的线程如果释放了同步状态或者被取消，将会通知后继节点，使后继节点的线程得以运行</li><li><strong>CONDITION</strong>：节点在等待队列中，节点线程等待在<code>Condition</code>上，当其它线程调用了<code>Condition</code>的<code>signal()</code>方法后，该节点将会从等待队列移动到同步队列中</li><li><strong>PROPAGATE</strong>：表示下一次共享式同步状态获取将会无条件地被传播下去</li><li><strong>0</strong>：不处于以上任何一个状态
<code>prev</code>表示当前节点的前驱节点（当节点从队尾加入同步队列时被设置），<code>next</code>表示当前节点的后继节点。</li></ul><h4 id=独占式同步状态的获取与释放>独占式同步状态的获取与释放</h4><h5 id=获取锁>获取锁</h5><p>通过调用<code>AQS</code>的<code>acquire(int arg)</code>方法，可以以互斥的形式获取同步状态并忽略中断。<code>acquire(int arg)</code>方法的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>acquire</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> arg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>tryAcquire<span style=color:#f92672>(</span>arg<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        acquireQueued<span style=color:#f92672>(</span>addWaiter<span style=color:#f92672>(</span>Node<span style=color:#f92672>.</span><span style=color:#a6e22e>EXCLUSIVE</span><span style=color:#f92672>),</span> arg<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        selfInterrupt<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这段代码主要完成了获取同步状态、构造节点、加入同步队列以及在同步队列中自旋等待的相关操作。主要逻辑是：首先调用<code>AQS</code>子类自定义的<code>tryAcquire(int arg)</code>方法获取同步状态，若获取失败，则构造同步节点（<code>Node.EXCLUSIVE</code>）并通过<code>addWaiter(Node node)</code>方法将该节点加入到同步队列的队尾，最后调用<code>acquireQueued(Node node, int arg)</code>方法使该节点以自旋的方式获取同步状态（只有前驱节点为头节点时才能够尝试获取同步状态）。如果获取不到则尝试阻塞节点中的线程，被阻塞线程的唤醒主要<u>依靠前驱节点的出队或阻塞线程被中断来实现</u>。<code>acquireQueued()</code>方法源码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>acquireQueued</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Node node<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> arg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> interrupted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Node p <span style=color:#f92672>=</span> node<span style=color:#f92672>.</span><span style=color:#a6e22e>predecessor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> head <span style=color:#f92672>&amp;&amp;</span> tryAcquire<span style=color:#f92672>(</span>arg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            setHead<span style=color:#f92672>(</span>node<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>// help GC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> interrupted<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断获取锁失败后是否阻塞线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>shouldParkAfterFailedAcquire<span style=color:#f92672>(</span>p<span style=color:#f92672>,</span> node<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>            interrupted <span style=color:#f92672>|=</span> parkAndCheckInterrupt<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    cancelAcquire<span style=color:#f92672>(</span>node<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>interrupted<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        selfInterrupt<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> t<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>当获取锁失败后，<code>shouldParkAfterFailedAcquire()</code> 方法会决定是否挂起当前线程，方法的实现如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>shouldParkAfterFailedAcquire</span><span style=color:#f92672>(</span>Node pred<span style=color:#f92672>,</span> Node node<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ws <span style=color:#f92672>=</span> pred<span style=color:#f92672>.</span><span style=color:#a6e22e>waitStatus</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ws <span style=color:#f92672>==</span> Node<span style=color:#f92672>.</span><span style=color:#a6e22e>SIGNAL</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * This node has already set status asking a release
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * to signal it, so it can safely park.
</span></span></span><span style=display:flex><span><span style=color:#75715e>            */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ws <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * Predecessor was cancelled. Skip over predecessors and
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * indicate retry.
</span></span></span><span style=display:flex><span><span style=color:#75715e>            */</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            node<span style=color:#f92672>.</span><span style=color:#a6e22e>prev</span> <span style=color:#f92672>=</span> pred <span style=color:#f92672>=</span> pred<span style=color:#f92672>.</span><span style=color:#a6e22e>prev</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>pred<span style=color:#f92672>.</span><span style=color:#a6e22e>waitStatus</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        pred<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> node<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * waitStatus must be 0 or PROPAGATE.  Indicate that we
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * need a signal, but don&#39;t park yet.  Caller will need to
</span></span></span><span style=display:flex><span><span style=color:#75715e>            * retry to make sure it cannot acquire before parking.
</span></span></span><span style=display:flex><span><span style=color:#75715e>            */</span>
</span></span><span style=display:flex><span>        pred<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSetWaitStatus</span><span style=color:#f92672>(</span>ws<span style=color:#f92672>,</span> Node<span style=color:#f92672>.</span><span style=color:#a6e22e>SIGNAL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从上面的代码中可以看出，线程被挂起的前提条件是：前驱节点的状态为 <code>SIGNAL</code>，<code>SIGNAL</code> 状态的含义是后继节点处于等待状态，当前节点释放锁后将会唤醒后继节点。</p><p>整个加锁的流程到这里就已经走完了，最后的情况是：没有拿到锁的线程会在队列中被挂起，直到拥有锁的线程释放锁之后，才会去唤醒其他的线程去获取锁资源。</p><h5 id=释放锁>释放锁</h5><p>释放同步状态则是通过<code>release(int arg)</code>方法来完成的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>release</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> arg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tryRelease<span style=color:#f92672>(</span>arg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Node h <span style=color:#f92672>=</span> head<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> h<span style=color:#f92672>.</span><span style=color:#a6e22e>waitStatus</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            unparkSuccessor<span style=color:#f92672>(</span>h<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这段代码执行时，会释放同步状态并唤醒后继节点（后继节点成为<code>head</code>节点，继而重新尝试获取同步状态）中的线程，具体唤醒等待线程时通过<code>unparkSuccessor(Node node)</code>方法来完成的，它调用了<code>LockSupport</code>的<code>unpark(Thread thread)</code>方法。</p><h4 id=共享式同步状态获取与释放>共享式同步状态获取与释放</h4><h5 id=获取锁-1>获取锁</h5><p>共享式获取同步状态与独占式获取最主要的区别在于<u>同一时刻是否能有多个线程同时获取到同步状态</u>。通过调用<code>AQS</code>的<code>acquireShared(int arg)</code>方法可以以共享的方式获取同步状态，该方法的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>acquireShared</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> arg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tryAcquireShared<span style=color:#f92672>(</span>arg<span style=color:#f92672>)</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        doAcquireShared<span style=color:#f92672>(</span>arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doAcquireShared</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> arg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Node node <span style=color:#f92672>=</span> addWaiter<span style=color:#f92672>(</span>Node<span style=color:#f92672>.</span><span style=color:#a6e22e>SHARED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> interrupted <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> Node p <span style=color:#f92672>=</span> node<span style=color:#f92672>.</span><span style=color:#a6e22e>predecessor</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>p <span style=color:#f92672>==</span> head<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> r <span style=color:#f92672>=</span> tryAcquireShared<span style=color:#f92672>(</span>arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>r <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    setHeadAndPropagate<span style=color:#f92672>(</span>node<span style=color:#f92672>,</span> r<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    p<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>// help GC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>shouldParkAfterFailedAcquire<span style=color:#f92672>(</span>p<span style=color:#f92672>,</span> node<span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                interrupted <span style=color:#f92672>|=</span> parkAndCheckInterrupt<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable t<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        cancelAcquire<span style=color:#f92672>(</span>node<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> t<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>interrupted<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            selfInterrupt<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在<code>acquireShared(int arg)</code>方法中，调用的<code>tryAcquireShared(int arg)</code>返回值若不小于0，则表示获取同步状态成功。若获取失败，就进入<code>doAcquireShared(int arg)</code>方法自旋，如果当前节点的前驱为<code>head</code>节点，再次尝试获取同步状态，获取成功便退出自旋，否则继续尝试。</p><h5 id=释放锁-1>释放锁</h5><p>同步状态的释放是通过<code>releaseShared(int arg)</code>方法来完成的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>releaseShared</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> arg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tryReleaseShared<span style=color:#f92672>(</span>arg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        doReleaseShared<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doReleaseShared</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Node h <span style=color:#f92672>=</span> head<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> h <span style=color:#f92672>!=</span> tail<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> ws <span style=color:#f92672>=</span> h<span style=color:#f92672>.</span><span style=color:#a6e22e>waitStatus</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ws <span style=color:#f92672>==</span> Node<span style=color:#f92672>.</span><span style=color:#a6e22e>SIGNAL</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>h<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSetWaitStatus</span><span style=color:#f92672>(</span>Node<span style=color:#f92672>.</span><span style=color:#a6e22e>SIGNAL</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>            <span style=color:#75715e>// loop to recheck cases
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                unparkSuccessor<span style=color:#f92672>(</span>h<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ws <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>                     <span style=color:#f92672>!</span>h<span style=color:#f92672>.</span><span style=color:#a6e22e>compareAndSetWaitStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> Node<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPAGATE</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>                <span style=color:#75715e>// loop on failed CAS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>h <span style=color:#f92672>==</span> head<span style=color:#f92672>)</span>                   <span style=color:#75715e>// loop if head changed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>不同于<code>release(int arg)</code>方法，<code>releaseShared(int arg)</code>方法会唤醒后继节点并确保释放操作向后传播。</p><h2 id=reentrantlock>ReentrantLock</h2><p><code>ReentrantLock</code>允许一个线程对资源重复加锁，还支持设置锁的公平性。</p><p><code>synchronized</code>关键字本是是支持重入的（隐式的），而<code>ReentrantLock</code>的重入需要显式进行，即调用<code>lock()</code>方法。</p><h3 id=重入>重入</h3><p><strong>重入</strong>是指任意线程在获取锁之后能够再次获取该锁而不会被锁阻塞。这一特性的实现需要解决以下两个问题：</p><ol><li>线程再次获取同一个锁。这个时候需要锁去识别线程是否为当前拥有锁的线程，如果是，则再次获取成功，完成重入。</li><li>锁的最终释放。需要保证线程重复获取n次锁并释放n次锁之后，其它线程能够获取到该锁。</li></ol><p>重入的一种实现方法是：为每个锁关联一个计数值和一个所有者线程，当计数值为0时，这个锁就被认为不被任何线程持有。当线程请求一个未被持有的锁时，JVM会记下锁的持有者并将计数值设置为1，如果同一个线程再次获取这个锁，计数值就加1，当线程退出同步代码块时，计数值减1。当计数值为0时，这个锁将被释放。</p><h3 id=锁的公平性>锁的公平性</h3><p>在 <code>ReentrantLock</code> 的构造函数中提供了一个 <code>fair</code> 参数，用来指定所创建的锁是否公平，默认创建一个非公平的锁。在公平的锁上，线程将按照它们发出请求的顺序来获得锁，但在非公平的锁上，是允许“插队”的：当一个线程请求非公平的锁时，如果在发出请求的同时该锁的状态变为可用，那么这个线程将跳过队列中的所有等待线程并获得这个锁。</p><p>在激烈竞争的情况下，非公平锁的性能高于公平锁的一个原因是：<strong>在恢复一个被挂起的线程与该线程真正开始运行之间存在着严重的延迟，而使用非公平锁减少了线程上下文切换的次数</strong>。虽然非公平锁带来了更高的性能，但可能导致线程饥饿。</p><p><code>ReentrantLock</code> 默认采用非公平锁：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ReentrantLock</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sync <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NonfairSync<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>如果使用者希望使用基于公平锁的<code>ReentrantLock</code>，可以使用带参数的构造函数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ReentrantLock</span><span style=color:#f92672>(</span><span style=color:#66d9ef>boolean</span> fair<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    sync <span style=color:#f92672>=</span> fair <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> FairSync<span style=color:#f92672>()</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> NonfairSync<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>ReentrantLock</code> 中的 <code>lock()</code> 实现为 <code>sync.acquire(1)</code>。<code>acquire()</code> 方法是 <code>Sync</code> 类从 <code>AbstractQueuedSynchronizer</code> 继承来的，上文中已经提到过其具体实现。<code>tryAcquire()</code> 方法尝试以独占的方式获取锁，如果获取锁失败，则把线程加入到阻塞队列中，下面来看 <code>tryAcquire()</code> 在 <code>FariSync</code> 和 <code>NonfairSync</code> 中的具体实现。<code>FairSync</code> 中的 <code>tryAcquire()</code> 方式实现为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryAcquire</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> acquires<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Thread current <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> getState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>hasQueuedPredecessors<span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>            compareAndSetState<span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> acquires<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            setExclusiveOwnerThread<span style=color:#f92672>(</span>current<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>==</span> getExclusiveOwnerThread<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nextc <span style=color:#f92672>=</span> c <span style=color:#f92672>+</span> acquires<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>nextc <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Maximum lock count exceeded&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        setState<span style=color:#f92672>(</span>nextc<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>而 <code>NonfairSync</code> 中的实现则及其简单：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryAcquire</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> acquires<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> nonfairTryAcquire<span style=color:#f92672>(</span>acquires<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>nonfairTryAcquire()</code> 方法的实现位于抽象类 <code>Sync</code> 中，其具体内容为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>nonfairTryAcquire</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> acquires<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> Thread current <span style=color:#f92672>=</span> Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>currentThread</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> getState<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>c <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>compareAndSetState<span style=color:#f92672>(</span><span style=color:#ae81ff>0</span><span style=color:#f92672>,</span> acquires<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            setExclusiveOwnerThread<span style=color:#f92672>(</span>current<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>current <span style=color:#f92672>==</span> getExclusiveOwnerThread<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> nextc <span style=color:#f92672>=</span> c <span style=color:#f92672>+</span> acquires<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>nextc <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>)</span> <span style=color:#75715e>// overflow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Maximum lock count exceeded&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        setState<span style=color:#f92672>(</span>nextc<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>对比 <code>FairSync</code> 可以发现，<code>FairSync</code> 中的 <code>tryAcquire()</code> 方法仅多了一行：<code>!hasQueuedPredecessors()</code>。<code>hasQueuedPredecessor()</code> 方法用来查看队列中是否有比当前线程等待时间更久的线程，如果没有，就尝试一下是否能获取到锁，如果获取成功，则标记锁为已占用。</p><p>这里有一个特例需要注意，<code>tryLock()</code> 方法不遵守我们设定的公平原则。因为它的源码是这样的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryLock</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> sync<span style=color:#f92672>.</span><span style=color:#a6e22e>nonfairTryAcquire</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>也就是说，即使我们设定锁为公平锁，如果在调用 <code>tryLock()</code> 时锁可用，就能立即获得锁，与前面是否有线程排队无关。</p><h2 id=readwritelock>ReadWriteLock</h2><p><code>ReadWriteLock</code> （读写锁）的接口定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ReadWriteLock</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	Lock <span style=color:#a6e22e>readLock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	Lock <span style=color:#a6e22e>writeLock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>ReadWriteLock</code> 暴露了两个 <code>Lock</code> 对象，其中一个用于读操作，另一个用于写操作。要读取由 <code>ReadWriteLock</code> 保护的数据，必须先获得读锁，当需要修改 <code>ReadWriteLock</code> 保护的数据时，必须先获得写锁。</p><p>在 <code>ReadWriteLock</code> 实现的加锁策略中，允许多个读操作同时进行（多个线程同时持有读锁），但每次只允许一个写操作（每次至多有一个线程持有写锁）。对于读多写少的场景，<code>ReadWriteLock</code> 能够提高性能。</p><p>读写锁的获取规则如下：</p><ul><li>如果一个线程持有读锁，那么其它线程可以继续申请读锁。</li><li>如果一个线程持有读锁，那么此时其它线程必须等待当前线程释放读锁之后才能申请写锁。</li><li>如果一个线程持有写锁，那么此时其它线程必须等待当前线程释放掉写锁之后才能申请读锁或写锁。</li></ul><p>简而言之，读可以并发进行，读写不能同时进行，多个线程不能同时写。</p><h3 id=reentrantreadwritelock>ReentrantReadWriteLock</h3><p><code>ReentrantReadWriteLock</code> 实现了 <code>ReadWriteLock</code> 接口，并加入了一些监控锁内部工作状态的方法。</p><p><code>ReentrantReadWriteLock</code> 的实现依赖于 <code>AQS</code>，由于 <code>AQS</code> 内使用的是一个 <code>int</code> 类型的 <code>state</code> 变量来保存的同步状态，所以 <code>ReentrantReadWriteLock</code> 对 <code>state</code> 变量进行了按位切割，分两部分使用：高16位表示读状态，低16位表示写状态。</p><p><code>ReentrantReadWriteLock</code> 支持锁的降级（写锁到读锁），但不支持锁的升级。</p><h2 id=locksupport>LockSupport</h2><p><code>LockSupport</code>是一个工具类，由<code>UnSafe</code>类实现，主要用来挂起和唤醒线程，它是创建锁和其它同步类的基础。<code>LockSupport</code>会为每个使用它的线程关联一个许可证（permit），在默认情况下调用<code>LockSupport</code>类的方法的线程是不持有许可证的。</p><p>如果调用<code>park()</code>方法的线程已经拿到了与<code>LockSupport</code>关联的许可证，则调用<code>LockSupport.park()</code>时会马上返回，否则调用线程会被禁止参与线程调度，也就是会被阻塞挂起。</p><p>在其它线程调用<code>unpark(Thread thread)</code>方法并将被阻塞线程作为参数时，因调用<code>park()</code>方法而被阻塞的线程会返回。如果其它线程调用了被阻塞线程的<code>interrupt()</code>方法，被阻塞线程也会返回，但不会抛出<code>InterruptedException</code>异常。</p><h2 id=contidion接口><code>Contidion</code>接口</h2><p>在某些情况下，当内置锁过于死板时，可以使用显式锁。正如<code>Lock</code>是一种广义的内置锁一样，<code>Condiiton</code>也是一种广义的内置条件队列。<code>Condition</code>接口的定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Condition</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>await</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>await</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> time<span style=color:#f92672>,</span> TimeUnit unit<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> <span style=color:#a6e22e>awaitNanos</span><span style=color:#f92672>(</span><span style=color:#66d9ef>long</span> nanosTimeout<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>awaitUninterruptibly</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>awaitUntil</span><span style=color:#f92672>(</span>Date deadlines<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>signal</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>signalAll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>一个<code>Condition</code>和一个<code>Lock</code>关联在一起，就像一个条件队列和一个内置锁相关联一样。可以通过<code>Lock.newCondition()</code>方法来创建一个<code>Condition</code>。</p><p>特别注意：在<code>Condition</code>对象中，与<code>wait()</code>、<code>notify()</code>、<code>notifyAll()</code>方法对应的分别是<code>await()</code>、<code>signal()</code>和<code>signalAll()</code>。<code>Condition</code>对<code>Object</code>进行了扩展，因为它也包含<code>wait()</code>和<code>notify()</code>等方法。一定要确保使用正确的版本——<code>await()</code>和<code>signal()</code>。</p><h2 id=参考资料>参考资料</h2><ol><li>Brian Goetz, Tim Peierls, Joshua Bloch, Joseph Bowbeer, David Holmes, and Doug Lea. <em>Java Concurrency in Practice</em>. Addison-Wesley Professional, 2006.</li><li>方腾飞, 魏鹏, 程晓明. Java并发编程的艺术. 机械工业出版社, 2015.</li><li>Martin Fowler. <em>Patterns of Enterprise Application Architecture</em>. Addison-Wesley Professional, 2002.</li></ol></div><hr><aside><h3 class="text-2xl font-black tracking-tight text-primary-500 capitalize dark:text-primary-300 sm:text-2xl">Linked References</h3><div class=backlinks><ul><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/build-microservices-2nd-edition>Build Microservices, 2nd Edition</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/programming-rust-2nd-edition-expressions>Programming Rust, 2nd Edition - Expressions</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/programming-rust-2nd-edition-structs>Programming Rust, 2nd Edition - Structs</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/bash>Bash</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/fundamentals-of-software-architecture>Fundamentals of Software Architecture</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/design-data-intensive-applications>Design Data Intensive Applications</a></p></ul></div></aside><br><aside class=related></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/pages class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p><p class="mt-2 text-base text-center text-gray-400">Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/sawhney17/logseq-schrodinger>logseq-schrodinger</a>.</p></div></footer></body></html>
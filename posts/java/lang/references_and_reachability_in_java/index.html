<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/images/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/images/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/images/favicon/favicon-16x16.png><meta name=theme-color content="#ffffff"><title itemprop=name>Java 中的引用与对象可达性</title><meta property="og:title" content="Java 中的引用与对象可达性"><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta itemprop=name content="Java 中的引用与对象可达性 NZ's Digital Garden"><meta name=application-name content="Java 中的引用与对象可达性 NZ's Digital Garden"><meta name=author content="Nicholas Zhan"><meta name=description content><meta itemprop=description content><meta name=url content="https://zhannicholas.github.io/posts/java/lang/references_and_reachability_in_java/"><link rel=canonical href=https://zhannicholas.github.io itemprop=url><script type=application/ld+json>{"@context":"https://schema.org","@type":"Dentist","name":"NZ\u0027s Digital Garden","description":"","slogan":"","openingHours":"","telephone":"","email":"","vatID":"","url":"https:\/\/zhannicholas.github.io","logo":"https:\/\/zhannicholas.github.io/images/logo_small.png","image":"https:\/\/zhannicholas.github.io/images/logo_full.png","address":{"@type":"PostalAddress","streetAddress":" ","addressLocality":"","addressRegion":"","postalCode":"","addressCountry":""},"geo":{"@type":"GeoCoordinates","latitude":"","longitude":""},"sameAs":[]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/zhannicholas.github.io"},{"@type":"ListItem","position":3,"name":"Posts","item":"https:\/\/zhannicholas.github.io\/posts\/"},{"@type":"ListItem","position":4,"name":"Java","item":"https:\/\/zhannicholas.github.io\/posts\/java\/"},{"@type":"ListItem","position":5,"name":"Lang","item":"https:\/\/zhannicholas.github.io\/posts\/java\/lang\/"},{"@type":"ListItem","position":6,"name":"References and Reachability in Java","item":"https:\/\/zhannicholas.github.io\/posts\/java\/lang\/references_and_reachability_in_java\/"}]}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/main.min.710986944c2e6da1b8df15c5e0c7999affdc4e9ebac27cc9e6df4208f465c990609147ac1865f2be657443a9658b90c9492b300f4990327501d2b36e9be544f8.css" integrity="sha512-cQmGlEwubaG43xXF4MeZmv/cTp66wnzJ5t9CCPRlyZBgkUesGGXyvmV0Q6lli5DJSSswD0mQMnUB0rNum+VE+A==" media=screen><script type=module>
  import Alpine from '/js/alpinejs.js';
  window.Alpine = Alpine;
  Alpine.start();
</script><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(console.log("add dark"),document.documentElement.classList.add("dark")):(console.log("remove dark"),document.documentElement.classList.remove("dark"))</script></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt="'s Digital Garden Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">'s Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts/>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/notes/>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library/>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now/>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about/>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Java 中的引用与对象可达性</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%af%b9%e8%b1%a1%e5%8f%af%e8%be%be%e6%80%a7>对象可达性</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#gc-roots>GC Roots</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%af%b9%e8%b1%a1%e7%9a%84%e4%ba%94%e7%a7%8d%e5%8f%af%e8%be%be%e6%80%a7>对象的五种可达性</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%bc%ba%e5%bc%95%e7%94%a8>强引用</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%bd%af%e5%bc%95%e7%94%a8>软引用</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%bc%b1%e5%bc%95%e7%94%a8>弱引用</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%99%9a%e5%bc%95%e7%94%a8>虚引用</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>JDK 1.2 之后，Java 将引用分为强引用（Strongly Reference）、软引用（Soft Reference）、弱引用（Weak Reference）和虚引用（Phantom Reference）四种，这四种引用的强度依次减弱，它们与 Java 的对象回收有着很大的关系。</p><blockquote><p>A reference object encapsulates a reference to some other object so that the reference itself may be examined and manipulated like any other object. Three types of reference objects are provided, each weaker than the last: soft, weak, and phantom. Each type corresponds to a different level of reachability.</p></blockquote><p>这段话已经描述得很清楚了：Java 中有三种引用对象（reference object），它们封装了一些其它的对象，从而让我们可以像操作其它对象一样操作引用本身，不同引用对象的可达性不同。</p><p>除开与 Finalization 有关的类，下图展示了 <code>java.lang.ref</code> 包中的类结构：</p><p><img src=https://zhannicholas.github.io/images/java/java_lang/reference-class-hierarchy.png alt></p><p><code>Reference</code> 对象用于维持对其它对象的引用，但 GC 仍然可以回收这些被引用的其它对象。当 GC 决定回收某个引用对象关联的对象时，它会将对应的引用对象放入与之关联的引用队列（<code>ReferenceQueue</code>）中，这样我们就可以得到对象被回收的通知了。</p><h2 id=对象可达性>对象可达性</h2><p>在进行垃圾回收之前，第一件事情就是找出垃圾。引用计数算法和可达性分析算法是两种常见的判断垃圾的方法，JVM 是通过分析对象的可达性来判断是否应该将其回收的。堆中的对象是可以相互引用的，根据对象类型的不同，引用的直接表现形式也不同。对于普通对象而言，引用就是对象的字段，而对于数组而言，引用就是数组的元素。此外，还有一些隐藏的引用，例如：每个对象实例都包含一个指向其类型（即实例对应的 Class）的引用，而每个 Class 又包含一个指向加载它的 ClassLoader 的引用。</p><p>我们可以将对象之间的引用关系看作是一张有向图，图中的节点就是对象，而边就是对象间的引用。从源对象出发，若存在一条通往目标对象的路径，则目标对象对源对象来说是可达的，反之目标对象对源对象而言就是不可达的。</p><h3 id=gc-roots>GC Roots</h3><p>可达性分析算法的基本思路是通过一系列被称为“GC Roots”的根对象作为起始节点集，从这些结点开始，根据引用关系向下搜索，搜索路径即为引用链（Reference Chain），如果没有任何路径可以到达 某个对象，则说明这个对象不再被使用，即为垃圾。</p><p><img src=https://zhannicholas.github.io/images/java/java_lang/gc_roots_and_object_reachability.png alt></p><p>在 Java 中，GC Root 是一个可以 <strong>从堆外访问</strong> 的对象，通常包括以下对象：</p><ul><li>JVM 栈中引用的对象，比如线程方法的参数、局部变量、临时变量等；</li><li>方法区中静态属性引用的对象，比如 Java 类的引用类型的静态变量；</li><li>方法区中常量引用的对象，比如字符串常量池中的引用；</li><li>Native 方法栈中 JNI 引用的对象；</li><li>JVM 内部的引用，比如基本数据类型对应的 Class 对象、一些常驻的异常对象（NullPointerException、OutOfMemeryError 等）、系统类加载器；</li><li>所有被同步锁（synchronized）持有的对象；</li><li>反映 JVM 内部情况的 JMXBean、JVMTI 中注册的回调、Native 代码缓存等；</li></ul><p>Eclipse 的内存分析工具列举出了各种具体的 <a href="https://help.eclipse.org/2021-03/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Fconcepts%2Fgcroots.html" target=_blank>GC Root</a>
，感兴趣的同学可以进一步了解。</p><h3 id=对象的五种可达性>对象的五种可达性</h3><p>Java 中的对象可达性有五种不同的程度：强可达（strongly reachable）、软可达（softly reachable）、弱可达（weakly reachable）、虚可达（phantom reachable）和不可达（unreachable）。以下关于可达性的描述，取自 <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/package-summary.html#reachability target=_blank>java.lang.ref</a>
包的文档：</p><blockquote><p>Going from strongest to weakest, the different levels of reachability reflect the life cycle of an object. They are operationally defined as follows:</p><ul><li><p>An object is strongly reachable if it can be reached by some thread without traversing any reference objects. A newly-created object is strongly reachable by the thread that created it.</p></li><li><p>An object is softly reachable if it is not strongly reachable but can be reached by traversing a soft reference.</p></li><li><p>An object is weakly reachable if it is neither strongly nor softly reachable but can be reached by traversing a weak reference. When the weak references to a weakly-reachable object are cleared, the object becomes eligible for finalization.</p></li><li><p>An object is phantom reachable if it is neither strongly, softly, nor weakly reachable, it has been finalized, and some phantom reference refers to it.</p></li><li><p>Finally, an object is unreachable, and therefore eligible for reclamation, when it is not reachable in any of the above ways.</p></li></ul></blockquote><h2 id=强引用>强引用</h2><p>强引用指程序代码中普遍存在的引用赋值（比如<code>Object strongReference = new Object()</code>这种关系）。在任何情况下，只要强引用的关系还在，垃圾收集器就不会回收被引用的对象。当内存不足时，JVM 宁愿抛出 <code>OutOfMemorryError</code>，也不会回收具有强引用的对象。当一个强引用对象不再使用时，若要让 GC 回收它，我们需要让它变得不可达（实际上，GC 也只回收不可达对象）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Object strongReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>  <span style=color:#75715e>// 强引用
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    strongReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>//  对象可以被 GC 回收了
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在上面这段代码中，<code>new Object()</code> 会在堆中创建一个对象，而指向这个对象的是栈中的引用 <code>strongReference</code>。当方法调用完成，方法栈退出，<code>strongReference</code> 不复存在，这个对象就可以被回收了。若 <code>strongReference</code> 是全局变量，则需要手动将其设置为 <code>null</code>，去除其对对象的引用，对象才能被回收。</p><h2 id=软引用>软引用</h2><p>被软引用关联对象即软可达对象，它们是一些还有用但非必须的对象，在系统将要发生内存溢出之前，会被二次回收，如果这次回收之后的内存依然不够，JVM 才会抛出 OutOfMemoryError。<strong>JVM 保证在抛出 OutOfMemoryError 之前回收所有被软引用关联的软可达对象</strong>。JDK 1.2 之后提供了 <code>SoftReference</code> 类来表示软引用。</p><blockquote><p>Soft references are most often used to implement memory-sensitive caches.</p></blockquote><p>创建软引用对象的方法有两种。</p><p>第一种是创建不与任何引用队列关联的软引用对象：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object referent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>SoftReference<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> softReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SoftReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>我们也可以使用带 <code>ReferenceQueue</code> 的构造函数，如果软引用所引用的对象被回收，JVM 就会自动将这个软引用加入到与之关联的引用队列中：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ReferenceQueue<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> referenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>SoftReference<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> softReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SoftReference<span style=color:#f92672>&lt;&gt;(</span>obj<span style=color:#f92672>,</span> referenceQueue<span style=color:#f92672>);</span>
</span></span></code></pre></div><p><code>Reference</code> 类提供的 <code>get</code> 和 <code>clear</code> 方法分别可以用来获取和重置对应的引用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object referent <span style=color:#f92672>=</span> softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>Object referent2 <span style=color:#f92672>=</span> softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>  <span style=color:#75715e>// null
</span></span></span></code></pre></div><p>实际上，由于对象可能被 GC 回收，所以在进行下一步操作时，我们需要对 <code>get</code> 方法返回的 referent 进行检查：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object referent <span style=color:#f92672>=</span> softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>referent <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 对象还没有被 GC 回收
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 用作缓存时，可直接返回对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 对象已经被 GC 回收
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 用作缓存时，需要重新实例化引用对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=弱引用>弱引用</h2><p>被弱引用关联的对象即弱可达对象，它描述的也是非必须对象，其强度比软引用更弱。被弱引用关联的对象，只能生存到下一次垃圾回收。当垃圾收集器开始工作，无论当前内存是否不足，都会回收掉被弱引用关联的对象。JDK 1.2 之后提供了 <code>WeakReference</code> 类来表示弱引用。</p><p>弱引用与软引用之间最大的区别在于：被弱引用指向的对象只在两次 GC 之间存活，而被软引用指向的对象在 JVM 内存紧张的时候才被回收，它是可以经历多次 GC 的。</p><blockquote><p>Weak references are most often used to implement canonicalizing mappings.</p></blockquote><p>创建弱引用对象的方法也有两种，不关联任何引用队列的和关联引用队列的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object referent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>ReferenceQueue referenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WeakReference weakReference1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WeakReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>WeakReference weakReference2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WeakReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>,</span> referenceQueue<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>弱引用的其它使用与软引用类似，不再赘述。</p><p>JDK 提供了一个基于弱引用实现的 <code>HashMap</code> 集合—— <code>WeakHashMap</code>，其中的 <code>Entry</code> 继承了 <code>WeakReference</code>，<code>Entry</code> 中使用弱引用指向 Key，使用强引用指向 Value。当没有强引用指向 Key 的时候，Key 可以被 GC 回收。当再次操作 <code>WeakHashMap</code> 的时候，就会遍历关联的引用队列，从 <code>WeakHashMap</code> 中清理掉相应的 <code>Entry</code>。</p><h2 id=虚引用>虚引用</h2><p>虚引用是最弱的一种引用关系，又称“幽灵引用”或“幻影引用”。一个对象是否有虚引用，完全不会对其生存时间构成影响，也无法通过虚引用来获取一个对象的实例。JDK 1.2 之后提供了 <code>PhantomReference</code> 类来表示虚引用。虚引用主要用来跟踪对象被 GC 回收的活动。 虚引用与软引用和弱引用的一个区别在于：虚引用必须和引用队列一起使用。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的内存之前，把这个虚引用加入到与之关联的引用队列中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Object referent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>ReferenceQueue referenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 创建虚引用时，必须和一个引用队列相关联
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>PhantomReference phantomReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PhantomReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>,</span> referenceQueue<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>弱引用的其它使用与软引用类似，不再赘述。</p><h2 id=参考资料>参考资料</h2><ol><li>周志明. 深入理解Java虚拟机（第3版）. 机械工业出版社, 2019.</li><li><a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/package-summary.html target=_blank>Package java.lang.ref</a>
.</li></ol></div></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200) ? true : false"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts/ class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes/ class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library/ class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer><script type=text/javascript src=https://zhannicholas.github.io/js/app.min.5ce6717c9c557de80f2d726a4693ef2581084ac7685dfb48c6a73140cf8a6bbd5bd8f76b0dbfe285737c83b968be59d2db22198e4e39d5b0bc42e7571630c4b1.js integrity="sha512-XOZxfJxVfegPLXJqRpPvJYEISsdoXftIxqcxQM+Ka71b2PdrDb/ihXN8g7lovlnS2yIZjk451bC8QudXFjDEsQ=="></script></body></html>
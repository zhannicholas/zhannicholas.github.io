<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/images/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/images/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/images/favicon/favicon-16x16.png><meta name=theme-color content="#ffffff"><title itemprop=name>HotSpot引擎架构</title><meta property="og:title" content="HotSpot引擎架构"><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta itemprop=name content="HotSpot引擎架构 NZ's Digital Garden"><meta name=application-name content="HotSpot引擎架构 NZ's Digital Garden"><meta name=author content="Nicholas Zhan"><meta name=description content><meta itemprop=description content><meta name=url content="https://zhannicholas.github.io/posts/java/jvm/hotspot_engine_architecture/"><link rel=canonical href=https://zhannicholas.github.io itemprop=url><script type=application/ld+json>{"@context":"https://schema.org","@type":"Dentist","name":"NZ\u0027s Digital Garden","description":"","slogan":"","openingHours":"","telephone":"","email":"","vatID":"","url":"https:\/\/zhannicholas.github.io","logo":"https:\/\/zhannicholas.github.io/images/logo_small.png","image":"https:\/\/zhannicholas.github.io/images/logo_full.png","address":{"@type":"PostalAddress","streetAddress":" ","addressLocality":"","addressRegion":"","postalCode":"","addressCountry":""},"geo":{"@type":"GeoCoordinates","latitude":"","longitude":""},"sameAs":[]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/zhannicholas.github.io"},{"@type":"ListItem","position":3,"name":"Posts","item":"https:\/\/zhannicholas.github.io\/posts\/"},{"@type":"ListItem","position":4,"name":"Java","item":"https:\/\/zhannicholas.github.io\/posts\/java\/"},{"@type":"ListItem","position":5,"name":"Jvm","item":"https:\/\/zhannicholas.github.io\/posts\/java\/jvm\/"},{"@type":"ListItem","position":6,"name":"Hotspot Engine Architecture","item":"https:\/\/zhannicholas.github.io\/posts\/java\/jvm\/hotspot_engine_architecture\/"}]}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/main.min.710986944c2e6da1b8df15c5e0c7999affdc4e9ebac27cc9e6df4208f465c990609147ac1865f2be657443a9658b90c9492b300f4990327501d2b36e9be544f8.css" integrity="sha512-cQmGlEwubaG43xXF4MeZmv/cTp66wnzJ5t9CCPRlyZBgkUesGGXyvmV0Q6lli5DJSSswD0mQMnUB0rNum+VE+A==" media=screen><script type=module>
  import Alpine from '/js/alpinejs.js';
  window.Alpine = Alpine;
  Alpine.start();
</script><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(console.log("add dark"),document.documentElement.classList.add("dark")):(console.log("remove dark"),document.documentElement.classList.remove("dark"))</script></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt="'s Digital Garden Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">'s Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts/>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/notes/>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library/>Library</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/til/>Today I Learned</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now/>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about/>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">HotSpot引擎架构</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#hotspot-vm%e6%9e%b6%e6%9e%84>HotSpot VM架构</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%86%85%e5%ad%98%e6%a8%a1%e5%9e%8bmemory-model>内存模型（Memory Model）</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%af%b9%e8%b1%a1%e7%9a%84%e8%ae%bf%e9%97%ae%e5%ae%9a%e4%bd%8d>对象的访问定位</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b8%a4%e5%ad%97two-word%e7%9a%84%e5%af%b9%e8%b1%a1%e5%a4%b4>两字（Two-Word）的对象头</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%bb%a5%e5%af%b9%e8%b1%a1%e8%a1%a8%e7%a4%ba%e7%9a%84%e5%8f%8d%e5%b0%84%e6%95%b0%e6%8d%ae>以对象表示的反射数据</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%94%af%e6%8c%81%e5%8e%9f%e7%94%9f%e7%ba%bf%e7%a8%8b>支持原生线程</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%9e%83%e5%9c%be%e6%94%b6%e9%9b%86garbage-collection>垃圾收集（Garbage Collection）</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%87%86%e7%a1%ae%e6%80%a7>准确性</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%88%86%e4%bb%a3%e5%a4%8d%e5%88%b6%e6%94%b6%e9%9b%86generational-copying-collection>分代复制收集（Generational Copying Collection）</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e8%a1%8c%e5%b9%b4%e8%bd%bb%e4%bb%a3%e6%94%b6%e9%9b%86%e5%99%a8parallel-young-generation-collector>并行年轻代收集器（Parallel Young Generation Collector）</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%a0%87%e8%ae%b0-%e6%95%b4%e7%90%86%e6%94%b6%e9%9b%86%e5%99%a8mark-compact-collector>标记-整理收集器（Mark-Compact Collector）</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e5%8f%91%e6%a0%87%e8%ae%b0-%e6%b8%85%e9%99%a4%e6%94%b6%e9%9b%86%e5%99%a8concurrent-mark-sweep-collector>并发标记-清除收集器（Concurrent Mark-Sweep Collector）</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e8%a1%8c%e5%b9%b4%e8%80%81%e4%bb%a3%e6%94%b6%e9%9b%86%e5%99%a8parallel-old-generation-collector>并行年老代收集器（Parallel Old Generation Collector）</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%b6%85%e5%bf%ab%e7%9a%84ultra-fast%e7%9a%84%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5>超快的（Ultra-Fast）的线程同步</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#64-%e4%bd%8d%e6%9e%b6%e6%9e%84>64 位架构</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#hotspot-%e7%bc%96%e8%af%91%e5%99%a8>HotSpot 编译器</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%83%ad%e7%82%b9%e6%a3%80%e6%b5%8bhot-spot-detection>热点检测（Hot Spot Detection）</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%96%b9%e6%b3%95%e5%86%85%e8%81%94method-inlining>方法内联（Method Inlining）</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8a%a8%e6%80%81%e5%8e%bb%e4%bc%98%e5%8c%96dynamic-deoptimization>动态去优化（Dynamic Deoptimization）</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><blockquote><p>这篇笔记主要来自于<a href=https://www.oracle.com/technetwork/java/whitepaper-135217.html target=_blank>The Java HotSpot Performance Engine Architecture</a>
，感觉主要是在讲 JDK8中 HotSpot VM 的整体架构。</p></blockquote><p>Java HotSpot VM 原来是 Sun 公司为 Java 平台实现的高性能虚拟机，是 Java SE 的基础组成部分。为了使 Java 应用达到达到最佳的性能，HotSpot 采用了很多高级技术，包括先进的内存模式、垃圾收集器和自适应优化器。</p><h2 id=hotspot-vm架构>HotSpot VM架构</h2><h3 id=内存模型memory-model>内存模型（Memory Model）</h3><h4 id=对象的访问定位>对象的访问定位</h4><p>Java 程序通过栈上的引用（reference）操作堆上的具体对象。在早期 JVM 中，比如 Classic VM，对象的访问定位是通过 <strong>间接句柄（indirect handle）</strong> 实现的。由于引用中存放的是句柄的地址，所以在对象被移动时，只需要改变句柄中到对象实例数据的指针即可。这一点虽然可以简化垃圾回收过程中对象的重定位过程，但却成为了性能瓶颈，因为在 Java 中通过句柄访问实例变量需要进行 <strong>两次</strong> 间接访问。</p><p>在 HotSopt VM 中，对象的访问定位是通过 <strong>直接指针（direct pointers）</strong> 来实现的，只需要 <strong>一次</strong> 访问就可以获取到实例变量。当对象在内存回收过程中被移动时，垃圾收集器需要负责找到并更新所有到该对象的引用。</p><h4 id=两字two-word的对象头>两字（Two-Word）的对象头</h4><p>HotSpot VM 中的对象头大小为两个机器字，而 Classic VM 中的对象头为三个字。通常，Java 对象都很小，所以对象头的大小对空间消耗的影响还是很大的。对象头的第一个字（mark word）包含了 hashCode 和 GC 的状态等信息，而第二个字（kclass pointer）是一个指向对象所属类（class）的指针。只有数组对象的对象头中有第三个部分——这一部分记录了数组的大小。</p><h4 id=以对象表示的反射数据>以对象表示的反射数据</h4><p>类、方法和其它内部反射数据都直接被表示成堆上的对象。这既简化了 VM 内部的对象模型，也允许类被为其它对象设计的垃圾回收器回收。</p><h4 id=支持原生线程>支持原生线程</h4><p>每个线程的方法活动栈都是使用宿主操作系统的栈和线程模型表示的。Java 方法和原生方法使用的是同样的栈，因此 C 和 Java 之间的调用更快。通过使用操作系统的线程调度机制，Java 线程是完全可抢占的。使用原生操作系统线程和调度机制的一个主要优点就是可以透明地利用原操作系统的多处理机制。</p><h3 id=垃圾收集garbage-collection>垃圾收集（Garbage Collection）</h3><p>HotSpot VM 的内存系统是分代的，这为不同应用场景下选择不同垃圾收集器提供了极大的灵活性。为了满足不同的停顿时间和吞吐量要求，HotSpot 支持选择不同的垃圾回收算法。</p><h4 id=准确性>准确性</h4><p>HotSpot 垃圾收集器是一个完全准确的垃圾收集器。相反，很多其它的垃圾收集器都是保守的（conservative）或部分准确的。保守式垃圾回收吸引人的一点在于，它可以很容易地被添加到不支持垃圾收集的系统中，但它容易出现内存泄漏，还可能导致堆上碎片。</p><p>保守式收集器并不确切的知道所有对象引用的位置。因此，它必须假设一个可能引用某个对象的内存字就真的是对象引用。这意味着它可能会犯一些错误，例如：当一个整数当作是一个对象指针。看起来像指针的内存单元被认为是真的指针，GC 就变得不准确了。这会带来一些负面影响：第一，可能发生无法复现或调试的内存泄漏。第二，因为保守式收集器可能犯错，因此它必须这么做：要么使用句柄来间接引用对象（这降低了性能），要么避免移动对象（因为移动对象需要更新所有在该对象上的引用，这在收集器不能确切知道一个表面上的引用是否是真的引用的情况下是无法做到的）。由于缺乏移动对象的能力，保守式收集器可能导致内存碎片，也无法使用一些高级的分代复制收集算法。</p><h4 id=分代复制收集generational-copying-collection>分代复制收集（Generational Copying Collection）</h4><p>分代垃圾收集器利用了一个事实：在大多数程序中，绝大多数（通常超过95%）对象的存活时间都非常短。通过将新生对象放置在一个单独的空间里，分代收集器可以实现：</p><ol><li>因为新生对象的空间是连续分配在一个单独的空间里的，分配速度是非常快的，因为这只需要更新一个指针并做一次该空间是否用尽的检查。</li><li>在该空间用尽之前，其中的大多数对象都已经死亡了。这个时候收集器只需要简单地将少数存活的对象移动到其它地方，不再需要为该空间内的死亡对象做其它回收操作。</li></ol><h4 id=并行年轻代收集器parallel-young-generation-collector>并行年轻代收集器（Parallel Young Generation Collector）</h4><p>上面描述的单线程复制收集器适用于很多场合，但它会成为并发程序中的瓶颈。为了充分利用多处理器上的多个 CPU，HotSpot VM 还为年轻代提供了一个可选的多线程收集器，其中使用了多个并行工作的线程来完成存活对象的追踪和复制。这减少了收集年轻代空间的暂停时间，并最大化了垃圾收集的吞吐量。</p><p>当移动对象时，并行收集器努力使相关对象在一起，从而提高内存的局部性以及缓存的利用率，并提高了分配器的性能。这是通过采用 <strong>深度优先的顺序</strong> 复制对象来实现的。</p><h4 id=标记-整理收集器mark-compact-collector>标记-整理收集器（Mark-Compact Collector）</h4><p>尽管分代复制回收器可以高效地收集大多数死亡对象，但长期存活的对象仍然在年老对象区域聚集。有时候，由于可用内存过低或者显式要求，年老对象上的垃圾收集必须进行。HotSpot VM 默认使用标准的标记-整理回收算法来进行年老对象区域的垃圾收集，算法从 <strong>RC Roots</strong> 开始遍历整个存活对象图，然后进行清理，整理死亡对象留下的空隙。通过压实堆中的空隙而不是将它们收集到空闲链表中，可以避免内存碎片。</p><h4 id=并发标记-清除收集器concurrent-mark-sweep-collector>并发标记-清除收集器（Concurrent Mark-Sweep Collector）</h4><p>对于那些使用大量堆空间的应用，默认的年老代标记-整理收集器可能引起程序中断，因为应用线程被暂停的时间和堆的大小成比例。在应用线程被暂停的非常短暂的时间内，HotSpot VM 为年老对象空间实现了一个可以利用处理器的空闲时钟周期（或空闲处理器）来收集大堆的并发收集器。当应用线程执行时，收集器会进行追踪和清理工作。有时，这会降低应用的最大吞吐量，因为一些处理器的时钟周期被用来进行并发收集。然而，在平均和最坏的情况下，垃圾收集的暂停次数通常降低了1~2个数量级，这使应用的响应时间变得更加的平滑，不会出现默认的同步标记-整理算法在大堆上可能发生的突发。</p><h4 id=并行年老代收集器parallel-old-generation-collector>并行年老代收集器（Parallel Old Generation Collector）</h4><p>为了提高占用那些使用巨大堆空间应用的可扩展性，HotSpot VM 为年老代实现了一个并行的标记-整理收集器。CMS 收集器主要关注的是如何降低暂停时间，而并行年老代收集器关注的是如何在暂停整个应用（stop-the-world）的情况下同时使用多个线程以提高吞吐量。</p><h3 id=超快的ultra-fast的线程同步>超快的（Ultra-Fast）的线程同步</h3><p>Java 提供了语言级别的线程同步，使得它能够非常容易地用细粒度锁来表达多线程程序。而 Classic VM 等早期 JVM 中，同步的实现和其它操作比起来非常低效，细粒度同步因此成了主要的性能瓶颈。</p><p>HotSpot VM 采用自适应自旋技术实现竞争性同步，采用超快的常量时间技术实现非竞争性同步，极大的提升了同步性能。</p><h3 id=64-位架构>64 位架构</h3><p>早期的 HotSpot VM 的寻址空间被限制为 4GB 内存，即使在 64 位操作系统中也是这样。而在 64 位的 JVM 中，Java 程序可以使用所有的内存。</p><h2 id=hotspot-编译器>HotSpot 编译器</h2><p>为了提升程序的性能，很多为传统语言开发的编译技术也被应用到了 Java 中。JIT（just-in-time）编译器将 Java 字节码迅速翻译成机器码。然而，JIT编译存在一些问题：</p><ol><li>由于编译器在用户时间内运行，它的编译速度非常重要：如果它不是非常快，用户会在启动程序时察觉到明显的延迟。因为高级优化通常会显著减慢编译速度，所以进行高级优化非常困难。</li><li>即使 JIT 有时间进行所有的优化，Java 也还是没有 C 或 C++ 那样高效。原因有很多：<ul><li>Java 是动态安全的，这意味着 Java 程序不会违反语言的语义，也不会直接访问任意内存。因此，Java 中的动态类型检查必须非常频繁的执行。</li><li>Java 在堆上分配所有对象，而 C++ 中的多数对象是在栈上分配的。这意味着对象的分配速度在 Java 中比在 C++ 中更高。此外，Java 支持自动垃圾收集，它和 C++ 的内存分配开销（包括潜在的清除写屏障的开销）截然不同。</li><li>Java 中的大多数方法调用都是虚的（virtual），并且比 C++ 更加频繁。这不仅意味着方法调用性能更显著，还意味着堆方法调用进行静态编译优化更加困难。</li><li>由于支持类的动态加载，Java 程序可以迅速被改变。这使得一些全局优化难以进行。</li></ul></li></ol><p>为了解决Java语言的性能问题，HotSpot 采用了自适应优化技术。</p><h3 id=热点检测hot-spot-detection>热点检测（Hot Spot Detection）</h3><p>几乎所有的程序都将绝大部分执行时间花在了执行少数代码上。基于这一点，自适应优化技术解决了 JIT 编译中的问题。与其逐方法进行即时编译，HotSpot VM 使用解释器立即运行程序，并分析执行的代码以检测热点代码片段。然后，专心使用全局原生代码编译器编译热点代码。通过避免编译不常执行的代码，HotSpot 编译器可以更加重视程序中的对性能至关重要的部分，而不必增加全部的编译时间。</p><h3 id=方法内联method-inlining>方法内联（Method Inlining）</h3><p>Java 中虚方法调用的频率是一个重要的优化瓶颈。HotSpot 的自适应优化器一旦收集到了热点代码的信息，它不仅会把热点代码编译成原生代码，还会在其上进行大量的方法内联。</p><p>内联可以降低方法调用的动态频率，这就节省了相关方法调用的时间。更重要的是，内联会为优化器提供更大的代码块，是传统编译器优化更加高效。</p><h3 id=动态去优化dynamic-deoptimization>动态去优化（Dynamic Deoptimization）</h3><p>内联基于某种形式全局分析，而动态加载是与之冲突的，因为动态加载会改变程序中的全局关系。因此，HotSpot VM 必须能够动态的反优化之前已优化的热点代码。</p><h2 id=参考资料>参考资料</h2><ol><li><a href=https://www.oracle.com/technetwork/java/whitepaper-135217.html target=_blank>The Java HotSpot Performance Engine Architecture</a>
.</li></ol></div></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200) ? true : false"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts/ class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes/ class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library/ class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer><script type=text/javascript src=https://zhannicholas.github.io/js/app.min.5ce6717c9c557de80f2d726a4693ef2581084ac7685dfb48c6a73140cf8a6bbd5bd8f76b0dbfe285737c83b968be59d2db22198e4e39d5b0bc42e7571630c4b1.js integrity="sha512-XOZxfJxVfegPLXJqRpPvJYEISsdoXftIxqcxQM+Ka71b2PdrDb/ihXN8g7lovlnS2yIZjk451bC8QudXFjDEsQ=="></script></body></html>
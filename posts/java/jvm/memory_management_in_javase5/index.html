<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>HotSpot VM中的内存管理(J2SE 5.0) |</title><meta name=description content><meta property="og:title" content="HotSpot VM中的内存管理(J2SE 5.0) | "><meta name=twitter:title content="HotSpot VM中的内存管理(J2SE 5.0) | "><meta itemprop=name content="HotSpot VM中的内存管理(J2SE 5.0) | "><meta name=application-name content="HotSpot VM中的内存管理(J2SE 5.0) | "><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:site_name" content><meta property="og:url" content="https://zhannicholas.github.io/posts/java/jvm/memory_management_in_javase5/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.70a967cc78af9ec5b1e1b5c3552172a911554a27d8e5bdf52000296bdd439d2a.css" integrity="sha256-cKlnzHivnsWx4bXDVSFyqRFVSifY5b31IAApa91DnSo="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt=" Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60"></div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">HotSpot VM中的内存管理(J2SE 5.0)</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%98%be%e5%bc%8f%e5%86%85%e5%ad%98%e9%87%8a%e6%94%be-vs-%e8%87%aa%e5%8a%a8%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86>显式内存释放 vs 自动内存管理</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8a%a8%e6%80%81%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d>动态内存分配</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%98%be%e5%bc%8f%e5%86%85%e5%ad%98%e9%87%8a%e6%94%be>显式内存释放</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%87%aa%e5%8a%a8%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86>自动内存管理</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%bb%80%e4%b9%88%e6%98%af%e5%9e%83%e5%9c%be%e6%94%b6%e9%9b%86>什么是垃圾收集</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%9e%83%e5%9c%be%e6%94%b6%e9%9b%86%e5%99%a8%e7%9a%84%e7%89%b9%e7%82%b9>垃圾收集器的特点</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%ae%be%e8%ae%a1%e9%80%89%e6%8b%a9>设计选择</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%80%a7%e8%83%bd%e6%8c%87%e6%a0%87>性能指标</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%88%86%e4%bb%a3%e6%94%b6%e9%9b%86>分代收集</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#j2ee-50-hotspot-jvm%e4%b8%ad%e7%9a%84%e5%9e%83%e5%9c%be%e6%94%b6%e9%9b%86%e5%99%a8>J2EE 5.0 HotSpot JVM中的垃圾收集器</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#hotspot-%e4%b8%ad%e7%9a%84%e5%88%86%e4%bb%a3>HotSpot 中的分代</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%9e%83%e5%9c%be%e6%94%b6%e9%9b%86%e7%9a%84%e7%a7%8d%e7%b1%bb>垃圾收集的种类</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%bf%ab%e9%80%9f%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d>快速内存分配</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%a1%ba%e5%ba%8f%e5%88%86%e9%85%8d>顺序分配</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#tlab>TLAB</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b8%b2%e8%a1%8c%e6%94%b6%e9%9b%86%e5%99%a8>串行收集器</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b4%e8%bd%bb%e4%bb%a3%e4%b8%8a%e7%9a%84%e4%b8%b2%e8%a1%8c%e6%94%b6%e9%9b%86%e5%99%a8>年轻代上的串行收集器</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b4%e8%80%81%e4%bb%a3%e4%b8%8a%e7%9a%84%e4%b8%b2%e8%a1%8c%e6%94%b6%e9%9b%86%e5%99%a8>年老代上的串行收集器</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e8%a1%8c%e6%94%b6%e9%9b%86%e5%99%a8>并行收集器</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e8%a1%8c%e6%95%b4%e7%90%86%e6%94%b6%e9%9b%86%e5%99%a8>并行整理收集器</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%b9%b6%e5%8f%91%e6%a0%87%e8%ae%b0%e6%b8%85%e9%99%a4%e6%94%b6%e9%9b%86%e5%99%a8>并发标记清除收集器</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><blockquote><p>这篇笔记的主要内容来自<a href=https://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf target=_blank>Memory Management in the Java HotSpot VM</a>
。其主要讲的是J2SE 5.0中HotSpot VM的内存管理，文章中描述了J2SE5.0中的垃圾收集器，并在如何选择和配置垃圾收集器、设置被管理内存的区域大小等方面提出了一些建议。</p></blockquote><p>内存管理系统需要考虑以下三个方面：</p><ol><li>如何分配内存。</li><li>如何识别存活对象。</li><li>如何回收死亡对象占据的空间，以便将来使用。</li></ol><h2 id=显式内存释放-vs-自动内存管理>显式内存释放 vs 自动内存管理</h2><h3 id=动态内存分配>动态内存分配</h3><p>几乎所有的现代编程语言都采用<strong>动态内存分配(dynamic momory allocation)</strong>，即允许进程在运行时分配或释放那些无法在编译期间确定大小的对象，并且对象的存活时间可以超过创建它们的子程序的存活时间。动态分配的对象并不位于于栈(分配对象的程序的 <em>活动记录（activation record）</em> 或 <em>栈帧（stack frame）</em> )上，也没有被静态储存（对象的名字被绑定到编译或链接期间所确定的存储位置），而是位于堆（heap）中。在堆中分配对象有一些好处，它允许程序员：</p><ul><li>动态选择新对象的大小，从而避免程序运行中出现因硬编码而出现的一些错误。</li><li>定义和使用像 list、tree、map 这样的递归数据结构。</li><li>将新创建的对象返回给父程序。例如工厂方法。</li><li>将函数作为另一个函数的返回结果。例如一些函数式编程语言中的 <em>closure</em> 和 <em>suspension</em>。</li></ul><p>堆中分配的对象是通过 <strong>引用(reference)</strong> 来访问的。通常，引用是一个指向对象的指针，即对象在内存中的地址。然而，引用也可能间接地指向对象，例如引用指向 <strong>句柄(handle)</strong>，句柄再指向对象。句柄的优点是：在对象被移动时，只需要更新句柄中到对象的指针，而不需要更新程序中所有其它对该对象(或句柄)的引用。</p><h3 id=显式内存释放>显式内存释放</h3><p>在一些编程语言里，程序员需要手动管理内存。手动管理内存一件非常复杂的工作，并可能出现很多错误，这些错误可能导致程序异常甚至崩溃。因此，绝大部分开发时间都被用在了调试并尝试解决这些问题上。手动回收可能会出现以下两个问题：</p><ol><li><strong>悬挂指针(dangling pointer)</strong>。当一个对象还被其它对象引用时，若该对象占用的内存被回收，那些指向它的引用就会称为悬挂指针。悬挂指针一旦出现，程序的行为就会变得不可预测。因为，当尝试通过悬挂指针访问原对象时，被引用的内存空间可能早已分配给其它对象。</li><li><strong>内存泄漏(memory leak)</strong>。例如，为了释放一个单链表所占用的内存空间，我们需要回收链表中的所有节点，若只回收了头节点，其它节点就无法再被访问，它们占据的内存空间也就无法被回收。内存泄漏会不断的消耗可用内存，直至内存枯竭。</li></ol><h3 id=自动内存管理>自动内存管理</h3><p>自动化内存管理解决了显式内存管理中的很多问题。<strong>垃圾收集器(Garbage Collector, GC)</strong> 防止可以防止悬挂指针的出现，因为只有当一个对象不被任何其它对象引用时，这个对象才能被回收。原则上讲，GC会回收所有不可达对象，但有两点需要注意：</p><ol><li><em>追踪式回收(tracing collection)</em> 引入了“垃圾”这一定义明确的概念，但“垃圾”并不一定包括所有不再被使用的对象。</li><li>出于效率原因，某些对象可能不会被回收。</li></ol><p>GC还解决了内存泄漏的问题，因为它会自动释放所有不再被引用的对象。</p><h2 id=什么是垃圾收集>什么是垃圾收集</h2><p>简而言之，垃圾收集器负责：</p><ol><li>为新生对象分配内存。</li><li>保证不回收被引用的对象。</li><li>回收那些不再可达对象的所占据内存空间。</li></ol><p>垃圾收集是指发现垃圾并回收的这一过程。那么何时会发生垃圾收集呢，这要看使用何种垃圾收集器(或垃圾收集算法)了。通常情况下，当堆或堆的一部分已满，或已分配的空间超过了某个阈值时，就会进行垃圾收集。</p><h3 id=垃圾收集器的特点>垃圾收集器的特点</h3><p>一个理想的垃圾收集器应该具备以下特点：</p><ol><li>既 <strong>安全（safe）</strong>，又 <strong>完善（comprehensive）</strong>。也就是说，存活对象不能被错误的回收，并且一个垃圾不应该在经过几轮回收之后依然存在。</li><li><strong>高效（efficient）</strong>，它不会长时间暂停应用程序。</li><li><strong>减少甚至消除内存碎片</strong>。<strong>整理（compaction）</strong> 就是一种消除碎片的方式。</li><li><strong>可伸缩（scalable）</strong>。对于多处理器系统上的多线程应用来说，内存的分配与回收都不应该成为性能瓶颈。</li></ol><h3 id=设计选择>设计选择</h3><p>当设计或选择垃圾回收算法时，需要考虑很多点：</p><ul><li><strong>Serial vs Parallel</strong>。串行简单但慢，并行快但更复杂并且可能导致内存碎片。</li><li><strong>Concurrent vs Stop-the-world</strong>。并发复杂但暂停应用时间短且可能影响程序性能，STW 简单但暂停应用时间长。</li><li><strong>Compacting vs Non-compacting vs Copying</strong>。整理式收集器将所有存活对象移动到一起并完全回收其它内存，为新对象分配内存简单又快速。非整理式收集器原地释放垃圾对象的空间，不移动对象，它更快但可能导致内存碎片，还可能加大为大对象寻找合适内存空间的难度。复制式收集器将存活对象复制到一个不同的内存区域，源空间可以直接被认为是完全空闲的，接下来可以直接在它上面为新对象分配内存，这既简单又迅速，但需要额外的时间来复制对象以及额外的空间来存储复制后的对象。</li></ul><h3 id=性能指标>性能指标</h3><p>有很多指标可以用来衡量垃圾收集器的性能：</p><ul><li><strong>吞吐量（Throughput）</strong>：非垃圾收集时间占总时间的百分比。</li><li><strong>垃圾收集开销（Garbage collection overhead）</strong>：垃圾收集时间占总时间的百分比。</li><li><strong>暂停时间（Pause time）</strong>：应用执行期内因垃圾收集而暂停的总时间。</li><li><strong>收集频率（Frequency of collection）</strong>：垃圾收集多长时间发生一次。</li><li><strong>内存占用（Footprint）</strong>：GC 运行时占用的内存大小。</li><li><strong>及时性（Promptness）</strong>：从对象成为垃圾到该对象占用空间可用所经历的时间。</li></ul><p>不同类型的应用需要不同的性能指标。例如，交互式应用可能要求较短的暂停时间，实时应用可能要求暂停时间不得超过某个上界，而嵌入式应用可能更关注内存占用。</p><h3 id=分代收集>分代收集</h3><p>在 <strong>分代收集（generational collection）</strong> 算法中，内存被划为为不同的代，不同代保存不同年龄的对象。收集器根据不同代上对象的特点采用不同的垃圾回收算法。分代垃圾收集利用了 <strong>弱分代假说（weak generational hypothesis）</strong>，即：</p><ul><li>大多数对象都是朝生夕死的。</li><li>存在少量年老代对象到年轻代对象的引用。</li></ul><p>和年老代相比，年轻代上垃圾收集更加频繁。由于年轻代空间通常很小并且很可能包含大量死亡对象，所以年轻代上的垃圾收集通常很快。</p><p>当年轻代上的对象熬过一定次数的垃圾收集之后，它们就会被 <strong>提升（prompt）</strong> 到年老代。年老代通常比年轻代大很多，但年老代上的空间占用的增长速度比年轻代要慢。因此，年老代上的垃圾收集的发生频率更低，但花费的时间更多。</p><h2 id=j2ee-50-hotspot-jvm中的垃圾收集器>J2EE 5.0 HotSpot JVM中的垃圾收集器</h2><p>J2EE 5.0 对应的 HotSpot VM 中包含了 4 种垃圾收集器（它们都是分代收集器）。</p><h3 id=hotspot-中的分代>HotSpot 中的分代</h3><p>HotSpot VM 中的内存由三个分代组成：</p><ul><li><strong>年轻代（young generation）</strong>。大多数对象一开始会被分配在年轻代。</li><li><strong>年老代（old generation）</strong>。年老代中包含了那些在年轻代中熬过了一定次数垃圾收集的对象，一些大对象也可能直接被分配到年老代。</li><li><strong>永久代（permanent generation）</strong>。永久代主要存放描述类与方法的那些对象，以及类与方法本身。</li></ul><p>年轻代由一个 <strong>Eden 区</strong> 和两个 <strong>Survivor 空间</strong> 组成。大多数对象一开始被分配到 Eden 区，少数对象直接分配到年老代。Survivor 空间保存了那些至少经历过一次垃圾收集的对象，在任何时刻，只有一个 Survivor 空间会保存这些对象，而另一个 Survivor 空间是空着的并且在下次垃圾收集之前都不会被使用。</p><h3 id=垃圾收集的种类>垃圾收集的种类</h3><p>当年轻代空间不足时，年轻代上的垃圾收集就会发生，年轻代上的垃圾收集又称 <strong>小型 GC（minor GC）</strong>。当年老代或永久代空间不足时，<strong>完全 GC（Full GC）</strong> （有时候又称 <strong>大型 GC（major GC）</strong> ）就会发生，Full GC 会在所有的分代上进行垃圾收集，即回收整个堆。通常情况下，垃圾回收会先发生年轻代上，然后才是年老代和永久代，不同分代上采用的算法不同。如果回收过程中需要整理内存，各个分代上的整理也是单独发生的。</p><p>有时候，当年轻代上的垃圾收集先发生时，一些对象需要被从年轻代提升到年老代时，而年老代的剩余空间可能不足以容纳下所有的这些对象。在这种情况下，对于除 CMS 以外的收集器来说：并不会运行年轻代上的垃圾回收算法，而是会将年老代上的垃圾回收算法应用于整个堆。CMS 是一个例外，它只能回收年老代而不能回收年轻代。</p><h3 id=快速内存分配>快速内存分配</h3><h4 id=顺序分配>顺序分配</h4><p><strong>顺序分配（sequential allocation）</strong> 使用的是一大块内存，每次从空闲块的一端开始分配所请求大小空间的内存。顺序分配所需要的数据结构非常简单：只需要一个 free 指针和一个 limit 指针。例如，下图展示了为一个大小为 <code>n</code> 的对象分配内存的过程中 free 指针的变化情况：</p><p><img src=https://zhannicholas.github.io/images/java/jvm/sequential-allocation.png alt="Sequential allocation"></p><p>当需要为一个新生对象分配内存时，只需要检查剩余空间是否足够容纳下这个对象。如果能，就更新 free 指针并初始化这个对象。</p><p>顺序分配又被称为阶跃指针分配（bump pointer allocation），因为 free 指针是阶跃式的。正因为这个特点，free 指针又称 <strong>阶跃指针（bump pointer）</strong>。此外，顺序分配也被称为线性分配，因为分配的内存地址在一个指定的内存块上是线性的。顺序分配有以下特点：</p><ul><li>非常简单。</li><li>非常高效。</li><li>与空闲链表分配相比，顺序分配的缓存局部性更好，尤其是在移动式垃圾收集器中。</li><li>对于非移动式垃圾收集器，顺序分配就没空闲链表分配那么合适了，因为它有可能导致内存碎片。</li></ul><p>在 <strong>空闲链表分配（free-list allocation）</strong> 中，有一种数据结构记录着空闲内存单元的位置和大小。空闲内存单元的组织方式并非一定是链表，也可以是其它的形式。</p><h4 id=tlab>TLAB</h4><p>在多线程应用中，分配操作需要是线程安全的。在 JVM 中，对象创建是非常频繁的行为，即使仅仅修改一个指针所指向的位置，在并发情况下也可能不是线程安全的，可能出现正在给对象 A 分配内存，指针还没来得及修改，对象 B 又使用了原来准备分配给对象 A 的内存的情况。有两种方案可以解决这个问题：</p><ol><li>对内存分配动作进行同步处理。实际上 JVM 采用 CAS + 失败重试的方式保证更新操作的原子性；</li><li>把内存分配动作按照线程划分在不同的空间进行，即预先为每个线程在堆中分配一小块内存——TLAB（Thread-Local Allocation Buffer）。TLAB 加上阶跃指针，分配速度可以非常快。当需要为新生对象分配内存时，首先尝试在 TLAB 中分配内存，若 TLAB 上分配失败，就需要采用同步的方式处理了。</li></ol><h3 id=串行收集器>串行收集器</h3><p>当使用 <strong>串行收集器（Serial Collector）</strong> 时，年轻代和年老代上的垃圾收集都是串行发生的（使用单核 CPU）。在回收过程中，整个应用是被完全暂停的（stop-the-world）。</p><h4 id=年轻代上的串行收集器>年轻代上的串行收集器</h4><p><img src=https://zhannicholas.github.io/images/java/jvm/serial-young-generation-collection.png alt="Serial young generation collection"></p><p>上图展示了使用串行收集器在年轻代上的操作：Eden 区中存活的对象会被复制到最初为空的那一个 Survivor 空间（即目标空间 To）。但是有些在 Eden 区中存活的对象可能非常大(大到目标空间无法容纳下)，它们会被直接复制到年老代。最初不为空的那个 Survivor 空间（即源空间 From）中的存活对象也会被复制到目标空间，其中足够老的对象会直接被复制到年老代。需要注意的是：当目标空间已满，而 Eden 区和源空间内还有存活对象时，这些存活对象不论年龄多大都会被直接复制到年老代。复制操作完成之后，Eden 区和源空间内所有剩余对象都被认为是已经死亡的，收集器会直接清空 Eden 区和源空间。最后，只有先前的目标空间包含存活对象，这个时候，将两个 Survivor 空间的角色互换，为下一次垃圾收集做好准备。串行收集器执行完之后，年轻代就成了下面这个样子：</p><p><img src=https://zhannicholas.github.io/images/java/jvm/after-a-young-generation-collection.png alt="After a young generation collection"></p><h4 id=年老代上的串行收集器>年老代上的串行收集器</h4><p>在年老代和永久代上，串行收集器采用的是 <strong>标记-清除-整理（mark-sweep-compaction）</strong> 算法。在标记阶段，收集器识别出所有依然存活的对象。在清除阶段，收集器并不会真正进行清除垃圾（非存活对象）的操作，而是简单地识别出这些垃圾。最后，收集器会整理堆，将所有的存活对象全部滑动到年老代的一端（永久代类似）。这么做以后，年老代的另一端就是一个连续空闲块，随后就可以采用阶跃指针快速为新对象分配空间。下图展示了整理前后年老代的情况：</p><p><img src=https://zhannicholas.github.io/images/java/jvm/compaction-of-the-old-generation.png alt="Compaction of old generation"></p><h3 id=并行收集器>并行收集器</h3><p><strong>并行收集器（Parallel Collector）</strong> 又称 <strong>吞吐量收集器（throughput collector）</strong>，它主要是为了充分利用拥有多处理器的机器上的多个 CPU。</p><p>并行收集器其实是串行收集器的多线程版本。在进行垃圾回收时，并行收集器在年轻代和年老代上都采用了和串行收集器一样的算法，并且都会暂停整个应用。不同的是，并行收集器会在应用暂停期间使用多个线程并行地进行回收工作，回收速度更快。应用的吞吐量因此而提升。</p><p><img src=https://zhannicholas.github.io/images/java/jvm/comparison-between-serial-and-parallel-generation-collection.png alt="Comparison between serial and parallel generation collection"></p><h3 id=并行整理收集器>并行整理收集器</h3><p><strong>并行整理收集器（Parallel Compacting Collector）</strong> 是 J2SE 5.0 update 6 中新引入的收集器。它和并行收集器的不同之处在于：它在年老代上使用了新的垃圾回收算法，年轻代上的垃圾回收算法和之前一样。需要注意的是：并行整理收集器最终会取代并行收集器。</p><p>在回收年老代和永久代时，并行整理收集器还是会暂停整个程序，但滑动整理操作大部分是并行的。每个分代在逻辑上被划分为若干固定大小的 <strong>区域（region）</strong>。整个收集过程分为三个阶段：</p><ol><li><strong>标记阶段（marking phase）</strong>。从应用代码（GC Roots）出发，直接可达的存活对象（初始存活对象集合）会被分给不同的垃圾收集线程，然后并行标记所有的存活对象。当发现一个对象依然存活时，就会用这个对象的大小和位置信息来更新其所在区域的数据。</li><li><strong>汇总阶段（summary phase）</strong> 。汇总阶段操作的是区域，而不是对象。由于前面几次垃圾收集的整理操作，每个分代左边部分包含的存活对象比较多，通过整理回收的空间也比较少，因此不值得在它上面进行整理。所以汇总阶段所做的第一件事就是从左边部分开始检查区域的密度(存活对象所占的空间比例)，直到碰到一个密度较小，值得花时间去整理的区域，然后从这个区域开始，为其后的每个区域计算并保存存活数据的第一个字节的新位置。需要注意的是：汇总阶段当前的实现是串行的。</li><li><strong>整理阶段（compaction phase）</strong> 。收集器利用汇总阶段的数据识别出需要被填充的区域，然后并行的将存活对象复制到这些区域中。最终，堆的一端中包含了大量存活对象，而另一端是一个非常大的空闲块。</li></ol><h3 id=并发标记清除收集器>并发标记清除收集器</h3><p>对于那些需要快速的响应时间的应用，吞吐量就不再那么重要了。年轻代上的 GC 通常不会导致长时间的停顿，而年老代上的 GC 执行虽然没那么频繁，但可能导致长时间的停顿（尤其是当堆很大时）。为了解决这个问题，HotSpot 引入了 <strong>并发标记清除（Concurrent Mark-Sweep, CMS）收集器</strong> 。CMS 收集器又叫 <strong>低延迟收集器（low-latency collector）</strong>。</p><p>CMS 收集器在年轻代上使用的收集器和串行收集器相同。</p><p>使用 CMS 收集器时，年老代上的大部分收集操作都是在应用执行期间并发进行的。CMS 收集器将收集过程分为了 4 个阶段：</p><ol><li><strong>初始标记（initial mark）</strong>。暂停应用，然后标记应用代码（GC Roots）直接可达的存活对象。</li><li><strong>并发标记（concurrent mark）</strong>。从 GC Roots 直接可达的对象出发，并发的标记所有间接可达的存活对象。由于应用在运行，对象之间的引用关系会在并发标记期间有所变化，所以在并发标记阶段结束时，不能保证所有的存活对象都被标记。</li><li><strong>重新标记（remark）</strong>。为了防止并发标记阶段错标，收集器会暂停整个应用，然后并发地标记那些在并发标记阶段引用关系发生变化的对象。这一阶段耗时比初始阶段长，但又远短于并发标记阶段。</li><li><strong>并发清除（concurrent sweep）</strong>。经过重新标记阶段，堆中所有存活的对象都已被标记。并发清除阶段会回收那些未被标记的对象。</li></ol><p>下图展示了年老代上的串行收集器与 CMS 收集器的区别：</p><p><img src=https://zhannicholas.github.io/images/java/jvm/comparison-between-serial-and-cms-old-generation-collection.png alt="Comparison between serial and CMS old generation collection"></p><p>CMS 收集器是唯一一个不对堆进行整理的收集器。即在释放死亡对象占用的空间后，它不会将移动存活对象移动到年老代的一端。这么做节省了时间，但会导致空闲空间变得不连续，因此需要采用空闲链表来管理空闲内存。CMS 收集器的另一个缺点是：它要求的堆空间比其它垃圾收集器都要大。因为应用可以在标记阶段运行并可能继续分配内存，进而间接地消耗了年老代的空闲空间。此外，尽管 CMS 收集器保证在标记阶段识别出所有存活对象，但一些存活对象可能在这个过程中成为垃圾并且不会被回收，而是要等到下一次垃圾回收才会被回收。这些对象被称为 <strong>浮动垃圾（floating garbage）</strong>。最后，由于缺乏整理，堆中可能出现碎片。为了处理这个问题，CMS 收集器会跟踪常用对象大小，估算未来的分配请求，可能还会拆分或合并空闲块以满足要求。</p><p>不同于其它收集器，CMS 收集器并不是在年老代被填满之后才进行收集，而是尽可能早的开始回收，以便它可以在年老代被填满之前能完成回收工作。否则，CMS 收集器会使用一个更加耗时并且会暂停整个应用的标记-清除-整理算法（即并行和串行收集器采用的算法）进行回收。为了避免这种情况，CMS 收集器会统计一些垃圾回收的数据，然后基于这些数据在恰当的时候触发回收操作。当年老代的空间占用率超过某个值时，CMS 收集器也会启动回收操作。这个域值可以通过命令行参数 <code>-XX:CMSInitiatingOccupancyFraction=n</code> 来指定，其中的 <code>n</code> 代表占年老代的百分比，默认为 68。</p><p>总之，和并行收集器相比，CMS 收集器缩短了年老代上垃圾收集导致的暂停时间，但却付出了一些代价：回收年轻代的速度变慢了，吞吐量降低了，消耗的堆空间更大了。</p><h2 id=参考资料>参考资料</h2><ol><li><a href=https://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf target=_blank>Memory Management in the Java HotSpot VM</a>
.</li><li>Richard Jones, Antony Hosking, Eliot Moss. <em>The Garbage Collection Handbook: The Art of Automatic Memory Management</em>. Chapman and Hall/CRC, 2011.</li></ol></div><hr><aside><h4>No linked references</h4></aside><br><aside class=related><h3 class="text-2xl font-black tracking-tight text-indigo-500 capitalize dark:text-indigo-300 sm:text-2xl">Related Content</h3><ul><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-indigo-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/java/jvm/hotspot_engine_architecture>HotSpot引擎架构</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-indigo-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/java/jvm/garbage_collection_tuning_guide_in_javase8>垃圾回收调优指南(Java SE 8)</a></p></ul></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer></body></html>
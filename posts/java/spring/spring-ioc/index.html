<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>Spring Ioc | NZ's Digital Garden</title><meta name=description content><meta property="og:title" content="Spring Ioc | NZ's Digital Garden"><meta name=twitter:title content="Spring Ioc | NZ's Digital Garden"><meta itemprop=name content="Spring Ioc | NZ's Digital Garden"><meta name=application-name content="Spring Ioc | NZ's Digital Garden"><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content="NZ's Digital Garden"><meta property="og:description" content><meta property="og:site_name" content="NZ's Digital Garden"><meta property="og:url" content="https://zhannicholas.github.io/posts/java/spring/spring-ioc/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.8458c1237ecc4766957580cbadcdbc3827551cb1e8f51d9fa5c37d7473a022e9.css" integrity="sha256-hFjBI37MR2aVdYDLrc28OCdVHLHo9R2fpcN9dHOgIuk="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">NZ's Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-primary-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-primary-600 focus:bg-primary-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-primary-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Spring Ioc</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#ioc-%e5%ae%b9%e5%99%a8>Ioc 容器</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%85%8d%e7%bd%ae%e5%85%83%e6%95%b0%e6%8d%ae>配置元数据</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%bd%bf%e7%94%a8-beanfactorypostprocessor-%e5%af%b9%e9%85%8d%e7%bd%ae%e5%85%83%e6%95%b0%e6%8d%ae%e8%bf%9b%e8%a1%8c%e4%b8%aa%e6%80%a7%e5%8c%96%e9%85%8d%e7%bd%ae>使用 BeanFactoryPostProcessor 对配置元数据进行个性化配置</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5>依赖注入</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%87%aa%e5%8a%a8%e8%a3%85%e9%85%8d>自动装配</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#bean>Bean</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#bean-%e7%9a%84%e5%91%bd%e5%90%8d>Bean 的命名</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#depends-on>depends-on</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%bb%b6%e8%bf%9f%e5%88%9d%e5%a7%8b%e5%8c%96-bean>延迟初始化 Bean</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#bean-%e7%9a%84%e4%bd%9c%e7%94%a8%e5%9f%9f>Bean 的作用域</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#bean-%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f>Bean 的生命周期</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#bean-%e7%9a%84%e5%88%9b%e5%bb%ba>Bean 的创建</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#beanpostprocessor>BeanPostProcessor</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%ae%9e%e4%be%8b%e5%8c%96-bean>实例化 Bean</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%88%9d%e5%a7%8b%e5%8c%96-bean>初始化 Bean</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%94%80%e6%af%81-bean>销毁 Bean</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%85%b6%e5%ae%83-aware-%e6%8e%a5%e5%8f%a3>其它 Aware 接口</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%b8%80%e4%b8%aa%e4%be%8b%e5%ad%90>一个例子</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%9c%aa%e5%ae%8c%e5%be%85%e7%bb%ad>未完待续</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>Ioc（Inverse of Control），又叫 DI（Dependence Injection）。它是这样一个过程：对象声明自己的依赖，然后容器在创建 Bean 的时候注入这些依赖。如果不使用 IoC，我们在创建对象之前就需要先把对象的依赖创建出来，这个正向的过程会导致对象与对象之间的强耦合。如果反过来，对象不自己创建依赖，而是由 Spring 的 Ioc 容器自动装配，这就是控制反转。逆向的过程使得程序的结构变得更加灵活，没有强耦合，还有利于对象的复用。</p><p><img src=https://zhannicholas.github.io/images/java/spring/spring-ioc-mindmap.png alt=Mindmap></p><h2 id=ioc-容器>Ioc 容器</h2><p>在 Spring 中，<code>org.springframework.context.ApplicationContext</code> 接口就是 IoC 容器的抽象表示，它负责 Bean 的实例化、配置以及组装。那么，IoC 容器是如何知道要管理哪些 Bean 呢？答案是配置元数据（Configuration Metadata）。配置元数据可以是 XML、注解，还可以是 Java 代码。</p><p><img src=https://zhannicholas.github.io/images/java/spring/container-magic.png alt="The Spring Ioc container"></p><h3 id=配置元数据>配置元数据</h3><p>Spring 的 Ioc 容器会读取配置元数据，然后根据配置元数据去实例化、配置和组装应用程序中的 Bean。在 Spring 的早期版本中，配置信息使用的是 XML。Spring 2.5 开始支持基于注解的配置，我们常用的 <code>@Required</code> 和 <code>@Autowired</code> 就是基于注解的配置。 Spring 3.0 开始支持基于 Java 代码的配置。现在，我们甚至可以同时使用 XML 和 注解去配置 Bean。</p><p>实际上，在 IoC 容器内部，这些配置元数据会被解析成 <code>BeanDefinition</code> 对象，<code>BeanDefinition</code> 封装的就是 Bean 的定义和描述信息，比如类名、构造器参数、属性值、作用域、生命周期等，容器会根据 <code>BeanDefinition</code> 中封装的信息来创建 Bean。</p><h3 id=使用-beanfactorypostprocessor-对配置元数据进行个性化配置>使用 BeanFactoryPostProcessor 对配置元数据进行个性化配置</h3><p>在 Spring 中，<code>BeanFactory</code> 提供了一种管理任何类型对象的高级机制，我们经常遇到的 <code>ApplicationContext</code> 则是它的一个子接口。若要用一句话来描述二者的差异，那就是：<code>BeanFactory</code> 提供配置框架和基本功能，<code>ApplicationContext</code> 则是添加了更多的企业级功能。</p><p><code>BeanFactoryPostProcessor</code> 允许我们对配置元数据（<code>BeanDefinition</code>）进行个性化配置。它与后面介绍的 <code>BeanPostProcessor</code> 功能类似，只不过后者的作用是对 Bean 本身进行个性化配置。接口定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BeanFactoryPostProcessor</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * Modify the application context&#39;s internal bean factory after its standard
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * initialization. All bean definitions will have been loaded, but no beans
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * will have been instantiated yet. This allows for overriding or adding
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * properties even to eager-initializing beans.
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postProcessBeanFactory</span><span style=color:#f92672>(</span>ConfigurableListableBeanFactory beanFactory<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>在 <code>postProcessBeanFactory()</code> 方法被调用前，所有的 Bean 定义信息都已经加载完毕。所以 <code>BeanFactoryPostProcessor</code> 可以在 Bean 实例化之前获取 Bean 的配置元数据，并对其进行修改。</p><h2 id=依赖注入>依赖注入</h2><p>依赖注入主要有两种：</p><ul><li><strong>基于构造器的依赖注入（Constructor-based DI）</strong>：容器调用有参构造函数（或静态工厂方法），传入参数列表，每一个参数代表一个依赖。</li><li><strong>基于 Setter 的依赖注入（Setter-based DI）</strong>：容器在调用无参构造函数或无参静态工厂方法之后，再调用 Bean 的 setter 方法注入依赖。</li></ul><p>IoC 容器甚至支持两种注入方式的混用的情况，你可以先通过构造函数给 Bean 注入一部分依赖，再通过 setter 方法给 Bean 注入另一部分依赖。一般情况下，推荐使用构造器注入强制性依赖，使用 setter 方法注入可选的依赖。</p><p>Bean 的依赖项解析过程如下：</p><ul><li>容器被创建出来，通过描述 Bean 的配置元数据进行初始化，检验每个 Bean 的配置信息。配置元数据可以是 XML，也可以是注解和 Java 代码</li><li>对于每一个 Bean，它依赖会被表示成属性、构造器参数或静态工厂方法的参数。这些依赖将会在 Bean 被真正创建的时提供给它</li><li>每个属性或构造器参数都是一个具体的值，或者指向容器内另一个 Bean 的引用</li><li>对于那些是具体值的属性或构造器参数，相应的值会被转化成属性或构造器参数的实际类型</li></ul><h3 id=自动装配>自动装配</h3><p>Spring 提供了四种自动装配模式：</p><table><thead><tr><th>Mode</th><th>Description</th></tr></thead><tbody><tr><td>no</td><td>不使用自动装配，通过 <code>ref</code> 定义 Bean 的依赖。这是默认值</td></tr><tr><td>byName</td><td>通过属性名装配。Spring 会查找与属性同名的 Bean 进行装配</td></tr><tr><td>byType</td><td>当满足给定类型的 Bean 只有一个时，进行自动装配，有多个时抛出异常。若没有满足类型的 Bean，不进行装配。</td></tr><tr><td>constructor</td><td>与 byType 类似，只是 Bean 用作构造器参数</td></tr></tbody></table><h2 id=bean>Bean</h2><p>在 Spring 中，Bean 就是那些由 IoC 容器初始化、配置和组装的对象，IoC 容器就是 Bean 的管理者。我们在前面提到，开发者通过配置元数据告诉 IoC 容器 Bean 的相关配置信息，容器将配置元数据解析成 <code>BeanDefinition</code> 对象，再通过它创建 Bean。</p><h3 id=bean-的命名>Bean 的命名</h3><p>通常情况下，一个 Bean 只有一个标识符（identifier）。但是，如果 Bean 需要多个标识符，也是可以的，这些多的标识符就是 Bean 的别名（alias）。但是，<strong>在同一个 IoC 容器中，是不允许有多个相同的标识符的</strong>。</p><p>那么，如何指定 Bean 的标识符呢？在基于 XML 的配置里，Bean 的标识符由 <code>id</code> 和 <code>name</code> 属性指定。其中 <code>id</code> 只允许我们声明一个标识符，而 <code>name</code> 允许我们声明多个，多个标识符之间使用逗号（<code>,</code>）或分号（<code>;</code>）或空格分隔就行了。例如：<code>&lt;bean id="xx" name="xx1,xx2"/></code>有时候，在 <code>name</code> 中声明所有的别名可能并不合适，这时可以使用 <code>&lt;alias/></code> 标签来单独明别名。例如：<code>&lt;alias name="fromName" alias="toName"/></code>。如果我们没有在 <code>&lt;bean/></code> 中定义 <code>id</code> 或 <code>name</code> 的值也是可以的，这是容器或自动帮我们生成一个 Bean 的标识符。</p><p>当我们使用像 <code>@Bean</code> 这种基于 Java 的配置创建 Bean 时，Bean 的标识符默认为方法的名字，例如下面代码中创建的 Bean 的标识符就是 <code>transferService</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AppConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> TransferServiceImpl <span style=color:#a6e22e>transferService</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> TransferServiceImpl<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=depends-on>depends-on</h3><p>有时候，我们可能是希望某个 Bean 在另一个或多个 Bean 之前初始化，这时我们可以使用 <code>depends-on</code>。例如：<code>&lt;bean id="beanOne" depends-on="beanTwo,beanThree"/></code> 告知容器在初始化 <code>beanOne</code> 之前先初始化 <code>beanTwo</code> 和 <code>beanThree</code>。</p><h3 id=延迟初始化-bean>延迟初始化 Bean</h3><p><code>ApplicationContext</code> 默认会在启动的时候初始化所有的单例 Bean。虽然这种饿汉式的初始化方式能够尽早将问题暴露出来，但是有时候我们希望 Bean 在第一次被使用时才创建，即延迟初始化。为了实现这个目标，我们可以使用 <code>lazy-init</code> 属性。例如，<code>&lt;bean id="beanOne" lazy-init="true"/></code> 告诉容器不要在启动时创建 <code>beanOne</code>，而是在 <code>beanOne</code> 第一次被请求时才创建它。</p><h3 id=bean-的作用域>Bean 的作用域</h3><p>我们前面有说，IoC 容器会使用 <code>BeanDefinition</code> 中封装的描述信息来创建 Bean。Bean 的<a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes target=_blank>作用域（Scope）</a>
描述的是：在不同场景下， <code>BeanDefinition</code> 和通过它创建出来的 Bean 的数量关系。在Spring 中，Bean 的作用域是相对于 IoC 容器来说的。Spring 默认支持了六种作用域：</p><table><thead><tr><th>Scope</th><th>Description</th></tr></thead><tbody><tr><td>singleton</td><td>通过单个 <code>BeanDefinition</code> 创建的 Bean 在容器内只有一个实例。这也是默认的作用域</td></tr><tr><td>prototype</td><td>通过单个 <code>BeanDefinition</code> 可以创建出任意数量的 Bean 实例</td></tr><tr><td>request</td><td>在每个 HTTP 请求的生命周期内，通过单个 <code>BeanDefinition</code> 创建的实例只有一个</td></tr><tr><td>session</td><td>在每个 HTTP 会话的生命周期内，通过单个 <code>BeanDefinition</code> 创建的实例只有一个</td></tr><tr><td>application</td><td>在每个 <code>ServletContext</code> 的生命周期内，通过单个 <code>BeanDefinition</code> 创建的实例只有一个</td></tr><tr><td>websocket</td><td>在每个 <code>WebSocket</code> 的生命周期内，通过单个 <code>BeanDefinition</code> 创建的实例只有一个</td></tr></tbody></table><p>此外，Spring 还支持开发者创建自定义的 Bean 作用域，具体做法可以参考 <a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-scopes-custom target=_blank>Custom Scopes</a>
。</p><h3 id=bean-的生命周期>Bean 的生命周期</h3><p>Bean 本质上是一个 Java 对象。我们先回顾下 <a href=https://zhannicholas.github.io/posts/java/jvm/java_object_lifecycle/>Java 对象的生命周期</a>
，JVM 中的对象一生大概会经历以下几个阶段：</p><p><img src=https://zhannicholas.github.io/images/java/spring/java-object-lifecycle.png alt="Java object lifecycle" title="Java 对象生命周期"></p><p>站在 JVM 的角度来看，Bean 的生命周期也就是这样。但是，由于 Bean 是 IoC 容器管理的，容器可能给它定义额外的生命周期，也就是添加新的阶段。所以我们需要从 IoC 容器的角度看 Bean 的生命周期。</p><p>IoC 容器中 Bean 的生命周期主要有 4 个大的阶段：</p><ol><li>实例化（Instantiation）</li><li>初始化（Initialization）</li><li>使用（In Use）</li><li>销毁（Destruction）</li></ol><p>这和 Java 对象的生命周期有点不一样。但如果我们将 Bean 的生命周期看成创建、使用和销毁这三个大的阶段是不是就好理解了一些呢。Bean 的使用就不用说了，销毁也只是在容器关闭前（详见 <code>ConfigurableApplicationContext#close</code>）调用一下，复杂的都在 Bean 的创建过程。所以下面我们重点来看 Bean 的创建过程。</p><h4 id=bean-的创建>Bean 的创建</h4><p>先声明以下，这里说的 Bean 的创建并不只是说把 Bean 实例化出来就行了，而是指实例化和初始化两个步骤。普通非延迟初始化的 Bean 创建流程的入口其实在 <code>org.springframework.context.support.AbstractApplicationContext#refresh()</code> 方法中的 <code>finishBeanFactoryInitialization(beanFactory)</code>，感兴趣的同学可以打开源码一探究竟。一番探索之后，发现最终的 Bean 创建逻辑位于 <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean</code> 方法。<code>doCreateBean()</code> 的方法体还是不短，为了抓住主线，先贴出主干代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>doCreateBean</span><span style=color:#f92672>(</span>String beanName<span style=color:#f92672>,</span> RootBeanDefinition mbd<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> Object<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throws</span> BeanCreationException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Instantiate the bean.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		BeanWrapper instanceWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>isSingleton</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			instanceWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>factoryBeanInstanceCache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>beanName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>instanceWrapper <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			instanceWrapper <span style=color:#f92672>=</span> createBeanInstance<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> mbd<span style=color:#f92672>,</span> args<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		Object bean <span style=color:#f92672>=</span> instanceWrapper<span style=color:#f92672>.</span><span style=color:#a6e22e>getWrappedInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Allow post-processors to modify the merged bean definition.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>postProcessingLock</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>postProcessed</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					applyMergedBeanDefinitionPostProcessors<span style=color:#f92672>(</span>mbd<span style=color:#f92672>,</span> beanType<span style=color:#f92672>,</span> beanName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>				mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>postProcessed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Eagerly cache singletons to be able to resolve circular references
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#75715e>// even when triggered by lifecycle interfaces like BeanFactoryAware.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>boolean</span> earlySingletonExposure <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>isSingleton</span><span style=color:#f92672>()</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>allowCircularReferences</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>				isSingletonCurrentlyInCreation<span style=color:#f92672>(</span>beanName<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>earlySingletonExposure<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>			addSingletonFactory<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> getEarlyBeanReference<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> mbd<span style=color:#f92672>,</span> bean<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Initialize the bean instance.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		Object exposedObject <span style=color:#f92672>=</span> bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			populateBean<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> mbd<span style=color:#f92672>,</span> instanceWrapper<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			exposedObject <span style=color:#f92672>=</span> initializeBean<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> exposedObject<span style=color:#f92672>,</span> mbd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Register bean as disposable.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			registerDisposableBeanIfNecessary<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> bean<span style=color:#f92672>,</span> mbd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>BeanDefinitionValidationException ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> exposedObject<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这代码就清爽多了。所以 Bean 的创建步骤主要是以下几步：</p><p><img src=https://zhannicholas.github.io/images/java/spring/doCreateBean.png alt="创建 Bean" title="Bean 的创建"></p><h4 id=beanpostprocessor>BeanPostProcessor</h4><p><code>BeanPostProcessor</code> 允许我们对 Bean 进行个性化定制处理。该接口有两个方法：</p><ul><li><code>postProcessBeforeInitialization(Object bean, String beanName)</code>：在 Bean 初始化之前调用</li><li><code>postProcessAfterInitialization(Object bean, String beanName)</code>：在 Bean 初始化之后调用</li></ul><p><code>BeanPostProcessor</code> 有一系列的子接口，比如 <code>InstantiationAwareBeanPostProcessor</code> 、<code>DestructionAwareBeanPostProcessor</code>、<code>BeanFactoryPostProcessor</code>、<code>ApplicationContextAwareProcessor</code> 等。<code>BeanPostProcessor</code> 系列接口中的回调是容器级别的，对所有的 Bean 生效。不同子接口发挥作用的时间不同，后面会进行介绍。</p><h4 id=实例化-bean>实例化 Bean</h4><p>创建 Bean 的第一步是实例化，入口方法是 <code>AbstractAutowireCapableBeanFactory#createBeanInstance</code>。容器会根据配置元数据，采取合适的策略（工厂方法或构造器）<a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-factory-class target=_blank>实例化 Bean</a>
。</p><p><code>InstantiationAwareBeanPostProcessor</code> 提供了三个非常重要的方法：</p><ul><li><code>postProcessBeforeInstantiation(Class&lt;?> beanClass, String beanName)</code>：在实例化 Bean 之前调用</li><li><code>postProcessAfterInstantiation(Object bean, String beanName)</code>：在实例化 Bean 之后、正式填充属性之前调用</li><li><code>postProcessProperties(PropertyValues pvs, Object bean, String beanName)</code>：在填充属性之前对属性值作处理</li></ul><p>加入这三个方法之后的 Bean 创建过程如下：</p><p><img src=https://zhannicholas.github.io/images/java/spring/doCreateBean-instantiation-callback.png alt="实例化 Bean" title="实例化 Bean"></p><h4 id=初始化-bean>初始化 Bean</h4><p>初始化 Bean 的入口方法是 <code>AbstractAutowireCapableBeanFactory#initializeBean</code>，主干代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>protected</span> Object <span style=color:#a6e22e>initializeBean</span><span style=color:#f92672>(</span>String beanName<span style=color:#f92672>,</span> Object bean<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> RootBeanDefinition mbd<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		invokeAwareMethods<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> bean<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		Object wrappedBean <span style=color:#f92672>=</span> bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mbd <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>isSynthetic</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			wrappedBean <span style=color:#f92672>=</span> applyBeanPostProcessorsBeforeInitialization<span style=color:#f92672>(</span>wrappedBean<span style=color:#f92672>,</span> beanName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			invokeInitMethods<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> wrappedBean<span style=color:#f92672>,</span> mbd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mbd <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>isSynthetic</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			wrappedBean <span style=color:#f92672>=</span> applyBeanPostProcessorsAfterInitialization<span style=color:#f92672>(</span>wrappedBean<span style=color:#f92672>,</span> beanName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> wrappedBean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>从上到下的逻辑主要是：调用 <code>Aware</code> 类型的回调方法，<code>BeanPostProcessor</code> 初始化前置处理，调用初始化方法，调用 <code>BeanPostProcessor</code> 初始化后置处理。我们一个一个来看。</p><h5 id=bean-初始化-aware>Bean 初始化 Aware</h5><p><code>Aware</code> 类型的接口众多，但是在 Bean 的初始化过程中只可能会调用 <code>BeanNameAware</code>、<code>BeanClassLoaderAware</code> 和 <code>BeanFactoryAware</code> 三个接口的回调方法。具体逻辑可以参考<code>AbstractAutowireCapableBeanFactory#initializeBean</code> 方法调用的 <code>invokeAwareMethods(beanName, bean)</code> 方法。方法不长，我直接贴出来：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeAwareMethods</span><span style=color:#f92672>(</span>String beanName<span style=color:#f92672>,</span> Object bean<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bean <span style=color:#66d9ef>instanceof</span> Aware<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bean <span style=color:#66d9ef>instanceof</span> BeanNameAware<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>((</span>BeanNameAware<span style=color:#f92672>)</span> bean<span style=color:#f92672>).</span><span style=color:#a6e22e>setBeanName</span><span style=color:#f92672>(</span>beanName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bean <span style=color:#66d9ef>instanceof</span> BeanClassLoaderAware<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				ClassLoader bcl <span style=color:#f92672>=</span> getBeanClassLoader<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bcl <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>((</span>BeanClassLoaderAware<span style=color:#f92672>)</span> bean<span style=color:#f92672>).</span><span style=color:#a6e22e>setBeanClassLoader</span><span style=color:#f92672>(</span>bcl<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bean <span style=color:#66d9ef>instanceof</span> BeanFactoryAware<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				<span style=color:#f92672>((</span>BeanFactoryAware<span style=color:#f92672>)</span> bean<span style=color:#f92672>).</span><span style=color:#a6e22e>setBeanFactory</span><span style=color:#f92672>(</span>AbstractAutowireCapableBeanFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><h5 id=正式初始化>正式初始化</h5><p><code>org.springframework.beans.factory.InitializingBean</code> 允许 Bean 在所有属性填充完毕之后执行初始化操作，接口定义如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>InitializingBean</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * Invoked by the containing BeanFactory after it has set all bean properties
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * and satisfied BeanFactoryAware, ApplicationContextAware etc.
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>afterPropertiesSet()</code> 方法会在 Bean 的属性设置完毕、各种 <code>Aware</code> 调用完成之后执行。实际上，Spring 并不推荐我们使用这个接口来进行初始化操作，因为这会导致我们的代码与 Spring 框架强耦合。推荐的做法是使用自定义的 <code>init()</code> 方法或 <a href=http://en.wikipedia.org/wiki/JSR_250 target=_blank>JSR-250</a>
定义的 <code>@PostConstruct</code> 注解。</p><p><code>invokeInitMethods()</code> 方法会尝试先判断 Bean 是否实现 <code>InitializingBean</code> 接口。若是，则调用 Bean 的 <code>afterPropertiesSet()</code> 方法。然后，判断 Bean 是否有自定义的初始化方法。若有，则调用自定义的 <code>init()</code> 方法。你可能已经发现了，这里没有调用 <code>@PostConstruct</code> 注解的方法，因为它是在 <code>#BeanPostProcessor#postProcessBeforeInitialization</code> 中调用的，感兴趣的同学可以查看 <code>InitDestroyAnnotationBeanPostProcessor#postProcessBeforeInitialization</code> 的源码。<code>invokeInitMethods()</code> 的主干代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeInitMethods</span><span style=color:#f92672>(</span>String beanName<span style=color:#f92672>,</span> Object bean<span style=color:#f92672>,</span> <span style=color:#a6e22e>@Nullable</span> RootBeanDefinition mbd<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throws</span> Throwable <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>boolean</span> isInitializingBean <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>bean <span style=color:#66d9ef>instanceof</span> InitializingBean<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isInitializingBean <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>mbd <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>isExternallyManagedInitMethod</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;afterPropertiesSet&#34;</span><span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#f92672>((</span>InitializingBean<span style=color:#f92672>)</span> bean<span style=color:#f92672>).</span><span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mbd <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> bean<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> NullBean<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			String initMethodName <span style=color:#f92672>=</span> mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>getInitMethodName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasLength</span><span style=color:#f92672>(</span>initMethodName<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>!(</span>isInitializingBean <span style=color:#f92672>&amp;&amp;</span> <span style=color:#e6db74>&#34;afterPropertiesSet&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>initMethodName<span style=color:#f92672>))</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>					<span style=color:#f92672>!</span>mbd<span style=color:#f92672>.</span><span style=color:#a6e22e>isExternallyManagedInitMethod</span><span style=color:#f92672>(</span>initMethodName<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				invokeCustomInitMethod<span style=color:#f92672>(</span>beanName<span style=color:#f92672>,</span> bean<span style=color:#f92672>,</span> mbd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>到这里，Bean 的初始化过程基本就分析完了，我们来完善一下之前的图：</p><p><img src=https://zhannicholas.github.io/images/java/spring/doCreateBean-initialization-callback.png alt="Bean 的创建过程" title="Bean 的创建过程"></p><h4 id=销毁-bean>销毁 Bean</h4><p>跟 <code>InitializingBean</code> 类似，Spring 为我们提供了 <code>DisposableBean</code> 用于容器关闭前执行 Bean 的清理工作。Spring 并不推荐我们使用它，因为这会导致程序代码与 Spring 强耦合。推荐的做法是使用 JSR-250 定义的 <code>@PreDestroy</code> 注解或配置自定义的 <code>destroy()</code> 方法。如果同时使用了几种，那么方法的执行顺序是：</p><ol><li><code>@PreDestroy</code> 注解的方法</li><li><code>DisposableBean</code> 的 <code>destory()</code> 方法</li><li>配置的自定义 <code>destroy()</code> 方法</li></ol><p>到这里，Bean 的生命周期基本就介绍完了。用一张图总结下：</p><p><img src=https://zhannicholas.github.io/images/java/spring/bean-lifecycle.png alt="Bean 的生命周期" title="Bean 的生命周期"></p><h4 id=其它-aware-接口>其它 Aware 接口</h4><p>除了之前提到过的 <code>Aware</code> 接口，Spring 还给我们提供了很多其它的 <code>Aware</code> 接口。这些接口告诉 IoC 容器 Bean 需要对应的依赖。例如 <code>ApplicationContextAware</code> 允许 Bean 获得一个 <code>ApplicationContext</code> 的引用，<code>ResourceLoaderAware</code> 允许 Bean 获得一个 <code>ResourceLoader</code> 的引用。</p><h4 id=一个例子>一个例子</h4><p>纸上得来终觉浅，绝知此事要躬行。下面，让我们通过一个例子加深对 Bean 生命周期的理解。</p><p>先定义一个 Bean 类，它实现了众多的接口，包含自定义的初始化方法和自定义的销毁方法，以及一个普通方法 <code>hello()</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MySpringBean</span> <span style=color:#66d9ef>implements</span> ApplicationContextAware<span style=color:#f92672>,</span> BeanNameAware<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        BeanClassLoaderAware<span style=color:#f92672>,</span> BeanFactoryAware<span style=color:#f92672>,</span> InitializingBean<span style=color:#f92672>,</span> DisposableBean <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBeanClassLoader</span><span style=color:#f92672>(</span>ClassLoader classLoader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing setBeanClassLoader...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBeanFactory</span><span style=color:#f92672>(</span>BeanFactory beanFactory<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing setBeanFactory...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBeanName</span><span style=color:#f92672>(</span>String s<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing setBeanName...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>destroy</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing destroy...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing afterPropertiesSet...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setApplicationContext</span><span style=color:#f92672>(</span>ApplicationContext applicationContext<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing setApplicationContext...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostConstruct</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>postConstruct</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing @PostConstruct...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PreDestroy</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>preDestroy</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing @PreDestroy...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>customInitMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing custom init method...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>customDestroyMethod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing custom destroy method...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>hello</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello, Spring!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>然后定义一个 <code>BeanPostProcessor</code> 的实现类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyBeanPostProcessor</span> <span style=color:#66d9ef>implements</span> BeanPostProcessor <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>postProcessBeforeInitialization</span><span style=color:#f92672>(</span>Object bean<span style=color:#f92672>,</span> String beanName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing postProcessBeforeInitialization of &#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>postProcessAfterInitialization</span><span style=color:#f92672>(</span>Object bean<span style=color:#f92672>,</span> String beanName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing postProcessAfterInitialization of &#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>再定义一个 <code>InstantiationAwareBeanPostProcessor</code> 的实现类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyInstantiationAwareBeanPostProcessor</span> <span style=color:#66d9ef>implements</span> InstantiationAwareBeanPostProcessor <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>postProcessBeforeInstantiation</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?&gt;</span> beanClass<span style=color:#f92672>,</span> String beanName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing postProcessBeforeInstantiation of &#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>postProcessAfterInstantiation</span><span style=color:#f92672>(</span>Object bean<span style=color:#f92672>,</span> String beanName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing postProcessAfterInstantiation of &#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> PropertyValues <span style=color:#a6e22e>postProcessProperties</span><span style=color:#f92672>(</span>PropertyValues pvs<span style=color:#f92672>,</span> Object bean<span style=color:#f92672>,</span> String beanName<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> BeansException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Executing postProcessProperties of &#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; ...&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> pvs<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>以及一个配置类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyLifeCycleConfiguration</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MyBeanPostProcessor <span style=color:#a6e22e>myBeanPostProcessor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MyBeanPostProcessor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MyInstantiationAwareBeanPostProcessor <span style=color:#a6e22e>myInstantiationAwareBeanPostProcessor</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MyInstantiationAwareBeanPostProcessor<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span><span style=color:#f92672>(</span>initMethod <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;customInitMethod&#34;</span><span style=color:#f92672>,</span> destroyMethod <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;customDestroyMethod&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MySpringBean <span style=color:#a6e22e>mySpringBean</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> MySpringBean<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>最后写一个测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BeanLifecycleApplicationTests</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> MySpringBean mySpringBean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testMySpringBeanLifecycle</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        mySpringBean<span style=color:#f92672>.</span><span style=color:#a6e22e>hello</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>现在运行测试，各个生命周期回调的执行步骤就一览无余啦。由于容器默认还会创建其它 Bean，数量还不少，影响我们观察。所以下面执行结果中只列出了与 <code>MySpringBean</code> 相关的执行结果：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Executing postProcessBeforeInstantiation of mySpringBean ...
</span></span><span style=display:flex><span>Executing postProcessAfterInstantiation of mySpringBean ...
</span></span><span style=display:flex><span>Executing postProcessProperties of mySpringBean ...
</span></span><span style=display:flex><span>Executing setBeanName...
</span></span><span style=display:flex><span>Executing setBeanClassLoader...
</span></span><span style=display:flex><span>Executing setBeanFactory...
</span></span><span style=display:flex><span>Executing setApplicationContext...
</span></span><span style=display:flex><span>Executing postProcessBeforeInitialization of mySpringBean ...
</span></span><span style=display:flex><span>Executing @PostConstruct...
</span></span><span style=display:flex><span>Executing afterPropertiesSet...
</span></span><span style=display:flex><span>Executing custom init method...
</span></span><span style=display:flex><span>Executing postProcessAfterInitialization of mySpringBean ...
</span></span><span style=display:flex><span>Hello, Spring!
</span></span><span style=display:flex><span>Executing @PreDestroy...
</span></span><span style=display:flex><span>Executing destroy...
</span></span><span style=display:flex><span>Executing custom destroy method...
</span></span></code></pre></div><p>完整代码已经放到 <a href=https://github.com/zhannicholas/java-demos/tree/main/bean-lifecycle target=_blank>Github</a>
。</p><h2 id=未完待续>未完待续</h2><p>时间有限，先写到这里。写东西从来都不是一次性过程，要常看，常思考，常更新。</p><h2 id=参考资料>参考资料</h2><ol><li><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#spring-core target=_blank>Spring Framework Documentation</a>
.</li><li><a href=https://blog.csdn.net/riemann_/article/details/118500805 target=_blank>一文读懂 Spring Bean 的生命周期</a>
.</li></ol></div><hr><aside><h4>No linked references</h4></aside><br><aside class=related><h3 class="text-2xl font-black tracking-tight text-primary-500 capitalize dark:text-primary-300 sm:text-2xl">Related Content</h3><ul><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/java/lang/references_and_reachability_in_java>Java 中的引用与对象可达性</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/java/lang/proxy>Java 代理</a></p><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-primary-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/posts/java/lang/reflection>Java 反射</a></p></ul></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/pages class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p><p class="mt-2 text-base text-center text-gray-400">Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/sawhney17/logseq-schrodinger>logseq-schrodinger</a>.</p></div></footer></body></html>
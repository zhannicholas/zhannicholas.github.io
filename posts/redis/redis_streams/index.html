<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/images/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/images/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/images/favicon/favicon-16x16.png><meta name=theme-color content="#ffffff"><title itemprop=name>Redis Streams</title><meta property="og:title" content="Redis Streams"><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta itemprop=name content="Redis Streams NZ's Digital Garden"><meta name=application-name content="Redis Streams NZ's Digital Garden"><meta name=author content="Nicholas Zhan"><meta name=description content><meta itemprop=description content><meta name=url content="https://zhannicholas.github.io/posts/redis/redis_streams/"><link rel=canonical href=https://zhannicholas.github.io itemprop=url><script type=application/ld+json>{"@context":"https://schema.org","@type":"Dentist","name":"NZ\u0027s Digital Garden","description":"","slogan":"","openingHours":"","telephone":"","email":"","vatID":"","url":"https:\/\/zhannicholas.github.io","logo":"https:\/\/zhannicholas.github.io/images/logo_small.png","image":"https:\/\/zhannicholas.github.io/images/logo_full.png","address":{"@type":"PostalAddress","streetAddress":" ","addressLocality":"","addressRegion":"","postalCode":"","addressCountry":""},"geo":{"@type":"GeoCoordinates","latitude":"","longitude":""},"sameAs":[]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/zhannicholas.github.io"},{"@type":"ListItem","position":3,"name":"Posts","item":"https:\/\/zhannicholas.github.io\/posts\/"},{"@type":"ListItem","position":4,"name":"Redis","item":"https:\/\/zhannicholas.github.io\/posts\/redis\/"},{"@type":"ListItem","position":5,"name":"Redis Streams","item":"https:\/\/zhannicholas.github.io\/posts\/redis\/redis_streams\/"}]}</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/main.min.710986944c2e6da1b8df15c5e0c7999affdc4e9ebac27cc9e6df4208f465c990609147ac1865f2be657443a9658b90c9492b300f4990327501d2b36e9be544f8.css" integrity="sha512-cQmGlEwubaG43xXF4MeZmv/cTp66wnzJ5t9CCPRlyZBgkUesGGXyvmV0Q6lli5DJSSswD0mQMnUB0rNum+VE+A==" media=screen><script type=module>
  import Alpine from '/js/alpinejs.js';
  window.Alpine = Alpine;
  Alpine.start();
</script><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(console.log("add dark"),document.documentElement.classList.add("dark")):(console.log("remove dark"),document.documentElement.classList.remove("dark"))</script></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt="'s Digital Garden Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">'s Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts/>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/notes/>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library/>Library</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/til/>Today I Learned</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now/>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about/>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Redis Streams</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#stream%e7%94%9f%e4%ba%a7%e8%80%85>Stream生产者</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#redis-stream%e7%9a%84%e7%94%9f%e4%ba%a7%e8%80%85api>Redis Stream的生产者API</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b6%88%e6%81%afid>消息ID</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b6%88%e6%81%af%e5%86%85%e5%ae%b9>消息内容</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%ae%a1%e7%90%86stream%e7%9a%84%e9%95%bf%e5%ba%a6>管理Stream的长度</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%8c%83%e5%9b%b4%e6%9f%a5%e8%af%a2>范围查询</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e8%bf%ad%e4%bb%a3stream>迭代Stream</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%9f%a5%e8%af%a2%e5%8d%95%e6%9d%a1%e6%b6%88%e6%81%af>查询单条消息</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b6%88%e8%b4%b9%e8%80%85>消费者</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e9%98%bb%e5%a1%9e%e5%9e%8b%e6%b6%88%e8%b4%b9%e8%80%85>阻塞型消费者</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b6%88%e8%b4%b9%e7%bb%84>消费组</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%88%9b%e5%bb%ba%e6%b6%88%e8%b4%b9%e7%bb%84>创建消费组</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b7%bb%e5%8a%a0%e6%b6%88%e8%b4%b9%e8%80%85%e5%88%b0%e6%b6%88%e8%b4%b9%e7%bb%84>添加消费者到消费组</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86%e5%ae%8c%e6%88%90%e7%a1%ae%e8%ae%a4>消息处理完成确认</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e7%ae%a1%e7%90%86%e6%b6%88%e8%b4%b9%e7%bb%84>管理消费组</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%bf%ae%e6%94%b9%e6%b6%88%e8%b4%b9%e8%80%85%e7%9a%84%e4%bd%8d%e7%bd%ae>修改消费者的位置</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%88%a0%e9%99%a4%e6%b6%88%e8%b4%b9%e7%bb%84>删除消费组</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e4%bb%8e%e6%b6%88%e8%b4%b9%e7%bb%84%e5%88%a0%e9%99%a4%e6%b6%88%e8%b4%b9%e8%80%85>从消费组删除消费者</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%b6%88%e8%b4%b9%e5%a4%b1%e8%b4%a5%e9%97%ae%e9%a2%98>消费失败问题</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%9f%a5%e7%9c%8b%e6%9c%aa%e7%a1%ae%e8%ae%a4%e7%9a%84%e6%b6%88%e6%81%af>查看未确认的消息</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e6%9b%b4%e6%8d%a2%e6%b6%88%e8%b4%b9%e8%80%85>更换消费者</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99>参考资料</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>作为Redis 5.0中推出的全新数据结构，<code>stream</code>的行为就像<code>append-only log</code>一样，但它由基数树(<code>radix tree</code>)实现。<code>stream</code>由<code>entry</code>构成。它具有很多特性：<code>stream</code>的<code>entry</code>保存了一组<code>field-value</code>对，和<code>hash</code>十分类似。除了<code>field-value</code>对，每个<code>entry</code>都具有唯一<code>ID</code>，默认情况下，这个<code>ID</code>的形式为：<code>&lt;millisecond-timestamp>-&lt;sequence number></code>。<code>stream</code>支持基于<code>ID</code>的范围查询，若将时间戳作为<code>ID</code>的前缀，便可以实现基于时间的范围查询。<code>entry</code>一旦被创建，其存储的内容就不能被修改，但我们可以从<code>stream</code>中删除某个<code>entry</code>。若要向<code>stream</code>中添加<code>entry</code>，<u>只能</u>通过在<code>stream</code>的<u>末尾</u>追加这个<code>entry</code>的方式进行。最后，<code>stream</code>同时支持阻塞和非阻塞的消费模式，可以被多个不同的消费组消费或处理，这些消费组相当于<code>stream</code>的订阅者。<code>stream</code>和<code>Pub/Sub</code>最大的区别在于：<u><code>stream</code>会为了后续客户端的消费而在内存中保存数据，<code>Pub/Sub</code>不保存任何消息</u>。</p><h2 id=stream生产者>Stream生产者</h2><p>通常情况下，<code>producer</code>从一个或多个源读取数据，然后将它们写入到<code>stream</code>。</p><h3 id=redis-stream的生产者api>Redis Stream的生产者API</h3><p><code>Redis Stream Producer API</code>允许<code>producer</code>将任何消息(<code>entry</code>)追加到<code>stream</code>的末尾，整个API只包含一个命令——<strong><code>XADD key ID field value [field value ...]</code></strong>。 **<code>XADD</code><strong>命令用于将一个<code>entry</code>追加到<code>stream</code>，当<code>key</code>不存在时，还会新建一个<code>stream</code>：第一个参数<code>key</code>代表一个特定的<code>stream</code>，<code>ID</code>表示消息的<code>ID</code>，通常情况下我们会使用<code>*</code>来告诉Redis我们希望由Redis来生成这个<code>ID</code>，接下来是<code>entry</code>的内容。</strong><code>XADD</code>**会将新加入<code>stream</code>的消息的<code>ID</code>作为返回值返回。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xadd numbers * n 0
&#34;1587959118318-0&#34;
&gt; xadd numbers * n 1
&#34;1587959128680-0&#34;
&gt; type numbers
stream
</code></pre><h4 id=消息id>消息ID</h4><p><code>ID</code>是唯一的，并且每个消息有且只有一个<code>ID</code>，它代表着消息在<code>stream</code>中的位置。也就是说：越接近于<code>stream</code>开头的消息的<code>ID</code>越小，越接近于<code>stream</code>末尾的消息的<code>ID</code>越大。消息的<code>ID</code>是不可变的，一旦被创建，就不能再被修改。</p><p>我们可以在一个命令的前面加上一个数字，然后Redis会多次执行这个命令。这能帮助我们更好的观察Redis自动生成消息<code>ID</code>的特点：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; 7 xadd letter_number * a 1
&#34;1587960623524-0&#34;
&#34;1587960623525-0&#34;
&#34;1587960623525-1&#34;
&#34;1587960623526-0&#34;
&#34;1587960623526-1&#34;
&#34;1587960623527-0&#34;
&#34;1587960623527-1&#34;
</code></pre><p>这里重复执行了<code>7</code>次<code>xadd letter_number * a 1</code>。Redis自动生成的消息<code>ID</code>的格式为：<code>&lt;millisecond-timestamp>-&lt;sequence number></code>。可以发现：当<code>timestamp</code>相同时，<code>sequence number</code>会不断自增(多个消息可能会在同一个时间出现，用自增保证<code>ID</code>的唯一性)。每到一个新的时刻，<code>sequence number</code>会重置为<code>0</code>。</p><p>实际上，<code>ID</code>包括两个数字(64位无符号整数)，数字之间用<code>-</code>分隔。<code>ID</code>是总是自增的，这体现在组成ID的两个数字的自增上。插入一个<code>ID</code>比当前<code>stream</code>中最大<code>entry</code>的<code>ID</code>还小的<code>entry</code>是不被接受的。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xadd letter_number 1-1 a 1
(error) ERR The ID specified in XADD is equal or smaller than the target stream top item
</code></pre><p>有时候，我们可能希望使用自己的<code>ID</code>，这个时候我们需要保证自己的<code>ID</code>是自增的，一个有效的<code>ID</code>必须大于<code>0-0</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xadd mystream 0-0 max 100
(error) ERR The ID specified in XADD must be greater than 0-0
&gt; xadd mystream 0-1 max 100
&#34;0-1&#34;
&gt; xadd mystream 1-1 max 10
&#34;1-1&#34;
</code></pre><p>插入消息时，我们也可以将<code>ID</code>指定为一个数字，称为<code>partial ID</code>，这个时候Redis会自动帮我们添加<code>sequence number</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xadd mystream 2 max 111
&#34;2-0&#34;   // Redis自动添加sequence number
</code></pre><h4 id=消息内容>消息内容</h4><p>**<code>XADD</code>**命令不接收空消息，一个消息至少包含一个<code>field-value</code>对。每一个<code>field</code>上的<code>value</code>都是一个普通的Redis字符串。消息的内容对Redis来说时不透明的，Redis本身也不处理消息的内容。</p><h3 id=管理stream的长度>管理Stream的长度</h3><p>**<code>XLEN key</code>**可以用来查看<code>stream</code>中消息(<code>entry</code>)的数量，若<code>key</code>不存在，将返回0(就像<code>stream</code>是空的一样)。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xlen ms-1
(integer) 0
&gt; xadd ms-1 0-1 f1 v1 f2 v2
&#34;0-1&#34;
&gt; xadd ms-1 1-1 f1 v1 f2 v2
&#34;1-1&#34;
&gt; xlen ms-1
(integer) 2
</code></pre><p>**<code>XDEL key ID [ID ...]</code>**用来从<code>stream</code>中删除消息，返回实际被删除消息的数量。虽然<code>stream</code>是一个<code>append-only</code>的数据结构，但它是保存在内存中的，所以我们可以执行删除操作。当删除某个消息时，并不是真正删除，而是<a href=https://redis.io/commands/xdel#understanding-the-low-level-details-of-entries-deletion target=_blank>标记删除</a>
，当满足一定条件时，才会进行真正的删除操作。即使<code>stream</code>中的所有消息都被删除，<code>stream</code>为空时，<code>stream</code>本身也不会被删除，要删除它，可以使用 **<code>DEL</code>**或 <strong><code>UNLINK</code></strong>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xdel ms-1 0-1 1-1
(integer) 2
&gt; xlen ms-1
(integer) 0
&gt; exists ms-1
(integer) 1
&gt; del ms-1
(integer) 0
</code></pre><p>使用 **<code>XDEL</code>**可以限制<code>stream</code>的长度，但我们需要知道消息的<code>ID</code>。为了防止<code>stream</code>无限扩大，Redis也允许我们对<code>stream</code>进行修剪(<code>trim</code>)，即限制<code>stream</code>长度的上限。 **<code>XTRIM key MAXLEN [~] count</code><strong>将<code>stream</code>的长度限制为<code>count</code>，当<code>stream</code>长度超过上限，</strong><code>XTRIM</code>**会开始删除<code>stream</code>中<code>ID</code>最小的消息。然而，使用<code>MAXLEN</code>对<code>stream</code>进行修建的开销非常大，这和<code>entry</code>底层的基数树(<code>radix tree</code>)中采用的宏结点(<code>macro node</code>)有关系。命令提供了一个可选参数<code>~</code>，<code>XTRIM mystream MAXLEN ~ 1000</code>表示：并不是真的不能超过1000，消息的数量可以操作1000且至少是1000。当Redis移除整个宏结点时才会进行修剪操作。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xadd ms-2 0-1 f1 v1
&#34;0-1&#34;
&gt; xadd ms-2 0-2 f1 v1
&#34;0-2&#34;
&gt; xadd ms-2 0-3 f1 v1
&#34;0-3&#34;
&gt; xtrim ms-2 MAXLEN 2
(integer) 1     // 有一个entry被删除
&gt; xlen ms-2
(integer) 2
</code></pre><p>如果需要一直限制<code>stream</code>的长度，除了周期性的手动调用 <strong><code>XTRIM</code></strong>，还可以利用 **<code>XADD</code>**提供的<code>MAXLEN</code>来在我们添加<code>entry</code>时自动修剪<code>strean</code>，例如：<code>xadd ms-3 maxlen ~ 2 * f1 v1</code>。</p><h2 id=范围查询>范围查询</h2><p>**<code>XRANGE key start end [COUNT count]</code>**查询<code>ID</code>在<code>[start, end]</code>之间的所有<code>entry</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; 10 xadd ms-3 * f1 v1  // 生成10条消息
&#34;1587969310313-0&#34;
&#34;1587969310313-1&#34;
&#34;1587969310314-0&#34;
&#34;1587969310314-1&#34;
&#34;1587969310314-2&#34;
&#34;1587969310315-0&#34;
&#34;1587969310315-1&#34;
&#34;1587969310316-0&#34;
&#34;1587969310316-1&#34;
&#34;1587969310316-2&#34;
&gt; xrange ms-3 1587969310313-0 1587969310313-1
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
2) 1) &#34;1587969310313-1&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><p><code>-</code>和<code>+</code>表示<code>stream</code>可能存在的最小<code>ID</code>和最大<code>ID</code>，<code>-</code>等价于<code>0-0</code>，<code>+</code>等价于<code>18446744073709551615-18446744073709551615</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xrange ms-3 - +           // 使用-和+
 1) 1) &#34;1587969310313-0&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 2) 1) &#34;1587969310313-1&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 3) 1) &#34;1587969310314-0&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 4) 1) &#34;1587969310314-1&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 5) 1) &#34;1587969310314-2&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 6) 1) &#34;1587969310315-0&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 7) 1) &#34;1587969310315-1&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 8) 1) &#34;1587969310316-0&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
 9) 1) &#34;1587969310316-1&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
10) 1) &#34;1587969310316-2&#34;
    2) 1) &#34;f1&#34;
       2) &#34;v1&#34;
</code></pre><p>此外，还可以使用<code>partial ID</code>。例如：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt;  xrange ms-3 1587969310313 1587969310314
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
2) 1) &#34;1587969310313-1&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
3) 1) &#34;1587969310314-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
4) 1) &#34;1587969310314-1&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
5) 1) &#34;1587969310314-2&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><p>可选参数<code>count</code>可以限制返回结果数量的上限：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt;  xrange ms-3 1587969310313 1587969310314 count 1
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><h3 id=迭代stream>迭代Stream</h3><p>结合<code>ID</code>自增的特性和 **<code>XRANGE</code>**的<code>count</code>参数，我们可以完成对整个<code>stream</code>的迭代。首先：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xrange ms-3 - + count 2
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
2) 1) &#34;1587969310313-1&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><p>然后将当前迭代返回的最后一个<code>ID</code>的<code>sequence number</code>加一，作为下一次迭代的起始<code>ID</code>：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xrange ms-3 1587969310313-1 + count 2
1) 1) &#34;1587969310313-1&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
2) 1) &#34;1587969310314-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><p>重复这个过程即可。以上演示的是<code>ID</code>从小到大的正向迭代过程，若要从大到小进行反向迭代，可以使用 <strong><code>XREVRANGE key end start [COUNT count]</code></strong>。</p><h3 id=查询单条消息>查询单条消息</h3><p>如果只需要查询单条消息，可以将<code>count</code>参数设为<code>1</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xrange ms-3 1587969310313-0 + count 1
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><p>因为 **<code>XRANGE</code>**和 **<code>XREVRANGE</code>**采用的是闭区间，所以当<code>start</code>和<code>end</code>相同时，查询的结果就是单条消息。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xrange ms-3 1587969310313-0 1587969310313-0
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
&gt; xrevrange ms-3 1587969310313-0 1587969310313-0
1) 1) &#34;1587969310313-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><h2 id=消费者>消费者</h2><p>有时候，我们并不希望主动去查询<code>stream</code>，而是希望当<code>stream</code>中有新的消息时，新的消息可以直接推送给我们，也就是订阅<code>stream</code>。**<code>XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] id [id ...]</code>**正是用来监听<code>stream</code>中新的消息的。例如：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xread count 1 streams ms-3 0
1) 1) &#34;ms-3&#34;
   2) 1) 1) &#34;1587969310313-0&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
</code></pre><p>**<code>XREAD</code>**不支持<code>-</code>和<code>+</code>，<code>id</code>表示消费者上一次收到的消息<code>ID</code>，所以返回的消息<code>ID</code>都会大于<code>id</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xread count 1 streams ms-3 1587969310313-0
1) 1) &#34;ms-3&#34;
   2) 1) 1) &#34;1587969310313-1&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
</code></pre><h3 id=阻塞型消费者>阻塞型消费者</h3><p>默认情况下，**<code>XREAD</code>**是非阻塞的。通过使用可选的<code>[BLOCK] milliseconds</code>参数，我们可以将 **<code>XREAD</code><strong>变成阻塞操作。在消息到来之前，</strong><code>XREAD</code>**会在新消息到来之前阻塞阻塞一段时间，若在超时之前有新的消息到来，则结束阻塞并返回新的消息，否则超时自动返回。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xrevrange ms-3 + - count 2    // 获取最新的两条消息
1) 1) &#34;1587969310316-2&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
2) 1) &#34;1587969310316-1&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
&gt; xread count 1 block 1000 streams ms-3 1587969310316-1 // 因为有消息，直接返回
1) 1) &#34;ms-3&#34;
   2) 1) 1) &#34;1587969310316-2&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
&gt; xread count 1 block 1000 streams ms-3 1587969310316-2 // 没有新的消息，阻塞，超时返回
(nil)
(1.03s)
</code></pre><p><code>BLOCK 0</code>表示新消息到来之前一直阻塞，不会超时返回。在<code>client-2</code>上阻塞，<code>$</code>表示当前<code>stream</code>中最新消息的<code>ID</code>(使用<code>$</code>之后，每个消息最多收到一次)，所以<code>client-2</code>会一直阻塞：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>client-2:6379&gt; xread count 1 block 0 streams ms-3 $
</code></pre><p>这个时候在<code>client-1</code>上向<code>ms-3</code>中写入一条消息：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>client-1:6379&gt; xadd ms-3 * f1 v1
&#34;1587974321051-0&#34;
</code></pre><p><code>client-2</code>收到消息，结束阻塞，返回：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>client-2:6379&gt; xread count 1 block 0 streams ms-3 $
1) 1) &#34;ms-3&#34;
   2) 1) 1) &#34;1587974321051-0&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
(23.59s)
</code></pre><h2 id=消费组>消费组</h2><p>**<code>XREAD</code>**可以让多个消费者都获取到<code>stream</code>中的所有消息。将所有的消息同时分发给多个消费者有时候并不能提高效率，因为多个消费者可能做着重复的工作，而我们只需要一份结果。一个比较好的处理方式是：<u>将<code>stream</code>中的消息划分为多个彼此不重叠的子集，然后将不同的子集分发给不同消费者处理</u>。为了处理一个大的任务，多个物理消费者可以联合起来，每个物理消费者处理不同的部分，外界看起来就像只有一个消费者一样，这样，多个物理消费者构成了一个逻辑消费者，外界看到的正是这个逻辑消费者。在Redis里，这个逻辑消费者就是一个消费组(<strong>Consumer Group</strong>)，物理消费者可以根据实际需要加入或者离开逻辑消费者，逻辑消费者从<code>stream</code>中获取数据，数据由多个物理消费者进行处理，并且：</p><ol><li>同一个消息不会被分发给多个消费者</li><li>消费组中的每一个消费者都通过名字唯一识别，名字是一个大小写敏感的字符串</li><li>每个消费组都有<em>first ID never consumed</em>的概念，这样一来，当一个消费者请求新的消息时，它可以提供从未被交付过的消息</li><li>使用特定的命令作为某个消息已经被正确处理的确认，此后该消息可以被移出消费组了</li><li>消费组追踪每个当前被分发给某个消费者但还未收到处理完成的确认的消息，消息的这种状态被称为<code>pending</code>。Redis使用<code>Pending Entries List (PEL)</code>来追踪这些消息</li></ol><p>**<code>XGROUP [CREATE key groupname id-or-$] [SETID key groupname id-or-$] [DESTROY key groupname] [DELCONSUMER key groupname consumername]</code>**是一个用来管理和<code>key</code>上<code>stream</code>相关联的消费组的命令。</p><h3 id=创建消费组>创建消费组</h3><p>要创建一个消费组，可以使用 **<code>XGROUP CREATE key groupname id-or $</code>**子命令。最后一个参数<code>id-or-$</code>是消费组开始消费的消息的<code>ID</code>(不包括这个<code>ID</code>代表的消息)。如果希望消费组从下一个最新的消息开始消费，可以使用<code>$</code>，<code>$</code>表示<code>stream</code>中的最后一个消息的<code>ID</code>。如果希望消费组消费<code>stream</code>中的所有消息，可以使用<code>0</code>作为传入<code>ID</code>。如果消费组已经存在，命令将放回一个<code>-BUSYGROUP</code>错误，否则创建成功并返回OK。</p><p>如果<code>stream</code>不存在，命令会返回一个错误，可以在<code>ID</code>后面新增一个可选<code>MKSTREAM</code>子命令让Redis自动创建一个<code>stream</code>，这个时候创建出来的<code>stream</code>的长度为<code>0</code>。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xgroup create ms-4 group0 0   // ms-4不存在
(error) ERR The XGROUP subcommand requires the key to exist. Note that for CREATE you may want to use the MKSTREAM option to create an empty stream automatically.
&gt; xgroup create ms-4 group0 0 MKSTREAM  // 创建group0，并让Redis自动创建出stream
OK
&gt; exists ms-4
(integer) 1
&gt; xadd ms-4 0-1 f1 v1   // 添加一条消息到ms-4
&#34;0-1&#34;
&gt; xgroup create ms-4 group1 $   // 创建group1
OK
&gt; xadd ms-4 1-1 f1 v1
&#34;1-1&#34;
&gt; xinfo groups ms-4
1) 1) &#34;name&#34;
   2) &#34;group0&#34;
   3) &#34;consumers&#34;
   4) (integer) 0
   5) &#34;pending&#34;
   6) (integer) 0
   7) &#34;last-delivered-id&#34;
   8) &#34;0-0&#34;
2) 1) &#34;name&#34;
   2) &#34;group1&#34;
   3) &#34;consumers&#34;
   4) (integer) 0
   5) &#34;pending&#34;
   6) (integer) 0
   7) &#34;last-delivered-id&#34;
   8) &#34;0-1&#34;
</code></pre><p>每个消费组都与一个<code>stream</code>以及最近交付的消息<code>ID</code>(即上面的<code>last-delivered-id</code>)相关联。</p><h4 id=添加消费者到消费组>添加消费者到消费组</h4><p>**<code>XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]</code>**是 **<code>XREAD</code>**的一个特殊版本，它支持Consumer Group。<code>STREAMS</code>选项的<code>ID</code>可以是以下两种形式：</p><ul><li><code>></code>。<code>></code>是一个特殊的<code>ID</code>，表示消费者只想接收那些从未被交付给任何其他消费者的消息，即消费者想收到一个从未被交付过的消息</li><li>任何其它的<code>ID</code>，即<code>0</code>，其它有效<code>ID</code>或<code>partial ID</code>。这个时候，我们可以得到消费者的<code>PEL</code>(返回的<code>PEL</code>中的<code>ID</code>比传递的<code>ID</code>都要大)，而<code>BLOCK</code>和<code>NOACK</code>参数会被忽略。</li></ul><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xreadgroup group group0 consumerA count 1 block 1000 streams ms-4 &gt;
1) 1) &#34;ms-4&#34;
   2) 1) 1) &#34;0-1&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
&gt; xreadgroup group group0 consumerA streams ms-4 0  // 查看consumerA的PEL
1) 1) &#34;ms-4&#34;
   2) 1) 1) 0-1&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
</code></pre><p>上面这条命令让消费者<code>consumerA</code>加入到了<code>group0</code>中并消费了一条消息。如果这个时候我们再次执行<code>xinfo groups ms-4</code>，会得到和上一次不同的结果：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xinfo groups ms-4
1) 1) &#34;name&#34;
   2) &#34;group0&#34;
   3) &#34;consumers&#34;
   4) (integer) 1
   5) &#34;pending&#34;
   6) (integer) 1
   7) &#34;last-delivered-id&#34;   // 0-1已被group0中的consumerA消费
   8) &#34;0-1&#34;
2) 1) &#34;name&#34;
   2) &#34;group1&#34;
   3) &#34;consumers&#34;
   4) (integer) 0
   5) &#34;pending&#34;
   6) (integer) 0
   7) &#34;last-delivered-id&#34;
   8) &#34;0-1&#34;
</code></pre><p>若要查看某个消费组中的消费者信息，可以使用 <strong><code>XINFO CONSUMERS &lt;key> &lt;group></code></strong>：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xinfo consumers ms-4 group0
1) 1) &#34;name&#34;
   2) &#34;comsumerA&#34;
   3) &#34;pending&#34;
   4) (integer) 1
   5) &#34;idle&#34;
   6) (integer) 905911
</code></pre><h3 id=消息处理完成确认>消息处理完成确认</h3><p>**<code>XACK key group ID [ID ...]</code>**从消费组的<code>PEL</code>移除一个或多个消息，表示他们已被成功处理。假设<code>group0</code>中的consumerA已经将<code>0-1</code>这条消息处理完成，它需要告知Redis服务器它已经这条消息处理完毕：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xack ms-4 group0 0-1  // 发送确认
(integer) 1
&gt; xreadgroup group group0 consumerA streams ms-4 0  // 查看consumerA的PEL
1) 1) &#34;ms-4&#34;
   2) (empty list or set)
</code></pre><p>当消息处理失败时，没有 **<code>XACK</code>**确认，消费者可以再次进行消费。有时候，当失败在可接受范围内时，我么可以使用 **<code>XREADGROUP</code>**中的子命令 **<code>NOACK</code>**来告诉Redis不需要进行确认，Redis会认为 **<code>XREADGROUP</code>**返回的所有消息都已确认，因此不用再维护对应的<code>PEL</code>。</p><h3 id=管理消费组>管理消费组</h3><p>先准备一些测试数据，创建3个消费组，它们都从最新的消息开始消费：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xgroup create ms-5 group0 $ MKSTREAM
OK
&gt; xgroup create ms-5 group1 $
OK
&gt; xgroup create ms-5 group3 $
OK
</code></pre><p>向<code>ms-5</code>中写入7条消息：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; 7 xadd ms-5 * f1 v1
&#34;1587991174542-0&#34;
&#34;1587991174542-1&#34;
&#34;1587991174542-2&#34;
&#34;1587991174543-0&#34;
&#34;1587991174543-1&#34;
&#34;1587991174543-2&#34;
&#34;1587991174544-0&#34;
</code></pre><h4 id=修改消费者的位置>修改消费者的位置</h4><p>**<code>XGROUP SETID key groupname id-or-$</code>**允许我们修改消费组的<code>last-delivered-id</code>的值，进而改变接下来要消费的消息(即消费者的位置)。若要重新消费所有消息，可以使用：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xgroup setid ms-5 group1 0
OK
</code></pre><p>若现在指向消费最新的消息，则可以使用：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xgroup setid ms-5 group1 $
OK
</code></pre><h4 id=删除消费组>删除消费组</h4><p>因为并不会自动删除未使用的消费组，所以我们需要自己来做这件事情。**<code>XGROUP DESTROY key groupname</code>**会永久删除某个消费组和相关的消费者。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xgroup destroy ms-5 group3  // 删除group3
(integer) 1
</code></pre><h4 id=从消费组删除消费者>从消费组删除消费者</h4><p>**<code>XGROUP DELCONSUMER key groupname consumername</code>**命令用于从消费组里面删除消费者，它还会删除消费者对应的<code>PEL</code>，返回值为被删消费的的<code>PEL</code>中的消息数量。</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xreadgroup group group0 consumerA count 1 block 1000 streams ms-5 &gt;
1) 1) &#34;ms-5&#34;
   2) 1) 1) &#34;1587991174542-0&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
&gt; xreadgroup group group0 consumerB count 1 block 1000 streams ms-5 &gt;
1) 1) &#34;ms-5&#34;
   2) 1) 1) &#34;1587991174542-1&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
&gt; xinfo consumers ms-5 group0       // 查看group0中的消费者
1) 1) &#34;name&#34;
   2) &#34;consumerA&#34;
   3) &#34;pending&#34;
   4) (integer) 1
   5) &#34;idle&#34;
   6) (integer) 88581
2) 1) &#34;name&#34;
   2) &#34;consumerB&#34;
   3) &#34;pending&#34;
   4) (integer) 1
   5) &#34;idle&#34;
   6) (integer) 79710
&gt; xgroup delconsumer ms-5 group0 consumerB   // 删除group0中的consumerB
(integer) 1
&gt; xinfo consumers ms-5 group0
1) 1) &#34;name&#34;
   2) &#34;consumerA&#34;
   3) &#34;pending&#34;
   4) (integer) 1
   5) &#34;idle&#34;
   6) (integer) 1540978
</code></pre><p>在删除消费者的时候一定要消息，因为它可能还有未确认的消息(<code>PEL</code>不为空)。</p><h3 id=消费失败问题>消费失败问题</h3><p>理想情况下，所有交付的消息都会被确认(<strong><code>XACK</code></strong>)。但是有时候，消费者可能在发出 **<code>XACK</code>**之前就已经下线了，这个时候未确认的消息就会一直留在<code>PEL</code>中。</p><h4 id=查看未确认的消息>查看未确认的消息</h4><p>有两种方式可以查看未确认的消息：**<code>XINFO CONSUMERS key group</code>**和 <strong><code>XPENDING key group [start end count] [consumer]</code></strong>。</p><p>先准备测试数据，创建消费组<code>group0</code>并向<code>ms-6</code>中写入5条消息，然后添加消费者<code>consumerA</code>：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xgroup create ms-6 group0 0 MKSTREAM
OK
&gt; 5 xadd ms-6 * f1 v1
&#34;1587996240331-0&#34;
&#34;1587996240331-1&#34;
&#34;1587996240332-0&#34;
&#34;1587996240332-1&#34;
&#34;1587996240333-0&#34;
&gt; xreadgroup group group0 consumerA count 1 block 1000 streams ms-6 &gt;
1) 1) &#34;ms-6&#34;
   2) 1) 1) &#34;1587996240331-0&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
</code></pre><p>查看消息确认状态：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xinfo consumers ms-6 group0
1) 1) &#34;name&#34;
   2) &#34;consumerA&#34;
   3) &#34;pending&#34;
   4) (integer) 1
   5) &#34;idle&#34;
   6) (integer) 44813
&gt; xpending ms-6 group0
1) (integer) 1
2) &#34;1587996240331-0&#34;
3) &#34;1587996240331-0&#34;
4) 1) 1) &#34;consumerA&#34;
      2) &#34;1&#34;
</code></pre><p>结果显示<code>consumerA</code>消费的一条消息还未确认。</p><h4 id=更换消费者>更换消费者</h4><p>假设<code>consumerA</code>在发送确认消息之前下线了，为了继续处理<code>consumerA</code>在下线前未处理完的消息，我们可以使用 **<code>XCLAIM key group consumer min-idle-time ID [ID ...] [IDLE ms] [TIME ms-unix-time] [RETRYCOUNT count] [FORCE] [JUSTID]</code>**命令让另一个消费者获得未处理完的消息并继续处理。</p><p>先创建一个消费者<code>consumerB</code>：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xreadgroup group group0 consumerB count 1 block 1000 streams ms-6 &gt;
1) 1) &#34;ms-6&#34;
   2) 1) 1) &#34;1587996240331-1&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
&gt; xack ms-6 group0 1587996240331-1
(integer) 1
&gt; xreadgroup group group0 consumerB streams ms-6 0
1) 1) &#34;ms-6&#34;
   2) (empty list or set)     // consumerB的消息都已经处理完并确认
</code></pre><p>将<code>consumerA</code>未处理完的消息<code>1587996240331-0</code>转交给<code>consumerB</code>：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xclaim ms-6 group0 consumerB 1000 1587996240331-0
1) 1) &#34;1587996240331-0&#34;
   2) 1) &#34;f1&#34;
      2) &#34;v1&#34;
</code></pre><p>查看<code>consumerA</code>和<code>consumerB</code>的<code>PEL</code>：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xreadgroup group group0 consumerA streams ms-6 0
1) 1) &#34;ms-6&#34;
   2) (empty list or set)
&gt; xreadgroup group group0 consumerB streams ms-6 0
1) 1) &#34;ms-6&#34;
   2) 1) 1) &#34;1587996240331-0&#34;
         2) 1) &#34;f1&#34;
            2) &#34;v1&#34;
</code></pre><p>如果我们运行 <strong><code>XPENDING</code></strong>，也可以发现消息<code>1587996240331-0</code>现在归<code>consumerB</code>所有：</p><pre tabindex=0><code class=language-Redis data-lang=Redis>&gt; xpending ms-6 group0
1) (integer) 1
2) &#34;1587996240331-0&#34;
3) &#34;1587996240331-0&#34;
4) 1) 1) &#34;consumerB&#34;
      2) &#34;1&#34;
</code></pre><h2 id=参考资料>参考资料</h2><ol><li><a href=https://redis.io/topics/streams-intro target=_blank>Introduction to Redis Streams</a>
.</li></ol></div></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts/ class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes/ class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library/ class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer><script type=text/javascript src=https://zhannicholas.github.io/js/app.min.5ce6717c9c557de80f2d726a4693ef2581084ac7685dfb48c6a73140cf8a6bbd5bd8f76b0dbfe285737c83b968be59d2db22198e4e39d5b0bc42e7571630c4b1.js integrity="sha512-XOZxfJxVfegPLXJqRpPvJYEISsdoXftIxqcxQM+Ka71b2PdrDb/ihXN8g7lovlnS2yIZjk451bC8QudXFjDEsQ=="></script></body></html>
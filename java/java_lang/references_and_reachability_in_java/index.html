<!doctype html><html lang=zh-cn dir=auto><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="JDK 1.2 之后，Java 将引用分为强引用（Strongly Reference）、软引用（Soft Reference）、弱引用（Weak Refere">
<meta name=theme-color content="#ffcd00">
<meta property="og:title" content="Java 中的引用与对象可达性 • Nicholas Zhan">
<meta property="og:description" content="JDK 1.2 之后，Java 将引用分为强引用（Strongly Reference）、软引用（Soft Reference）、弱引用（Weak Refere">
<meta property="og:url" content="https://zhannicholas.github.io/java/java_lang/references_and_reachability_in_java/">
<meta property="og:site_name" content="Nicholas Zhan">
<meta property="og:type" content="article"><meta property="og:image" content="https://www.gravatar.com/avatar/85f2cc2a45fd9533b91a65214224f9d7?s=256"><meta property="article:section" content="java"><meta property="article:tag" content="Java"><meta property="article:published_time" content="2021-04-20T21:40:00+08:00"><meta property="article:modified_time" content="2021-04-20T21:40:00+08:00"><meta name=twitter:card content="summary">
<meta name=generator content="Hugo 0.88.1">
<title>Java 中的引用与对象可达性 • Nicholas Zhan</title>
<link rel=canonical href=https://zhannicholas.github.io/java/java_lang/references_and_reachability_in_java/>
<link rel=icon href=/favicon.ico>
<link rel=stylesheet href=/assets/css/main.ab98e12b.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style>
</head>
<body class="page type-java has-sidebar">
<div class=site><div id=sidebar class=sidebar>
<a class=screen-reader-text href=#main-menu>跳到主菜单</a>
<div class=container><section class="widget widget-about sep-after">
<header>
<div class=logo>
<a href=/>
<img src=/images/logo.png>
</a>
</div>
<h2 class="title site-title">
<a href=/>
Nicholas Zhan
</a>
</h2>
<div class=desc>
Java Developer, Runner, Cyclist
</div>
</header>
</section>
<section class="widget widget-search sep-after">
<header>
<h4 class="title widget-title">搜索</h4>
</header>
<form action=/search id=search-form class=search-form>
<label>
<span class=screen-reader-text>搜索</span>
<input id=search-term class=search-term type=search name=q placeholder=搜索&mldr;>
</label></form>
</section>
<section class="widget widget-sidebar_menu sep-after"><nav id=sidebar-menu class="menu sidebar-menu" aria-label=侧边栏菜单>
<div class=container>
<ul><li class="item has-children has-current">
<a href=/java/>Java</a><button class=sub-menu-toggler>
<span class=screen-reader-text>expand sub menu</span>
<span class=sign></span>
</button>
<ul class=sub-menu><li class=item>
<a href=/java/jakartaee/>Jakarta EE</a></li><li class=item>
<a href=/java/jvm/>JVM</a></li><li class=item>
<a href=/java/concurrency/>并发</a></li></ul></li><li class=item>
<a href=/rust/>Rust</a></li><li class=item>
<a href=/distributed_computing/>分布式计算</a></li><li class=item>
<a href=/operating_systems/>操作系统</a></li><li class="item has-children">
<a href=/computer_networks/>计算机网络</a><button class=sub-menu-toggler>
<span class=screen-reader-text>expand sub menu</span>
<span class=sign></span>
</button>
<ul class=sub-menu><li class=item>
<a href=/computer_networks/http/>HTTP</a></li><li class=item>
<a href=/computer_networks/fundamentals/>基础知识</a></li></ul></li></ul>
</div>
</nav>
</section><section class="widget widget-taxonomy_cloud sep-after">
<header>
<h4 class="title widget-title">标签</h4>
</header>
<div class="container list-container">
<ul class="list taxonomy-cloud"><li>
<a href=/tags/communication/ style=font-size:1em>Communication</a>
</li><li>
<a href=/tags/c%E7%AE%97%E6%B3%95/ style=font-size:1.3846153846153846em>C算法</a>
</li><li>
<a href=/tags/english/ style=font-size:1em>English</a>
</li><li>
<a href=/tags/gc/ style=font-size:1.1538461538461537em>GC</a>
</li><li>
<a href=/tags/git/ style=font-size:1em>Git</a>
</li><li>
<a href=/tags/http/ style=font-size:1.5384615384615385em>HTTP</a>
</li><li>
<a href=/tags/hugo/ style=font-size:1em>Hugo</a>
</li><li>
<a href=/tags/jakartaee/ style=font-size:1.1538461538461537em>JakartaEE</a>
</li><li>
<a href=/tags/java/ style=font-size:2em>Java</a>
</li><li>
<a href=/tags/jdbc/ style=font-size:1em>JDBC</a>
</li><li>
<a href=/tags/jvm/ style=font-size:1.2307692307692308em>JVM</a>
</li><li>
<a href=/tags/leetcode/ style=font-size:1.1538461538461537em>Leetcode</a>
</li><li>
<a href=/tags/life/ style=font-size:1em>Life</a>
</li><li>
<a href=/tags/linux/ style=font-size:1.2307692307692308em>Linux</a>
</li><li>
<a href=/tags/mybatis/ style=font-size:1em>MyBatis</a>
</li><li>
<a href=/tags/networks/ style=font-size:1.1538461538461537em>Networks</a>
</li><li>
<a href=/tags/os/ style=font-size:1.4615384615384617em>OS</a>
</li><li>
<a href=/tags/ostep/ style=font-size:1.1538461538461537em>OSTEP</a>
</li><li>
<a href=/tags/python/ style=font-size:1em>Python</a>
</li><li>
<a href=/tags/redis/ style=font-size:1.5384615384615385em>Redis</a>
</li><li>
<a href=/tags/rpc/ style=font-size:1em>RPC</a>
</li><li>
<a href=/tags/rust/ style=font-size:1.3076923076923077em>Rust</a>
</li><li>
<a href=/tags/sicp/ style=font-size:1em>SICP</a>
</li><li>
<a href=/tags/spring/ style=font-size:1em>Spring</a>
</li><li>
<a href=/tags/spring-boot/ style=font-size:1em>Spring Boot</a>
</li><li>
<a href=/tags/tomcat/ style=font-size:1em>Tomcat</a>
</li><li>
<a href=/tags/zookeeper/ style=font-size:1em>ZooKeeper</a>
</li><li>
<a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97/ style=font-size:1.0769230769230769em>分布式计算</a>
</li><li>
<a href=/tags/%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF/ style=font-size:1.0769230769230769em>多处理器编程的艺术</a>
</li><li>
<a href=/tags/%E5%B7%A5%E7%A8%8B%E6%80%9D%E7%BB%B4/ style=font-size:1em>工程思维</a>
</li><li>
<a href=/tags/%E5%B9%B6%E5%8F%91/ style=font-size:1.4615384615384617em>并发</a>
</li><li>
<a href=/tags/%E6%90%9C%E7%B4%A2/ style=font-size:1em>搜索</a>
</li><li>
<a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/ style=font-size:1.0769230769230769em>数据库</a>
</li><li>
<a href=/tags/%E6%B8%B8%E8%AE%B0/ style=font-size:1em>游记</a>
</li><li>
<a href=/tags/%E7%8E%B0%E4%BB%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/ style=font-size:1.0769230769230769em>现代操作系统</a>
</li><li>
<a href=/tags/%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85/ style=font-size:1em>生产者消费者</a>
</li><li>
<a href=/tags/%E7%AE%97%E6%B3%95%E5%AF%BC%E8%AE%BA/ style=font-size:1.2307692307692308em>算法导论</a>
</li><li>
<a href=/tags/%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/ style=font-size:1em>设计原则</a>
</li><li>
<a href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ style=font-size:1.9230769230769231em>设计模式</a>
</li></ul>
</div>
</section>
</div>
<div class=sidebar-overlay></div>
</div><div class=main><nav id=main-menu class="menu main-menu" aria-label=主菜单>
<div class=container>
<a class=screen-reader-text href=#content>跳到内容</a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text>Toggle Sidebar</span>
<span class=open><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</span>
<span class=close><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
</span>
</button>
<ul><li class=item>
<a href=/>主页</a>
</li><li class=item>
<a href=/posts/>博客</a>
</li><li class=item>
<a href=/notebook/>笔记本</a>
</li><li class=item>
<a href=/itinerary/>游山玩水</a>
</li></ul>
</div>
</nav><div class=header-widgets>
<div class=container>
<style>.widget-breadcrumbs li:after{content:'\2f '}</style>
<section class="widget widget-breadcrumbs sep-after">
<nav id=breadcrumbs>
<ol><li><a href=/>主页</a></li><li><a href=/java/>Java</a></li><li><span>Java 中的引用与对象可达性</span></li></ol>
</nav>
</section></div>
</div>
<header id=header class="header site-header">
<div class="container sep-after">
<div class=header-info><p class="site-title title">Nicholas Zhan</p><p class="desc site-desc">Java Developer, Runner, Cyclist</p>
</div>
</div>
</header>
<main id=content>
<article lang=zh-cn class=entry>
<header class="header entry-header">
<div class="container sep-after">
<div class=header-info>
<h1 class=title>Java 中的引用与对象可达性</h1>
</div>
<div class=entry-meta>
<span class=posted-on><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
<span class=screen-reader-text>Posted on </span>
<time class=entry-date datetime=2021-04-20T21:40:00+08:00>2021, Apr 20</time>
</span>
<span class=byline><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M21 21V20c0-2.76-4-5-9-5s-9 2.24-9 5v1"/><path d="M16 6.37A4 4 0 1112.63 3 4 4 0 0116 6.37z"/></svg>
<span class=screen-reader-text> by </span><a href=/authors/zhannicholas>Nicholas Zhan</a></span>
<span class=reading-time><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg>
6 mins read
</span>
</div>
</div>
</header>
<details class="container entry-toc">
<summary class=title>
<span>目录</span>
</summary>
<nav id=TableOfContents>
<ul>
<li><a href=#对象可达性>对象可达性</a>
<ul>
<li><a href=#gc-roots>GC Roots</a></li>
<li><a href=#对象的五种可达性>对象的五种可达性</a></li>
</ul>
</li>
<li><a href=#强引用>强引用</a></li>
<li><a href=#软引用>软引用</a></li>
<li><a href=#弱引用>弱引用</a></li>
<li><a href=#虚引用>虚引用</a></li>
<li><a href=#参考资料>参考资料</a></li>
</ul>
</nav>
</details>
<div class="container entry-content">
<p>JDK 1.2 之后，Java 将引用分为强引用（Strongly Reference）、软引用（Soft Reference）、弱引用（Weak Reference）和虚引用（Phantom Reference）四种，这四种引用的强度依次减弱，它们与 Java 的对象回收有着很大的关系。</p>
<blockquote>
<p>A reference object encapsulates a reference to some other object so that the reference itself may be examined and manipulated like any other object. Three types of reference objects are provided, each weaker than the last: soft, weak, and phantom. Each type corresponds to a different level of reachability.</p>
</blockquote>
<p>这段话已经描述得很清楚了：Java 中有三种引用对象（reference object），它们封装了一些其它的对象，从而让我们可以像操作其它对象一样操作引用本身，不同引用对象的可达性不同。</p>
<p>除开与 Finalization 有关的类，下图展示了 <code>java.lang.ref</code> 包中的类结构：</p>
<p><img src=/images/java/java_lang/reference-class-hierarchy.png alt></p>
<p><code>Reference</code> 对象用于维持对其它对象的引用，但 GC 仍然可以回收这些被引用的其它对象。当 GC 决定回收某个引用对象关联的对象时，它会将对应的引用对象放入与之关联的引用队列（<code>ReferenceQueue</code>）中，这样我们就可以得到对象被回收的通知了。</p>
<h2 id=对象可达性>对象可达性</h2>
<p>在进行垃圾回收之前，第一件事情就是找出垃圾。引用计数算法和可达性分析算法是两种常见的判断垃圾的方法，JVM 是通过分析对象的可达性来判断是否应该将其回收的。堆中的对象是可以相互引用的，根据对象类型的不同，引用的直接表现形式也不同。对于普通对象而言，引用就是对象的字段，而对于数组而言，引用就是数组的元素。此外，还有一些隐藏的引用，例如：每个对象实例都包含一个指向其类型（即实例对应的 Class）的引用，而每个 Class 又包含一个指向加载它的 ClassLoader 的引用。</p>
<p>我们可以将对象之间的引用关系看作是一张有向图，图中的节点就是对象，而边就是对象间的引用。从源对象出发，若存在一条通往目标对象的路径，则目标对象对源对象来说是可达的，反之目标对象对源对象而言就是不可达的。</p>
<h3 id=gc-roots>GC Roots</h3>
<p>可达性分析算法的基本思路是通过一系列被称为“GC Roots”的根对象作为起始节点集，从这些结点开始，根据引用关系向下搜索，搜索路径即为引用链（Reference Chain），如果没有任何路径可以到达 某个对象，则说明这个对象不再被使用，即为垃圾。</p>
<p><img src=/images/java/java_lang/gc_roots_and_object_reachability.png alt></p>
<p>在 Java 中，GC Root 是一个可以 <strong>从堆外访问</strong> 的对象，通常包括以下对象：</p>
<ul>
<li>JVM 栈中引用的对象，比如线程方法的参数、局部变量、临时变量等；</li>
<li>方法区中静态属性引用的对象，比如 Java 类的引用类型的静态变量；</li>
<li>方法区中常量引用的对象，比如字符串常量池中的引用；</li>
<li>Native 方法栈中 JNI 引用的对象；</li>
<li>JVM 内部的引用，比如基本数据类型对应的 Class 对象、一些常驻的异常对象（NullPointerException、OutOfMemeryError 等）、系统类加载器；</li>
<li>所有被同步锁（synchronized）持有的对象；</li>
<li>反映 JVM 内部情况的 JMXBean、JVMTI 中注册的回调、Native 代码缓存等；</li>
</ul>
<p>Eclipse 的内存分析工具列举出了各种具体的 <a href="https://help.eclipse.org/2021-03/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Fconcepts%2Fgcroots.html">GC Root</a>，感兴趣的同学可以进一步了解。</p>
<h3 id=对象的五种可达性>对象的五种可达性</h3>
<p>Java 中的对象可达性有五种不同的程度：强可达（strongly reachable）、软可达（softly reachable）、弱可达（weakly reachable）、虚可达（phantom reachable）和不可达（unreachable）。以下关于可达性的描述，取自 <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/package-summary.html#reachability>java.lang.ref</a> 包的文档：</p>
<blockquote>
<p>Going from strongest to weakest, the different levels of reachability reflect the life cycle of an object. They are operationally defined as follows:</p>
<ul>
<li>
<p>An object is strongly reachable if it can be reached by some thread without traversing any reference objects. A newly-created object is strongly reachable by the thread that created it.</p>
</li>
<li>
<p>An object is softly reachable if it is not strongly reachable but can be reached by traversing a soft reference.</p>
</li>
<li>
<p>An object is weakly reachable if it is neither strongly nor softly reachable but can be reached by traversing a weak reference. When the weak references to a weakly-reachable object are cleared, the object becomes eligible for finalization.</p>
</li>
<li>
<p>An object is phantom reachable if it is neither strongly, softly, nor weakly reachable, it has been finalized, and some phantom reference refers to it.</p>
</li>
<li>
<p>Finally, an object is unreachable, and therefore eligible for reclamation, when it is not reachable in any of the above ways.</p>
</li>
</ul>
</blockquote>
<h2 id=强引用>强引用</h2>
<p>强引用指程序代码中普遍存在的引用赋值（比如<code>Object strongReference = new Object()</code>这种关系）。在任何情况下，只要强引用的关系还在，垃圾收集器就不会回收被引用的对象。当内存不足时，JVM 宁愿抛出 <code>OutOfMemorryError</code>，也不会回收具有强引用的对象。当一个强引用对象不再使用时，若要让 GC 回收它，我们需要让它变得不可达（实际上，GC 也只回收不可达对象）。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>test</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    Object strongReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>  <span style=color:#75715e>// 强引用
</span><span style=color:#75715e></span>    strongReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span> <span style=color:#75715e>//  对象可以被 GC 回收了
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><p>在上面这段代码中，<code>new Object()</code> 会在堆中创建一个对象，而指向这个对象的是栈中的引用 <code>strongReference</code>。当方法调用完成，方法栈退出，<code>strongReference</code> 不复存在，这个对象就可以被回收了。若 <code>strongReference</code> 是全局变量，则需要手动将其设置为 <code>null</code>，去除其对对象的引用，对象才能被回收。</p>
<h2 id=软引用>软引用</h2>
<p>被软引用关联对象即软可达对象，它们是一些还有用但非必须的对象，在系统将要发生内存溢出之前，会被二次回收，如果这次回收之后的内存依然不够，JVM 才会抛出 OutOfMemoryError。<strong>JVM 保证在抛出 OutOfMemoryError 之前回收所有被软引用关联的软可达对象</strong>。JDK 1.2 之后提供了 <code>SoftReference</code> 类来表示软引用。</p>
<blockquote>
<p>Soft references are most often used to implement memory-sensitive caches.</p>
</blockquote>
<p>创建软引用对象的方法有两种。</p>
<p>第一种是创建不与任何引用队列关联的软引用对象：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Object referent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>
SoftReference<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> softReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SoftReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>);</span>
</code></pre></div><p>我们也可以使用带 <code>ReferenceQueue</code> 的构造函数，如果软引用所引用的对象被回收，JVM 就会自动将这个软引用加入到与之关联的引用队列中：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>ReferenceQueue<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> referenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>&lt;&gt;();</span>
SoftReference<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> softReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SoftReference<span style=color:#f92672>&lt;&gt;(</span>obj<span style=color:#f92672>,</span> referenceQueue<span style=color:#f92672>);</span>
</code></pre></div><p><code>Reference</code> 类提供的 <code>get</code> 和 <code>clear</code> 方法分别可以用来获取和重置对应的引用：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Object referent <span style=color:#f92672>=</span> softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>clear</span><span style=color:#f92672>();</span>
Object referent2 <span style=color:#f92672>=</span> softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>  <span style=color:#75715e>// null
</span></code></pre></div><p>实际上，由于对象可能被 GC 回收，所以在进行下一步操作时，我们需要对 <code>get</code> 方法返回的 referent 进行检查：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Object referent <span style=color:#f92672>=</span> softReference<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>();</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>referent <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e>// 对象还没有被 GC 回收
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 用作缓存时，可直接返回对象
</span><span style=color:#75715e></span><span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
  <span style=color:#75715e>// 对象已经被 GC 回收
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 用作缓存时，需要重新实例化引用对象
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><h2 id=弱引用>弱引用</h2>
<p>被弱引用关联的对象即弱可达对象，它描述的也是非必须对象，其强度比软引用更弱。被弱引用关联的对象，只能生存到下一次垃圾回收。当垃圾收集器开始工作，无论当前内存是否不足，都会回收掉被弱引用关联的对象。JDK 1.2 之后提供了 <code>WeakReference</code> 类来表示弱引用。</p>
<p>弱引用与软引用之间最大的区别在于：被弱引用指向的对象只在两次 GC 之间存活，而被软引用指向的对象在 JVM 内存紧张的时候才被回收，它是可以经历多次 GC 的。</p>
<blockquote>
<p>Weak references are most often used to implement canonicalizing mappings.</p>
</blockquote>
<p>创建弱引用对象的方法也有两种，不关联任何引用队列的和关联引用队列的：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Object referent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>
ReferenceQueue referenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>();</span>

WeakReference weakReference1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WeakReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>);</span>
WeakReference weakReference2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WeakReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>,</span> referenceQueue<span style=color:#f92672>);</span>
</code></pre></div><p>弱引用的其它使用与软引用类似，不再赘述。</p>
<p>JDK 提供了一个基于弱引用实现的 <code>HashMap</code> 集合—— <code>WeakHashMap</code>，其中的 <code>Entry</code> 继承了 <code>WeakReference</code>，<code>Entry</code> 中使用弱引用指向 Key，使用强引用指向 Value。当没有强引用指向 Key 的时候，Key 可以被 GC 回收。当再次操作 <code>WeakHashMap</code> 的时候，就会遍历关联的引用队列，从 <code>WeakHashMap</code> 中清理掉相应的 <code>Entry</code>。</p>
<h2 id=虚引用>虚引用</h2>
<p>虚引用是最弱的一种引用关系，又称“幽灵引用”或“幻影引用”。一个对象是否有虚引用，完全不会对其生存时间构成影响，也无法通过虚引用来获取一个对象的实例。JDK 1.2 之后提供了 <code>PhantomReference</code> 类来表示虚引用。虚引用主要用来跟踪对象被 GC 回收的活动。 虚引用与软引用和弱引用的一个区别在于：虚引用必须和引用队列一起使用。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象的内存之前，把这个虚引用加入到与之关联的引用队列中。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Object referent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>();</span>
ReferenceQueue referenceQueue <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ReferenceQueue<span style=color:#f92672>();</span>

<span style=color:#75715e>// 创建虚引用时，必须和一个引用队列相关联
</span><span style=color:#75715e></span>PhantomReference phantomReference <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PhantomReference<span style=color:#f92672>&lt;&gt;(</span>referent<span style=color:#f92672>,</span> referenceQueue<span style=color:#f92672>);</span>
</code></pre></div><p>弱引用的其它使用与软引用类似，不再赘述。</p>
<h2 id=参考资料>参考资料</h2>
<ol>
<li>周志明. 深入理解Java虚拟机（第3版）. 机械工业出版社, 2019.</li>
<li><a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ref/package-summary.html>Package java.lang.ref</a>.</li>
</ol>
</div>
<footer class=entry-footer>
<div class="container sep-before"><div class=categories><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg>
<span class=screen-reader-text>分类: </span><a class=category href=/categories/java/>Java</a></div>
<div class=tags><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2H12l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=screen-reader-text>标签: </span><a class=tag href=/tags/java/>Java</a></div>
</div>
</footer>
</article>
<nav class=entry-nav>
<div class=container><div class="prev-entry sep-before">
<a href=/java/jdbc/jdbc/>
<span aria-hidden=true><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg>
Previous</span>
<span class=screen-reader-text>上一篇: </span>JDBC</a>
</div><div class="next-entry sep-before">
<a href=/java/spring/spring-ioc/>
<span class=screen-reader-text>下一篇: </span>Spring Ioc<span aria-hidden=true>下一个<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg>
</span>
</a>
</div></div>
</nav>
</main>
<footer id=footer class=footer>
<div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label=社交菜单>
<ul><li>
<a href=https://github.com/zhannicholas target=_blank rel="noopener me">
<span class=screen-reader-text>Open Github account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a>
</li><li>
<a href=https://t.me/zhannicholas target=_blank rel="noopener me">
<span class=screen-reader-text>Open Telegram account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23.91 3.79 20.3 20.84c-.25 1.21-.98 1.5-2 .94l-5.5-4.07-2.66 2.57c-.3.3-.55.56-1.1.56-.72.0-.6-.27-.84-.95L6.3 13.7.85 12c-1.18-.35-1.19-1.16.26-1.75l21.26-8.2c.97-.43 1.9.24 1.53 1.73z"/></svg>
</a>
</li><li>
<a href=mailto:zhan_nicholas@outlook.com target=_blank rel="noopener me">
<span class=screen-reader-text>Contact via Email</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
</a>
</li><li>
<a href=https://linkedin.com/in/%e4%bc%9f%e4%bc%9f-%e8%a9%b9-27871a104 target=_blank rel="noopener me">
<span class=screen-reader-text>Open Linkedin account in new tab</span><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
</a>
</li></ul>
</nav>
</section><div class=copyright>
<p> &copy; 2018-2021 Nicholas Zhan </p>
</div>
</div>
</footer>
</div>
</div><script>window.__assets_js_src="/assets/js/"</script>
<script src=/assets/js/main.c3bcf2df.js></script><script src=/js/custom.js></script>
</body>
</html>
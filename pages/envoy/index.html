<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>Envoy |</title><meta name=description content><meta property="og:title" content="Envoy | "><meta name=twitter:title content="Envoy | "><meta itemprop=name content="Envoy | "><meta name=application-name content="Envoy | "><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content><meta property="og:description" content><meta property="og:site_name" content><meta property="og:url" content="https://zhannicholas.github.io/pages/envoy/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.70a967cc78af9ec5b1e1b5c3552172a911554a27d8e5bdf52000296bdd439d2a.css" integrity="sha256-cKlnzHivnsWx4bXDVSFyqRFVSifY5b31IAApa91DnSo="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><img src=https://zhannicholas.github.io/images/site-logo.svg class="transition-opacity h-9 w-9 group-hover:opacity-50 group-focus:opacity-70" alt=" Logo"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60"></div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Envoy</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><ul><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#terminology>Terminology</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#threading-model>Threading Model</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#listeners>Listeners</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#http-connection-manager>HTTP Connection Manager</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#upstream-clusters>Upstream Clusters</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#service-discovery>Service Discovery</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#health-checking>Health Checking</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#connection-pooling>Connection Pooling</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#load-balancing>Load Balancing</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#outlier-detection>Outlier detection</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#rate-limiting>Rate Limiting</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#observability>Observability</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#access-logs>Access Logs</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#access-logging>Access Logging</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#toubleshooting>Toubleshooting</a></li></ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#dump-dynamic_listeners-configs>Dump dynamic_listeners configs</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p><a href=https://www.envoyproxy.io/ target=_blank>Envoy</a>
is an open source edge and service proxy, designed for cloud-native applications.</p><h2 id=terminology>Terminology</h2><ul><li><blockquote><p>Reference: <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/intro/terminology target=_blank>Terminology in Architecture</a>
, <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/life_of_a_request#terminology target=_blank>Terminology in Request Life</a>
.</p></blockquote></li><li><p><strong>Host</strong>: An entity capable of network communication (application on a mobile phone, server, etc.).</p></li><li><p><strong>Downstream</strong>: A downstream host connects to Envoy, sends requests, and receives responses.</p></li><li><p><strong>Listener</strong>: A listener is a named network location (e.g., port, unix domain socket, etc.) that can be connected to by downstream clients. Envoy exposes one or more listeners that downstream hosts connect to.</p></li><li><p><strong>Filter</strong>: a module in the connection or request processing pipeline providing some aspect of request handling. <strong>Filter chain</strong> is a series of filters.</p></li><li><p><strong>Cluster</strong>: A cluster is a group of logically similar upstream hosts that Envoy connects to. Envoy discovers the members of a cluster via service discovery. It optionally determines the health of cluster members via active health checking. The cluster member that Envoy routes a request to is determined by the load balancing policy.</p><ul><li>Components forming the cluster name</li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch10_f09_posta2.png alt></p><ul><li><p><strong>Endpoints</strong>: network nodes that implement a logical service. They are grouped into clusters. Endpoints in a cluster are <em>upstream</em> of an Envoy proxy.</p></li><li><p><strong>Upstream</strong>: An upstream host (endpoint) receives connections and requests from Envoy and returns responses.</p></li><li><p><strong>Mesh</strong>: A group of hosts that coordinate to provide a consistent network topology.</p></li><li><p><strong>Runtime configuration</strong>: Out of band realtime configuration system deployed alongside Envoy. Configuration settings can be altered that will affect operation without needing to restart Envoy or change the primary configuration.</p></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch03_f03_posta2.png alt></p><h2 id=threading-model>Threading Model</h2><ul><li><blockquote><p>Reference: <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/intro/threading_model target=_blank>Envoy&amp;rsquo;s threading model</a>
.</p></blockquote></li><li><p>Envoy uses a single process with multiple threads architecture. A single <em>primary</em> thread controls various sporadic coordination tasks while some number of <em>worker</em> threads perform listening, filtering, and forwarding. Once a connection is accepted by a listener, the connection spends the rest of its lifetime bound to a single worker thread.</p></li></ul><h2 id=listeners>Listeners</h2><ul><li><p><strong>Listener</strong>: A listener is a named network location (e.g., port, unix domain socket, etc.) that can be connected to by downstream clients. Envoy exposes one or more listeners that downstream hosts connect to.</p></li><li><p>Envoy supports both TCP and UDP listeners.</p></li><li><p>Listeners are optionally configured with some number of <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/listener_filters#arch-overview-listener-filters target=_blank>listener filters</a>
. These filters are processed before the network level filters, and have the opportunity to manipulate the connection metadata, usually to influence how the connection is processed by later filters or clusters.</p></li><li><p>The <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/network_filters target=_blank>network (L3/L4) filters</a>
are chained in a ordered list known as <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/listener/v3/listener_components.proto#envoy-v3-api-msg-config-listener-v3-filterchain target=_blank>filter chain</a>
.</p><ul><li><p>There are three different types of network filters:</p><ul><li><p><strong>Read</strong>: Read filters are invoked when Envoy receives data from a downstream connection.</p></li><li><p><strong>Write</strong>: Write filters are invoked when Envoy is about to send data to a downstream connection.</p></li><li><p><strong>Read/Write</strong>: Read/Write filters are invoked both when Envoy receives data from a downstream connection and when it is about to send data to a downstream connection.</p></li></ul></li></ul></li></ul><h2 id=http-connection-manager>HTTP Connection Manager</h2><ul><li><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/http_conn_man#config-http-conn-man target=_blank>HTTP connection manager (HCM)</a>
is an Envoy network filter (See #### Understanding Envoy&rsquo;s filter chaining</li></ul><p>). It translates raw bytes into HTTP level messages and events (e.g., headers received, body data received, trailers received, etc.). It also handles functionality common to all HTTP connections and requests such as <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/access_logging#arch-overview-access-logs target=_blank>access logging</a>
, <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/observability/tracing#arch-overview-tracing target=_blank>request ID generation and tracing</a>
, <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#config-http-conn-man-headers target=_blank>request/response header manipulation</a>
, <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_routing#arch-overview-http-routing target=_blank>route table</a>
 management, and <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#config-http-conn-man-stats target=_blank>statistics</a>
.</p><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch14_f03_posta2.png alt></p><pre><code>+ HTTP level filters

  + Much like the [network level filter](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/listeners/network_filters#arch-overview-network-filters) stack, Envoy supports an HTTP level filter stack within the HTTP connection manager.

  + There are three types of HTTP level filters:


    + **Decoder**: Decoder filters are invoked when the connection manager is decoding parts of the request stream (headers, body, and trailers).

    + **Encoder**: Encoder filters are invoked when the connection manager is about to encode parts of the response stream (headers, body, and trailers).

    + **Decoder/Encoder**: Decoder/Encoder filters are invoked both when the connection manager is decoding parts of the request stream and when the connection manager is about to encode parts of the response stream.

  + The most important HTTP filter is the **[router filter](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_routing#arch-overview-http-routing)** which sits at the end of the HTTP filter chain.

  + 
</code></pre><h2 id=upstream-clusters>Upstream Clusters</h2><ul><li><p>Envoy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/cluster_manager target=_blank>cluster manager</a>
manages all configured upstream [clusters](<strong>Clusters</strong>: Specific upstream services to which Envoy can route traffic. <strong>Subsets</strong> are used to further divide workloads within a cluster, which enables fine-grained traffic management.
).</p></li><li><p>Clusters known to the cluster manager can be configured either statically, or fetched dynamically via the cluster discovery service (CDS) API.</p></li><li><h3 id=service-discovery>Service Discovery</h3><ul><li><blockquote><p>When an upstream cluster is defined in the <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-msg-config-cluster-v3-cluster target=_blank>configuration</a>
, Envoy needs to know how to resolve the members of the cluster. This is known as <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/service_discovery target=_blank>&lt;em>service discovery&lt;/em></a>
.</p></blockquote></li><li><p>Supported service discovery types</p><ul><li><p><strong>Static</strong>: The configuration explicitly specifies the resolved network name (IP address/port, unix domain socket, etc.) of each upstream host.</p></li><li><p><strong>Strict DNS</strong>: When using strict DNS service discovery, Envoy will continuously and asynchronously resolve the specified DNS targets. Each returned IP address in the DNS result will be considered an explicit host in the upstream cluster.</p></li><li><p><strong>Logical DNS</strong>: Similar to strict DNS, but a logical DNS cluster only uses the first IP address returned <em>when a new connection needs to be initiated</em>, rather than taking the results of the DNS query and assuming that they comprise the entire upstream cluster.</p></li><li><p><strong>Original Destination</strong>: Original destination cluster can be used when incoming connections are redirected to Envoy either via an iptables REDIRECT or TPROXY target or with Proxy Protocol.</p></li><li><p><strong>Endpoint Discovery Service (EDS)</strong>: The <em>endpoint discovery service</em> is a <a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/xds_api#config-overview-management-server target=_blank>xDS management server based on gRPC or REST-JSON API server</a>
 used by Envoy to fetch cluster members. The cluster members are called “endpoint” in Envoy terminology.</p></li><li><p><strong>Custom Cluster</strong>: Custom clusters are specified using <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-field-config-cluster-v3-cluster-cluster-type target=_blank>cluster_type field</a>
 on the cluster configuration.</p></li></ul></li><li><p>Service discovery is eventually consistent, Envoy assumes that hosts come and go from the mesh in an <strong>eventually consistent</strong> way.</p></li></ul></li><li><h3 id=health-checking>Health Checking</h3><ul><li><blockquote><p>Envoy mesh configuration uses eventually consistent service discovery along with <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/health_checking#arch-overview-health-checking target=_blank>active health checking</a>
 (Envoy explicitly health checking upstream cluster members) to determine cluster health.</p></blockquote></li><li><p>When health checking is configured for an upstream cluster, Envoy uses a 2x2 matrix to determine whether to route to a host:</p></li></ul></li></ul><table><thead><tr><th>Discovery Status</th><th>Health Check OK</th><th>Health Check Failed</th></tr></thead><tbody><tr><td>Discovered</td><td>Route</td><td>Don’t Route</td></tr><tr><td>Absent</td><td>Route</td><td>Don’t Route / Delete</td></tr></tbody></table><pre><code>+ Envoy supports three different types of health checking

  + **HTTP**: During HTTP health checking Envoy will send an HTTP request to the upstream host. By default, it expects a 200 response if the host is healthy.

  + **L3/L4**: During L3/L4 health checking, Envoy will send a configurable byte buffer to the upstream host. It expects the byte buffer to be echoed in the response if the host is to be considered healthy. Connect only L3/L4 health checking is also supported.

  + **Redis**: Envoy will send a Redis PING command and expect a PONG response.

+ Envoy also supports passive health checking via [outlier detection](### Outlier detection
</code></pre><p>).</p><ul><li><h3 id=connection-pooling>Connection Pooling</h3><ul><li><p>For HTTP traffic, Envoy supports abstract <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/connection_pooling target=_blank>connection pools</a>
that are layered on top of the underlying wire protocol (HTTP/1.1, HTTP/2, HTTP/3).</p></li><li><p>Each host in each cluster will have one or more connection pools.</p></li></ul></li><li><h3 id=load-balancing>Load Balancing</h3><ul><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overview target=_blank>Load balancing</a>
is a way of distributing traffic between multiple hosts within a single upstream cluster in order to effectively make use of available resources.</p></li><li><p>When a filter needs to acquire a connection to a host in an upstream cluster, the cluster manager uses a load balancing policy to determine which host is selected.</p></li><li><p>Supported load balancing policy</p><ul><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#weighted-round-robin target=_blank>Weighted round robin</a>
.</p></li><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#weighted-least-request target=_blank>Weighted least request</a>
.</p></li><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#ring-hash target=_blank>Ring hash</a>
.</p></li><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#maglev target=_blank>Maglev</a>
.</p></li><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancers#random target=_blank>Random</a>
.</p></li></ul></li><li><p>During load balancing, Envoy will generally only consider hosts configured at the highest priority level.</p></li></ul></li><li><h3 id=outlier-detection>Outlier detection</h3><ul><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/outlier target=_blank>Outlier detection and ejection</a>
is the process of dynamically determining whether some number of hosts in an upstream cluster are performing unlike the others and removing them from the healthy <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/overview#arch-overview-load-balancing target=_blank>load balancing</a>
 set.</p></li><li><p>Detected errors fall into two categories: externally and locally originated errors.</p><ul><li><p>Externally generated errors are transaction specific and occur on the upstream server in response to the received request.</p></li><li><p>Locally originated errors are generated by Envoy in response to an event which interrupted or prevented communication with the upstream host.</p></li></ul></li><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/outlier#ejection-algorithm target=_blank>Ejection algorithm</a>
.</p></li></ul></li><li></li></ul><h2 id=rate-limiting>Rate Limiting</h2><ul><li><p>Envoy supports two kinds of rate limiting: global and local.</p></li><li><h4 id=global-rate-limitinghttpswwwenvoyproxyiodocsenvoylatestintroarch_overviewother_featuresglobal_rate_limiting><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/other_features/global_rate_limiting target=_blank>Global rate limiting</a></h4></li><li><h4 id=local-rate-limitinghttpswwwenvoyproxyiodocsenvoylatestconfigurationlistenersnetwork_filterslocal_rate_limit_filterconfig-network-filters-local-rate-limit><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/local_rate_limit_filter#config-network-filters-local-rate-limit target=_blank>Local rate limiting</a></h4></li><li></li></ul><h2 id=observability>Observability</h2><ul><li><h3 id=access-logs>Access Logs</h3><ul><li><p><a href=https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/access_log target=_blank>Reference</a>
.</p></li><li><h4 id=access-logging>Access Logging</h4><ul><li><p>Default format string</p><ul><li><pre><code>[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
%RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION%
%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%"
"%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n
</code></pre></li></ul></li></ul></li><li></li></ul></li></ul><h2 id=toubleshooting>Toubleshooting</h2><ul><li><p>Worth to read: ### Discovering misconfigurations manually from the Envoy config</p></li><li><p>Dump Envoy configs</p><ul><li><p>Admin API: <a href="https://www.envoyproxy.io/docs/envoy/latest/operations/admin#get--config_dump?resource=" target=_blank>GET /config_dump?resource={}</a>
.</p></li><li><p>Supported configs: <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/admin/v3/config_dump.proto target=_blank>ConfigDump(proto)</a>
.</p></li><li><p>Example</p></li></ul></li></ul><p>`shell</p><h1 id=dump-dynamic_listeners-configs>Dump dynamic_listeners configs</h1><p>$ kubectl -n xxx-ns exec xxx-pod -c istio-proxy &ndash; curl http://localhost:15000/config_dump?resource=dynamic_listeners
`</p><pre><code>+ 
</code></pre></div><hr><aside><h3 class="text-2xl font-black tracking-tight text-indigo-500 capitalize dark:text-indigo-300 sm:text-2xl">Linked References</h3><div class=backlinks><ul><p class="inline-flex items-center rounded-md bg-gray-300 hover:bg-indigo-200 hover:text-black px-2.5 py-0.5 text-sm font-medium text-gray-900 capitalize"><a style=color:var(--link) href=https://zhannicholas.github.io/pages/istio-in-action>Istio in Action</a></p></ul></div></aside><br><aside class=related></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/notes class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p></div></footer></body></html>
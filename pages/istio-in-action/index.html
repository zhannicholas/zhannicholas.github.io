<!doctype html><html lang=zh-cn><head><meta http-equiv=content-type content="text/html" charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon type=image/png sizes=96x96 href=https://zhannicholas.github.io/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=32x32 href=https://zhannicholas.github.io/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://zhannicholas.github.io/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title itemprop=name>Istio in Action | NZ's Digital Garden</title><meta name=description content><meta property="og:title" content="Istio in Action | NZ's Digital Garden"><meta name=twitter:title content="Istio in Action | NZ's Digital Garden"><meta itemprop=name content="Istio in Action | NZ's Digital Garden"><meta name=application-name content="Istio in Action | NZ's Digital Garden"><meta property="og:site_name" content><meta property="og:type" content="website"><meta property="og:title" content="NZ's Digital Garden"><meta property="og:description" content><meta property="og:site_name" content="NZ's Digital Garden"><meta property="og:url" content="https://zhannicholas.github.io/pages/istio-in-action/"><meta property="og:locale" content="en"><meta property="og:image" content="/"><meta property="og:image:secure_url" content="https://zhannicholas.github.io"><meta property="og:type" content="website"><script>localStorage.getItem("color-theme")==="dark"||!("color-theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=stylesheet href="/css/style.min.172198f1bbeb66428b798f521ac03583837aeb0e305f2508bd37d77cb221a6fb.css" integrity="sha256-FyGY8bvrZkKLeY9SGsA1g4N66w4wXyUIvTfXfLIhpvs="></head><body class="bg-zinc-100 dark:bg-gray-800"><div class="top-0 z-50 w-full text-gray-200 bg-gray-900 border-2 border-gray-900 md:sticky border-b-stone-200/10"><div x-data="{ open: false }" class="flex flex-col max-w-full px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8"><div class="flex flex-row items-center justify-between p-4"><a href=https://zhannicholas.github.io/ class="flex text-gray-100 transition duration-1000 ease-in-out group"><div class="mt-1 text-xl font-black tracking-tight text-gray-100 uppercase transition-colors group-hover:text-gray-400/60">NZ's Digital Garden</div></a><button class="rounded-lg md:hidden focus:outline-none focus:shadow-outline" @click="open = !open" role=navigation aria-expanded=false aria-label=Main aria-controls=menuItems><svg fill="currentcolor" viewBox="0 0 20 20" class="w-6 h-6"><path x-show="!open" fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4A1 1 0 013 5zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm6 5a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z" clip-rule="evenodd"/><path x-show="open" fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414.0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><nav :class="{'flex': open, 'hidden': !open}" class="flex-col flex-grow hidden pb-4 md:pb-0 md:flex md:justify-end md:flex-row"><div @click.away="open = false" class=relative x-data="{ open: false }"><button @click="open = !open" class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left bg-transparent rounded-lg md:w-auto md:inline md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline">
<span>The Garden</span><svg fill="currentcolor" viewBox="0 0 20 20" :class="{'rotate-180': open, 'rotate-0': !open}" class="inline w-4 h-4 mt-1 ml-1 transition-transform duration-200 transform md:-mt-1"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414.0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414.0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button><div x-show=open x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95" class="absolute right-0 z-30 w-full mt-2 origin-top-right rounded-md shadow-lg md:w-48"><div class="px-2 py-2 text-indigo-900 bg-white rounded-md shadow"><a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/posts>Posts</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-600 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/pages>Notes</a>
<a class="block px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/library>Library</a></div></div></div><a class="px-4 py-2 mt-2 text-sm font-semibold rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/now>Now</a>
<a class="px-4 py-2 mt-2 text-sm font-semibold bg-transparent rounded-lg md:mt-0 md:ml-4 hover:text-white focus:text-white hover:bg-indigo-600 focus:bg-indigo-700 focus:outline-none focus:shadow-outline" href=https://zhannicholas.github.io/about>About</a>
<button id=theme-toggle type=button class="p-2 text-sm text-gray-500 rounded-lg md: dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 md:ml-2 max-w-5 xs:hidden"><svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001.0 1010.586 10.586z"/></svg><svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" aria-label="Dark or Light Mode" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"/></svg></button></nav></div></div><div class=content><article><header class="max-w-2xl mx-auto mb-4 bg-indigo-600"><span class=py-96><h1 class="px-6 pt-6 pb-16 mx-auto dark:prose-invert text-5xl font-black text-center text-white capitalize">Istio in Action</h1></span></header><div class="max-w-4xl mx-auto mt-8 mb-2"><div class=px-6></div></div><div class="fixed z-20 top-[3.8125rem] bottom-0 right-[max(0px,calc(50%-45rem))] w-[18rem] py-10 overflow-y-auto hidden xl:block"><nav><div class="flex items-center"><h2 class="pl-2 my-0 text-xl font-medium text-zinc-800 uppercase break-words">Table of Contents</h2></div><div class="absolute top-auto bottom-auto right-auto p-0 -left-4" role=menu><div class="relative z-50 max-w-sm m-4 overflow-hidden shadow-lg"><ul class="relative p-4 overflow-x-hidden overflow-y-auto overscroll-y-auto overscroll-x-auto"><li><a class="px-2 text-left text-zinc-700 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#front-matter>Front Matter</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-1-introduction-to-the-istio-service-mesh>Chapter 1 Introduction to the Istio service mesh</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-2-first-steps-with-istio>Chapter 2 First steps with Istio</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#istiod>Istiod</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#ingress-and-egress-gateway>Ingress and egress gateway</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-3-istios-data-plane-the-envoy-proxy>Chapter 3 Istio&rsquo;s data plane: The Envoy Proxy</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#envoys-core-features>Envoy&rsquo;s core features</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#configuring-envoy>Configuring Envoy</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#static-configuration>Static configuration</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#dynamic-configuration>Dynamic configuration</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-4-istio-gateways-getting-traffic-into-a-cluster>Chapter 4: Istio gateways: Getting traffic into a cluster</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#traffic-ingress-concepts>Traffic ingress concepts</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#istio-ingress-gateways>Istio ingress gateways</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#securing-gateway-traffic>Securing gateway traffic</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-5-traffic-control-fine-grained-traffic-routing>Chapter 5: Traffic control: Fine-grained traffic routing</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#deployment-vs-release>deployment vs release</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-6-resilience-solving-application-networking--challenges>Chapter 6: Resilience: Solving application networking challenges</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#client-side-load-balancing>Client-side load balancing</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#locality-aware-load-balancing>Locality-aware load balancing</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#transparent-timeouts-and-retries>Transparent timeouts and retries</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#circuit-breaking-with-istio>Circuit breaking with Istio</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-7-observability-understanding-the-behavior-of-you-services>Chapter 7: Observability: Understanding the behavior of you services</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#observability-vs-monitoring>Observability vs Monitoring</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#scraping-istio-metrics-with-prometheus>Scraping Istio metrics with Prometheus</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#customizing--istios-standard-metrics>Customizing Istio&rsquo;s standard metrics</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-8-observability-visualizing-network-behavior-with-grafana-jaeger-and-kiali>Chapter 8: Observability: Visualizing network behavior with Grafana, Jaeger and Kiali</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#using-grafana-to-visualize-istio-service-and-control-plane-metrics>Using Grafana to visualize Istio service and control-plane metrics</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#distributed-tracing>Distributed tracing</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#how-does-distributed-tracing-work>How does distributed tracing work?</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-9-securing-microservice-communication>Chapter 9: Securing microservice communication</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#istio-security-in-a-nutshell>Istio security in a nutshell</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#auto-mtls>Auto mTLS</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#authorizing-service-to-service-traffic>Authorizing service-to-service traffic</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#end-user-authentication-and-authorization>End-user authentication and authorization</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-10-troubleshooting-the-data-plane>Chapter 10: Troubleshooting the data plane</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#identifying-data-plane-issues>Identifying data-plane issues</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#verify-that-the-data-plane-is-up-to-date>Verify that the data plane is up to date</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#discovering-misconfigurations-manually-from-the-envoy-config>Discovering misconfigurations manually from the Envoy config</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#envoy-administration-interface>Envoy administration interface</a></li></ul></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-11-performance-tuning-the-control-plane>Chapter 11: Performance-tuning the control plane</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#the-control-planes-primary-goal>The control plane&rsquo;s primary goal</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#chapter-14-extending-istio-on-the-request-path>Chapter 14: Extending Istio on the request path</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#envoys-extension-capabilities>Envoy&rsquo;s extension capabilities</a><ul><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#understanding-envoys-filter-chaining>Understanding Envoy&rsquo;s filter chaining</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#envoys-core-features-1>Envoy&rsquo;s core features</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#configuring-an-envoy-filter-with-the-envoyfilter-resource>Configuring an Envoy filter with the EnvoyFilter resource</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#rate-limiting-requests-with-external-call-out>Rate-limiting requests with external call-out</a></li></ul></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#appendix-b-istios-sidecar-and-its-injection-options>Appendix B. Istio&rsquo;s sidecar and its injection options</a></li><li><a class="px-2 text-left text-zinc-900 rounded-md focus:outline-none hover:bg-lightBlue-600 hover:text-white" x-data href=#appendix-d-troubleshooting-istio-components>Appendix D. Troubleshooting Istio components</a></li></ul></div></div></nav></div><div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white"><p>Reading Notes of <a href=https://learning.oreilly.com/library/view/istio-in-action/9781617295829/ target=_blank>Istio in Action</a>
, a book about how to achieve the goal of decoupling applications from infrastructure, on O&rsquo;reilly.
<a href=https://blog.christianposta.com/ target=_blank>Christian Posta&amp;rsquo;s blog</a>
.</p><h2 id=front-matter>Front Matter</h2><ul><li><p>What is a service mesh, and why do I need one?</p><ul><li>The real answer has to do with decoupling applications from infrastructure. Istio is the third major step in that direction. First, Docker provided a way to <strong>package an application</strong> (and its library choices) separately from the machine on which it runs. Next, Kubernetes made it easy to create a service with automation to help with <strong>autoscaling and management</strong>. Together, Docker and Kubernetes enabled the practical movement to fine-grain services, often called <em>microservices</em>. This book guides you through implementing a service mesh with Istio to achieve this third step: application decoupling.</li></ul></li></ul><h2 id=chapter-1-introduction-to-the-istio-service-mesh>Chapter 1 Introduction to the Istio service mesh</h2><ul><li><p><em>Service mesh</em> is a relatively recent term used to describe a decentralized application-networking infrastructure that allows applications to be secure, resilient, observable, and controllable. It describes an architecture made up of a <strong>data plane that uses application-layer proxies to manage networking traffic</strong> on behalf of an application and <strong>a control plane to manage proxies</strong>.</p></li><li><p><a href=http://envoyproxy.io target=_blank>Envoy</a>
is a service proxy that has emerged in the open source community as a versatile, performant, and capable application-layer proxy.</p></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch01_f06_posta2.png alt="The envoy proxy out-of-process from the application"></p><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch01_f07_posta2.png alt="A sidecar deployment is an additional process that works cooperatively A sidecar deployment is an additional process that works cooperatively with the main application process to deliver a piece of functionality"></p><ul><li><p>A <strong>service mesh</strong> is a distributed application infrastructure that is responsible for handling network traffic on behalf of the application in a transparent, out-of-process manner.
<img src=https://zhannicholas.github.io/assets/istioinaction/ch01_f08_posta2.png alt="A service mesh architecture with co-located application-layer proxies (data plane) and management components (control plane)"></p><ul><li>The <strong>data plane</strong> is responsible for establishing, securing, and controlling the traffic through the mesh. The data plane behavior is configured by the control plane. The <strong>control plane</strong> is the brains of the mesh and exposes an API for operators to manipulate network behaviors.</li></ul></li><li><p>With Istio, applications don’t have to know that they’re part of the service mesh: whenever they interact with the outside world, Istio handles the networking on their behalf.</p></li><li><p>Istio’s data plane uses the <strong>Envoy proxy</strong> and helps you configure your application to have an instance of the service proxy (Envoy) deployed alongside it. Istio’s control plane (<code>istiod</code>) is made up of a few components that provide APIs for end users/operators, configuration APIs for the proxies, security settings, policy declarations, and more.</p></li><li><p>With a service proxy next to each application instance, applications no longer need language-specific resilience libraries for circuit breaking, timeouts, retries, service discovery, load balancing, and so on.</p></li><li><p>An overview of separation of concerns in cloud-native applications.</p></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch01_f13_posta2.png alt></p><ul><li><p>The drawbacks of using service mesh</p><ul><li><p>First, using a service mesh puts another piece of middleware, specifically a proxy, in the request path. This proxy can deliver a lot of value; but for those unfamiliar with the proxy, it can end up being a black box and make it harder to debug an application’s behavior.</p></li><li><p>Another drawback of using a service mesh is in terms of tenancy. A mesh is as valuable as the services running in the mesh. That is, the more services in the mesh, the more valuable the mesh becomes for operating those services.</p></li><li><p>Finally, a service mesh becomes a fundamentally important piece of your services and application architecture since it’s on the request path.</p></li></ul></li><li></li></ul><h2 id=chapter-2-first-steps-with-istio>Chapter 2 First steps with Istio</h2><ul><li><h3 id=istiod>Istiod</h3><ul><li>Istio’s control-plane responsibilities are implemented in the <code>istiod</code>component. <code>istiod</code>, sometimes referred to as Istio Pilot, is responsible for taking higher-level Istio configurations specified by the user/operator and turning them into proxy-specific configurations for each data-plane service proxy.</li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch02_f02_posta2.png alt></p><pre><code>+ Istio uses Envoy as its service proxy, so these configurations are translated to Envoy configurations.

+ Istio’s configuration resources are implemented as Kubernetes custom resource definitions (CRDs). In the case of Istio, we can use Istio’s custom resources (CRs) to add Istio functionality to a Kubernetes cluster and use native Kubernetes tools to apply, create, and delete the resources. Istio implements a controller that watches for these new CRs to be added and reacts to them accordingly.
</code></pre><ul><li><h3 id=ingress-and-egress-gateway>Ingress and egress gateway</h3></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch02_f04_posta2.png alt></p><pre><code>+ Ingress/egress gateways are really Envoy proxies that can understand Istio configurations.
</code></pre><h2 id=chapter-3-istios-data-plane-the-envoy-proxy>Chapter 3 Istio&rsquo;s data plane: The Envoy Proxy</h2><ul><li><p>Envoy can understand layer 7 protocols that an application may speak when communicating with other services.</p></li><li><h3 id=envoys-core-features>Envoy&rsquo;s core features</h3><ul><li><blockquote><p><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/intro/terminology#terminology target=_blank>Terminology in Envoy</a></p></blockquote></li><li><p><strong>Downstream</strong>: A downstream host connects to Envoy, sends requests, and receives responses.</p></li><li><p><strong>Upstream</strong>: An upstream host receives connections and requests from Envoy and return responses.</p></li><li><p><strong>Listeners</strong>: Expose a port to the outside world to which applications can connect. A listener in Envoy is a way to open a port on a networking interface and start listening to incoming traffic.</p></li><li><p><strong>Routes</strong>: Routing rules for how to handle traffic that comes in on listeners.</p></li><li><p><strong>Clusters</strong>: Specific upstream services to which Envoy can route traffic. <strong>Subsets</strong> are used to further divide workloads within a cluster, which enables fine-grained traffic management.</p></li><li><p>Traffic comes into a <em>listener</em> from a <em>downstream system</em>. This traffic is routed to one of Envoy’s <em>clusters</em>, which is responsible for sending that traffic to an <em>upstream system</em>.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch03_f03_posta2.png alt>
+</p><ul><li><h3 id=configuring-envoy>Configuring Envoy</h3><ul><li><h4 id=static-configuration>Static configuration</h4><ul><li>We can specify listeners, route rules, and clusters using Envoy’s configuration file.</li></ul></li><li><h4 id=dynamic-configuration>Dynamic configuration</h4><ul><li><p>Envoy uses its xDS APIs for dynamic configuration. xDS APIs include the following APIs:</p><ul><li><p>Listener discovery service (LDS): An API that allows Envoy to query what listeners should be exposed on this proxy.</p></li><li><p>Route discovery service (RDS): Part of the configuration for listeners that specifies which routes to use. This is a subset of LDS for when static and dynamic configuration should be used.</p></li><li><p>Cluster discovery service (CDS): An API that allows Envoy to discover what clusters and respective configuration for each cluster this proxy should have.</p></li><li><p>Endpoint discovery service (EDS): Part of the configuration for clusters that specifies which endpoints to use for a specific cluster. This is a subset of CDS.</p></li><li><p>Secret discovery service (SDS): An API used to distribute certificates.</p></li><li><p>Aggregate discovery service (ADS): A serialized stream of all the changes to the rest of the APIs. You can use this single API to get all of the changes in order.</p></li></ul></li><li><p>Envoy’s xDS APIs are built on a premise of eventual consistency and that correct configurations eventually converge</p></li></ul></li></ul></li></ul><h2 id=chapter-4-istio-gateways-getting-traffic-into-a-cluster>Chapter 4: Istio gateways: Getting traffic into a cluster</h2><ul><li><h3 id=traffic-ingress-concepts>Traffic ingress concepts</h3><ul><li><p>The networking community has a term for connecting networks via well-established entry points: <strong>ingress points</strong>. <strong>Ingress</strong> refers to traffic that originates outside the network and is intended for an endpoint within the network. The traffic is first routed to an ingress point that acts as a gatekeeper for traffic coming into the network. The ingress point enforces rules and policies about what traffic is allowed into the local network. If the ingress point allows the traffic, it proxies the traffic to the correct endpoint in the local network. If the traffic is not allowed, the ingress point rejects the traffic.</p></li><li><p><strong>Virtual IPs</strong>: Simplifying service access</p><ul><li>The virtual IP is bound to a type of ingress point known as a <strong>reverse proxy</strong>. The reverse proxy is an intermediary component that’s responsible for distributing requests to backend services and does not correspond to any specific service.</li></ul></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch04_f03_posta2.png alt></p><pre><code>+ **Virtual hosting**: Multiple services from a single access point


  + In addition to virtual IP, we can also represent multiple different hostnames using a single virtual IP.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch04_f04_posta2.png alt></p><pre><code>  + Hosting multiple different services at a single entry point is known as **virtual hosting**.
</code></pre><ul><li><h3 id=istio-ingress-gateways>Istio ingress gateways</h3><ul><li><p>Istio has the concept of an <strong>ingress gateway</strong> that plays the role of the network ingress point and is responsible for guarding and controlling access to the cluster from traffic that originates outside of the cluster. Additionally, Istio’s ingress gateway handles load balancing and virtual-host routing.</p></li><li><p>Istio uses a single Envoy proxy as the ingress gateway.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch04_f05_posta2.png alt></p><pre><code>+ Istio gateway: expose a specific port, expect a specific protocol on that port, and define specific hosts to serve from the port/protocol pair.

+ In Istio, a `VirtualService` resource defines how a client (inbound traffic) talks to a specific service through its fully qualified domain name. In other words, `VirtualService` allows us to route traffic from the ingress gateway to a specific service.

+ The `Gateway` resource defines ports, protocols, and virtual hosts that we wish to listen for at the edge of our service-mesh cluster. `VirtualService` resources define where traffic should go once it’s allowed in at the edge.

+ Istio `Gateway` handles the L4(transport) and L5(session) concerns, while `VirtualService` handles the L7(application) concerns.
</code></pre><ul><li><h3 id=securing-gateway-traffic>Securing gateway traffic</h3><ul><li><p>Istio’s gateway implementation allows us to terminate incoming TLS/SSL traffic, pass it through to the backend services, redirect any non-TLS traffic to the proper TLS ports, and implement mutual TLS.</p></li><li><p>Basic model of how TLS is established between a client and server.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch04_f08_posta2.png alt></p><pre><code>+ Basic model of how mTLS is established between a client and server
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch04_f10_posta2.png alt></p><h2 id=chapter-5-traffic-control-fine-grained-traffic-routing>Chapter 5: Traffic control: Fine-grained traffic routing</h2><ul><li><h3 id=deployment-vs-release>deployment vs release</h3><ul><li><p>Workloads can be separated into smaller subsets, such as version v1 and version v2, using <code>DestinationRules</code>. Then we can configure <code>VirtualService</code>s to use these subsets to route traffic in a fine-grained manner.</p></li><li><p>When we do a <em>deployment</em> to production, we install the new code onto production resources (servers, containers, and so on), but we do not send any traffic to it.
<img src=https://zhannicholas.github.io/assets/istioinaction/ch05_f02_posta2.png alt></p></li><li><p>Releasing code means bringing live traffic over to our new deployment.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch05_f03_posta2.png alt></p><pre><code>  + Now the old version of our software is taking the bulk of the live traffic, and the newer version is taking a small fraction of the traffic. This approach is known as _canarying_ or a _canary release_.

  + We can continue to shift traffic over to our new deployment until it’s fully released. At any point in this process, we may find that the new code doesn’t deliver the functionality, behavior, or performance we expected and validated through real user interaction. We can then roll back the release by directing traffic back to the previous version.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch05_f05_posta2.png alt></p><pre><code>  + 
</code></pre><h2 id=chapter-6-resilience-solving-application-networking--challenges>Chapter 6: Resilience: Solving application networking challenges</h2><ul><li><h3 id=client-side-load-balancing>Client-side load balancing</h3><ul><li><p><em>Client-side load balancing</em> is the practice of informing the client about the various endpoints available for a service and letting the client pick specific load-balancing algorithms for the best distribution of requests over the endpoints.</p></li><li><p>Service operators and developers can configure what load-balancing algorithm a client uses by defining a <code>DestinationRule</code> resource. Istio’s service proxy is based on Envoy and supports Envoy’s load-balancing algorithms, some of which include:</p><ul><li><p>Round robin (default)</p><ul><li>Round robin (or next-in-loop) delivers requests to endpoints in a successive loop.</li></ul></li><li><p>Random</p><ul><li>Random uniformly picks an endpoint at random.</li></ul></li><li><p>Weighted least request</p><ul><li><p>Round robin and random do not take any runtime behavior into account. The least-connection load balancer (in Envoy, it’s implemented as least request) <em>does</em> take into account the latencies of the specific endpoints.</p></li><li><p>Even though the Istio configuration refers to the least-request load balancing as <code>LEAST_CONN</code>, Envoy is tracking request depths for endpoints, not connections. The load balancer picks two random endpoints, checks which has the fewest active requests, and chooses the one with the fewest active requests.</p></li></ul></li></ul></li></ul></li><li><h3 id=locality-aware-load-balancing>Locality-aware load balancing</h3><ul><li><p>One role of a control plane like Istio’s is understanding the topology of services and how that topology may evolve. An advantage of understanding the overall topology of services in a service mesh is automatically making routing and load-balancing decisions based on heuristics like the locations of services and peer services.</p></li><li><p>Istio supports a type of load balancing that gives weights to routes and makes routing decisions based on where a particular workload is. Istio’s ability to load-balance across localities includes region, zone, and even a finer-grained subzone. Istio’s locality-aware load balancing is enabled by default.</p></li><li><p>When deploying in Kubernetes, region and zone information can be added to labels on the Kubernetes nodes. For example, the labels <code>failure-domain.beta.kubernetes.io/region</code> and <code>failure-domain.beta.kubernetes.io/zone</code> allow us to specify the region and zone, respectively. In recent, generally available versions of the Kubernetes API, those labels have been replaced with <code>topology.kubernetes.io/region</code> and <code>topology.kubernetes.io/zone</code>.</p></li><li><p>For locality-aware load balancing to work in Istio, we need to configure one last piece of the puzzle: <strong>health checking</strong>. Without health checking, Istio does not know which endpoints in the load-balancing pool are unhealthy and what heuristics to use to spill over into the next locality.</p></li><li><p><strong>Outlier detection</strong> passively watches the behavior of endpoints and whether they appear healthy. It does so by tracking errors that an endpoint may return and marking them as unhealthy.</p></li></ul></li><li><h3 id=transparent-timeouts-and-retries>Transparent timeouts and retries</h3><ul><li><p>Istio allows us to configure various types of timeouts and retries to overcome inherent network unreliability.</p></li><li><p>Generally, it makes sense to have larger timeouts at the edge (where traffic comes in) of an architecture and shorter (or more restrictive) timeouts for the layers deeper in the call graph.</p></li><li><p>We have to balance out the fact that unbridled retries can contribute to degraded system health, including causing cascading failures. If a service is legitimately overloaded and misbehaving, retrying requests will only amplify the degraded situation.</p></li><li><p>Istio has retries enabled by default and will retry up to <strong>two</strong> times.</p></li><li><p>Typically, it is safe to retry a request in these default situations because they indicate that network connectivity could not be established, and the request could not have been sent on the first try:</p><ul><li><p><code>connect-failure</code></p></li><li><p><code>refused-stream</code></p></li><li><p><code>unavailable</code> (gRPC status code 14)</p></li><li><p><code>cancelled</code> (gRPC status code 1)</p></li><li><p><code>retriable-status-codes</code> (defaults to HTTP 503 in Istio)</p></li></ul></li></ul></li><li><h3 id=circuit-breaking-with-istio>Circuit breaking with Istio</h3><ul><li><p>We use circuit-breaking functionality to help guard against partial or cascading failures.</p></li><li><p>Istio doesn’t have an explicit configuration called “circuit breaker,” but it provides two controls for limiting load on backend services, especially those experiencing issues, to effectively enforce a circuit breaker.</p><ul><li><p>The first is to manage how many connections and outstanding requests are allowed to a specific service.</p><ul><li><p>In Istio, we use the <code>connectionPool</code> settings in a destination rule to limit the number of connections and requests that can pile up when calling a service. If too many requests pile up, we can short-circuit them (fail fast) and return to the client.</p></li><li><p>When a request fails for tripping a circuit-breaking threshold, Istio’s service proxy adds an <code>x-envoy-overloaded</code> header.</p></li></ul></li><li><p>The second control is to observe the health of endpoints in the load-balancing pool and evict misbehaving endpoints for a time. Istio uses <code>OutlierDetection</code> to guard against unhealthy services.</p><ul><li>If certain hosts in a service pool are experiencing failures, we can skip sending traffic to them. If we exhaust all hosts, the circuit is effectively “open” for a while.</li></ul></li></ul></li></ul></li></ul><h2 id=chapter-7-observability-understanding-the-behavior-of-you-services>Chapter 7: Observability: Understanding the behavior of you services</h2><ul><li><h3 id=observability-vs-monitoring>Observability vs Monitoring</h3><ul><li><p><strong><a href=https://zhannicholas.github.io/pages/observability/>Observability</a></strong> is a characteristic of a system that is measured by the level to which you can understand and reason about a system’s internal state just by looking at its external signals and characteristics.</p></li><li><p>Observability is important to implement controls for a system in which we can change its run-time behavior.</p></li><li><p>** <a href=https://zhannicholas.github.io/pages/monitoring/>Monitoring</a>
** is the practice of collecting metrics, logs, traces, and so on, aggregating them, and matching them against predefined criteria of system states that we should carefully watch.</p></li><li><p>Monitoring is a subset of observability. With monitoring, we are specifically collecting and aggregating metrics to watch for known undesirable states and then alert on them. On the other hand, observability supposes that our systems are highly unpredictable, and we cannot know all of the possible failure modes in advance.</p></li></ul></li><li><p>Envoy has a notion of <em>internal origin</em> versus <em>external origin</em> when identifying traffic. <em>Internal</em> is typically what we recognize as traffic from within the mesh, and <em>external</em> is traffic originating outside the mesh (traffic coming into an ingress gateway).</p></li><li><h3 id=scraping-istio-metrics-with-prometheus>Scraping Istio metrics with Prometheus</h3><ul><li><p>To configure <a href=https://zhannicholas.github.io/pages/prometheus/>Prometheus</a>
to collect metrics from Istio, we will use the Prometheus Operator custom resources <code>ServiceMonitor</code> and <code>PodMonitor</code>.</p></li><li><p>We can set up a <code>ServiceMonitor</code> resource to scrape the Istio control-plane components.</p></li><li><p>To enable scraping for the data plane, we use a <code>PodMonitor</code> resource that configures the <a href=https://zhannicholas.github.io/pages/prometheus/>Prometheus</a>
Operator to scrape metrics from every Pod containing the istio-proxy container.</p></li></ul></li><li><h3 id=customizing--istios-standard-metrics>Customizing Istio&rsquo;s standard metrics</h3><ul><li>A <code>metric</code> is a counter, gauge, or histogram/distribution of telemetry between service calls (inbound/outbound).</li></ul></li></ul><h2 id=chapter-8-observability-visualizing-network-behavior-with-grafana-jaeger-and-kiali>Chapter 8: Observability: Visualizing network behavior with Grafana, Jaeger and Kiali</h2><ul><li><h3 id=using-grafana-to-visualize-istio-service-and-control-plane-metrics>Using Grafana to visualize Istio service and control-plane metrics</h3><ul><li>There are many out-of-box Grafana dashboards in <a href=https://grafana.com/grafana/dashboards/ target=_blank>grafana.com</a>
.</li></ul></li><li><h3 id=distributed-tracing>Distributed tracing</h3><ul><li><p>Distributed tracing gives us insights into the components of a distributed system involved in serving a request. It was introduced by the Google Dapper paper (“Dapper, a Large-Scale Distributed Systems Tracing Infrastructure,” 2010, https://research.google/pubs/pub36356) and involves annotating requests with <strong>correlation IDs</strong> that represent service-to-service calls and <strong>trace IDs</strong> that represent a specific request through a graph of service-to-service calls.</p></li><li><p>OpenTelemetry is a community-driven framework that includes OpenTracing, which is a specification that captures concepts and APIs related to distributed tracing.</p></li><li><h4 id=how-does-distributed-tracing-work>How does distributed tracing work?</h4><ul><li><p>At its simplest form, distributed tracing with OpenTracing consists of applications creating <code>Span</code>s, sharing those <code>Span</code>s with an OpenTracing engine, and propagating a trace context to any of the services it subsequently calls. A <code>Span</code> is a collection of data representing a <em>unit of work</em> within a service or component. This data includes things like the start time of the operation, the end time, the operation name, and a set of tags and logs.</p></li><li><p>In turn, those upstream services do the same thing: create a <code>Span</code> capturing its part of the request, send that to the OpenTracing engine, and further propagate the trace context to other services. Using these <code>Span</code>s and the trace context, the distributed-tracing engine can construct a <code>Trace</code>, which is a causal relationship between services that show direction, timing, and other debugging information. Spans have their own ID and a <code>Trace</code> ID. These IDs are used for correlation and are expected to be propagated between services.</p></li></ul></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch08_f07_posta2.png alt></p><pre><code>  + Istio can handle sending the `Span`s to the distributed tracing engine. When a request traverses the Istio service proxy, a new trace is started if there isn’t one in progress, and the start and end times for the request are captured as part of the `Span`. Istio appends HTTP headers, commonly known as the Zipkin tracing headers, to the request that can be used to correlate subsequent `Span` objects to the overall `Trace`. If a request comes into a service and the Istio proxy recognizes the distributed-tracing headers, the proxy treats it as an in-progress trace and does not try to generate a new one. The following Zipkin tracing headers are used by Istio and the distributed-tracing functionality:


    + `x-request-id`

    + `x-b3-traceid`

    + `x-b3-spanid`

    + `x-b3-parentspanid`

    + `x-b3-sampled`

    + `x-b3-flags`

    + `x-ot-span-context`

  + For the distributed-tracing functionality provided by Istio to work across the entire request call graph, each application needs to propagate these headers to any outgoing calls it makes.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch08_f08_posta2.png alt></p><h2 id=chapter-9-securing-microservice-communication>Chapter 9: Securing microservice communication</h2><ul><li><p>Istio is <em>secure by default</em>. Istio provides an automated way to issue the identity of services using the <strong>Secure Production Identity Framework for Everyone (SPIFFE)</strong> framework. The issued identity is used for services to mutually authenticate.</p></li><li><div class=tip><p>SPIFFE identity is an RFC 3986 compliant URI composed in the format <em>spiffe://trust-domain/path</em>, where</p><ul><li>The <em>trust-domain</em> represents the issuer of identities, such as an individual or organization.</li><li>The <em>path</em> uniquely identifies a workload within the trust domain.</li></ul></div></li><li><p>Istio populates the <em>path</em> above using the service account under which a particular workload runs. This SPIFFE identity is encoded in an X.509 certificate, also known as a <strong>SPIFFE Verifiable Identity Document (SVID)</strong>, which Istio’s control plane mints for workloads. These certificates are then used to secure the transport for service-to-service communication by encrypting data in transit.</p></li><li><h3 id=istio-security-in-a-nutshell>Istio security in a nutshell</h3><ul><li><p>Service mesh operator configures the service proxies using custom resources defined by Istio:</p><ul><li><p>The <code>PeerAuthentication</code> resource configures the proxy to authenticate <strong>service-to-service</strong> traffic. On successful authentication, the proxy extracts the information encoded in the peer’s certificate and makes it available to authorize the request.</p></li><li><p>The <code>RequestAuthentication</code> resource configures the proxy to authenticate <strong>end-user</strong> credentials against the servers that issued them. On successful authentication, it also extracts the information encoded in the credential and makes it available for authorizing the request.</p></li><li><p>The <code>AuthorizationPolicy</code> resource configures the <strong>proxy</strong> to authorize or reject requests by making decisions based on the data extracted by the previous two resources.</p></li></ul></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch09_f03_posta2.png alt></p><ul><li><h3 id=auto-mtls>Auto mTLS</h3><ul><li><p>Traffic between services that have the sidecar proxy injected is encrypted and mutually authenticated by default.</p></li><li><p>Basic model of how mTLS is established between a client and server</p></li><li><p>Workloads mutually authenticate using SVID certificates issued by the Istio certificate authority.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch09_f04_posta2.png alt></p><pre><code>+ ### Understanding Istio's PeerAuthentication resource

  + The `PeerAuthentication` resource enables configuration of workloads to either strictly require mTLS or be permissive and accept clear-text traffic, using the `STRICT` or `PERMISSIVE` authentication mode, respectively. The mutual authentication mode can be configured in different scopes:

    + _Mesh-wide_ `PeerAuthentication` policies apply to all workloads of the service mesh.

      + A mesh-wide `PeerAuthentication` policy must fulfill two conditions: it must be applied in the Istio installation namespace, and it must be named &quot;`default`&quot;.

    + _Namespace-wide_ `PeerAuthentication` policies apply to all workloads in a namespace.

    + _Workload-specific_ `PeerAuthentication` policies apply to all workloads that match the selector specified in the policy.

  + We can use workload-specific policies to allow non-mutually authenticated traffic until those are migrated into the mesh.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch09_f06_posta2.png alt></p><ul><li><h3 id=authorizing-service-to-service-traffic>Authorizing service-to-service traffic</h3><ul><li>Istio provides the <code>AuthorizationPolicy</code> resource, which is a declarative API to define mesh-wide, namespace, or workload-specific access policies in a service mesh. Authorization reduces the attack scope to only what the stolen identity was authorized to access.</li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch09_f09_posta2.png alt></p><pre><code>+ Evaluation flow of authorization policies
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch09_f10_posta2.png alt></p><pre><code>+ 
</code></pre><ul><li><h3 id=end-user-authentication-and-authorization>End-user authentication and authorization</h3><ul><li>The main purpose of the <code>RequestAuthentication</code> resource is to validate JWTs, extract the claims of valid tokens, and store those claims in filter metadata, which is used by authorization policies to take actions based on the data.</li></ul></li></ul><h2 id=chapter-10-troubleshooting-the-data-plane>Chapter 10: Troubleshooting the data plane</h2><ul><li>Components that participate in routing a request</li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch10_f01_posta2.png alt></p><ul><li><h3 id=identifying-data-plane-issues>Identifying data-plane issues</h3><ul><li><h4 id=verify-that-the-data-plane-is-up-to-date>Verify that the data plane is up to date</h4><ul><li><p>Considering that the primary function of the control plane is to synchronize the data plane to the latest configuration, the first step is to verify that the control plane and data plane are in sync.</p><ul><li><div class=tip>The data-plane configuration is eventually consistent by design.</div></li></ul></li><li><p>Series of events until the configuration of a data-plane component is updated after a workload becomes unhealthy.</p></li></ul></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch10_f03_posta2.png alt></p><pre><code>  + Check whether the data plane is synchronized with the latest configuration using `istioctl proxy-status` command. For example:
</code></pre><p>`shell
$ istioctl proxy-status</p><p>NAME CDS LDS RDS
catalog.&lt;&mldr;>.istioinaction SYNCED SYNCED SYNCED
`</p><pre><code>    + The output lists all workloads and their synchronization state for every xDS API.

      + `SYNCED`—Envoy has acknowledged the last configuration sent by the control plane.

      + `NOT SENT`—The control plane hasn’t sent anything to Envoy. This is usually because the control plane has nothing to send. Such is the case of the route discovery service (RDS) for istio-egressgateway, shown in the previous snippet.

      + `STALE`—The istiod control plane has sent an update, but it wasn’t acknowledged. This indicates one of the following: the control plane is overloaded; lack or drop of connectivity between Envoy and the control plane; or a bug on Istio.

+ #### Discovering misconfigurations with Kiali


  + The most common issues with the data-plane components are due to workload misconfiguration. Kiali can discover misconfigured services.

+ #### Discovering misconfigurations with istioctl

  + To automatically troubleshoot misconfigured workloads, two of the most useful [istioctl](https://istio.io/latest/docs/reference/commands/istioctl) commands are `istioctl analyze` and`istioctl describe` .
</code></pre><ul><li><h3 id=discovering-misconfigurations-manually-from-the-envoy-config>Discovering misconfigurations manually from the Envoy config</h3><ul><li><p>We can retrieve the Envoy configuration that is applied on a workload using the Envoy administration interface or <code>istioctl</code>.</p></li><li><h4 id=envoy-administration-interface>Envoy administration interface</h4><ul><li><p>The <a href=https://www.envoyproxy.io/docs/envoy/latest/operations/admin target=_blank>Envoy administration interface</a>
exposes the Envoy configuration and other capabilities to modify aspects of the proxy, such as increasing the logging level. This interface is accessible for every service proxy on port 15000.</p></li><li><p>Using  <code>istioctl</code> , we can port-forward it to our localhost:</p></li></ul></li></ul></li></ul><p>`shell
$ istioctl dashboard envoy deploy/xxx-deployment -n xxx-ns</p><p>http://localhost:15000
`</p><pre><code>  + Or we can use `kubectl exec` command directly:
</code></pre><p><code>shell $ kubectl -n xxx-ns exec xxx-pod -c istio-proxy -- curl http://localhost:15000/help</code></p><pre><code>+ #### Querying proxy configurations using istioctl


  + The `istioctl proxy-config` command enables us to retrieve and filter the proxy configuration of a workload based on the Envoy xDS APIs, where each subcommand is appropriately named. [Read more](https://istio.io/latest/docs/reference/commands/istioctl/#istioctl-proxy-config).
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch03_f03_posta2.png alt></p><pre><code>  + Troubleshooting steps:

    + id:: 62fc54ff-d00f-443c-9fa3-10b2cca094f8
</code></pre><ol><li>Query the Envoy listener configuration through <code>istioctl proxy-config listener</code> <a href=https://istio.io/latest/docs/reference/commands/istioctl/#istioctl-proxy-config-listener target=_blank>command</a>
.</li><li>Query the Envoy route configuration through <code>istioctl proxy-config route</code> <a href=https://istio.io/latest/docs/reference/commands/istioctl/#istioctl-proxy-config-route target=_blank>command</a>
.</li><li>Query the Envoy cluster configuration through <code>istioctl proxy-config cluster</code> <a href=https://istio.io/latest/docs/reference/commands/istioctl/#istioctl-proxy-config-cluster target=_blank>command</a>
.</li><li>Query the Envoy cluster endpoints through <code>istioctl proxy-config endpoint</code> <a href=https://istio.io/latest/docs/reference/commands/istioctl/#istioctl-proxy-config-endpoint target=_blank>command</a>
.</li></ol><h2 id=chapter-11-performance-tuning-the-control-plane>Chapter 11: Performance-tuning the control plane</h2><ul><li><h3 id=the-control-planes-primary-goal>The control plane&rsquo;s primary goal</h3><ul><li><p>Istio’s control plane listens to events from Kubernetes and updates the configuration to reflect the new desired state.</p></li><li><p>A common phenomenon that crops up when performance degrades is known as <em>phantom workloads</em>: services are configured to route traffic to endpoints that are already long gone, and hence the requests fail.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch11_f01_posta2.png alt></p><pre><code>+ Due to the eventually consistent nature of the data plane, having a stale configuration for a short time won’t cause too many negative consequences, as other protective mechanisms such as retry (to another health endpoint) and outlier detection (which ejects endpoints from the cluster) can be employed.

+ The sequence of actions to push the latest configuration to workloads.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch11_f02_posta2.png alt></p><pre><code>+ `istiod` protects itself from becoming overloaded by using the two practices of **debouncing** and **throttling**.
  + <div class=note>
    <strong>Debouncing</strong>: The DiscoveryServer component of istiod listens for these events. To improve performance, it delays adding the event to the push queue for a defined time to batch and merge subsequent events for that period.
</div>
</code></pre><h2 id=chapter-14-extending-istio-on-the-request-path>Chapter 14: Extending Istio on the request path</h2><ul><li><h3 id=envoys-extension-capabilities>Envoy&rsquo;s extension capabilities</h3><ul><li><h4 id=understanding-envoys-filter-chaining>Understanding Envoy&rsquo;s filter chaining</h4><ul><li><h3 id=envoys-core-features-1>Envoy&rsquo;s core features</h3></li><li><p><strong>Listeners</strong>: Expose a port to the outside world to which applications can connect. A listener in Envoy is a way to open a port on a networking interface and start listening to incoming traffic.</p><ul><li>A listener reads bytes off the networking stream and processes them through various <strong>filters</strong> or stages of functionality.</li></ul></li></ul></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch14_f02_posta2.png alt></p><pre><code>    + Envoy’s most basic filters are *network* filters, which operate on a stream of bytes for either encoding or decoding. You can configure more than one filter to operate on the stream in a sequence called a **filter chain**, and these chains can be used to implement the functionality of the proxy.

+ #### Filters intended for extension

  + Although you can write your own filters in C++ and build them into the proxy, there are ways to extend Envoy’s HTTP capabilities, including writing filters, without compiling changes into the Envoy binary itself, by using the following HTTP filters:

    + External processing

    + Lua

    + Wasm (WebAssembly)

  + With these filters, you can configure calls out to an external service, run a Lua script, or run custom code to enhance the capabilities of the HCM when processing HTTP requests or responses.
</code></pre><ul><li><h3 id=configuring-an-envoy-filter-with-the-envoyfilter-resource>Configuring an Envoy filter with the EnvoyFilter resource</h3><ul><li><p>Istio’s <code>EnvoyFilter</code> resource is intended for advanced use cases where a user needs to either tweak or configure a portion of Envoy not exposed by Istio’s higher-level APIs.</p></li><li><div class=caution>The <code>EnvoyFilter</code> resource is intended for advanced usage of Istio and is a “<strong>break glass</strong>” solution. The underlying Envoy API may change at any time between releases of Istio, so be sure to validate any <code>EnvoyFilter</code> you deploy.</div></li><li><p>The first thing to know about an <code>EnvoyFilter</code> resource is that it applies to <strong>all workloads in the namespace</strong> for which it is declared, unless you specify otherwise. If you want to be more specific about the workloads in a namespace to which the custom  <code>EnvoyFilter</code>  configuration applies, you can use a <strong><code>workloadSelector</code></strong>.</p></li><li><p>The second thing to know about an <code>EnvoyFilter</code> resource is that it applies after all other Istio resources have been translated and configured.</p></li><li><p>Finally, you should take great care when configuring a workload with the <code>EnvoyFilter</code> resource. You should be familiar with Envoy naming conventions and configuration specifics. This really is an advanced usage of Istio’s API and can bring down your mesh if misconfigured.</p></li></ul></li><li><h3 id=rate-limiting-requests-with-external-call-out>Rate-limiting requests with external call-out</h3><ul><li><p>There are also out-of-the-box filters that enhance the data plane with functionality that exists as a <em>call-out</em>. With these filters, we call out to an external service and have it perform some functionality that can determine how or whether to continue with a request.</p></li><li><p>Multiple replicas of the same service call the same rate-limit service to get <strong>global rate limiting</strong> for a particular service.</p></li></ul></li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch14_f06_posta2.png alt></p><pre><code>+ With this architecture (global rate limiting), we can ensure that a rate limit is enforced **regardless of how many replicas of a service exist**.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch14_f07_posta2.png alt></p><pre><code>+ #### Understanding Envoy rate limiting

  + Before configuring the Envoy **rate-limit server (RLS)**, we need to understand how rate limiting works.
  + When the rate-limit filter processes an HTTP request, it takes certain **attributes** from the request and sends them out to the RLS to make a rate-limit decision against a preconfigured set of descriptors. Envoy rate-limiting terminology uses the word ***descriptors*** to refer to attributes or groups of attributes. These descriptors, or attributes, of the request can be things like remote address, request headers, destination, or any other generic attributes about the request.

  + The RLS evaluates the request attributes that have been sent as part of a request against a set of predefined attributes.
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/ch14_f08_posta2.png alt></p><pre><code>  + Steps to configure global rate limiting:

    + 1. Configure the Envoy rate-limit server, register the rate-limit service as an envoy cluster. This is done via an envoy filter patch which is applied at the cluster level. 
</code></pre><ol start=2><li><p>Configure Envoy with which attributes to send for a particular request. Envoy terminology refers to this configuration as the rate-limit <em><strong>actions</strong></em> taken for a particular request path.</p><ul><li></li></ul></li></ol><h2 id=appendix-b-istios-sidecar-and-its-injection-options>Appendix B. Istio&rsquo;s sidecar and its injection options</h2><ul><li>Istio’s data-plane components</li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/appb_f01_posta2.png alt></p><ul><li><p>sidecar injection</p><ul><li>Manual injection</li></ul></li></ul><p><code>shell $ istioctl kube-inject -f deployment.yaml</code></p><p><img src=https://zhannicholas.github.io/assets/istioinaction/appb_f02_posta2.png alt></p><pre><code>+ Auto injection

  + How it works


    + <div class=tip>
    Automatic sidecar injection uses Kubernetes mutating admission webhooks to inject data-plane components into the <code>Pod</code> definition before it is applied to the Kubernetes datastore
</div>
</code></pre><p><img src=https://zhannicholas.github.io/assets/istioinaction/appb_f03_posta2.png alt></p><pre><code>  + Automatic sidecar injection is an opt-in feature enabled on a namespace-by-namespace basis. To do this, you label the namespace with  `istio-injection=enabled` .
</code></pre><h2 id=appendix-d-troubleshooting-istio-components>Appendix D. Troubleshooting Istio components</h2><ul><li>Agent and Envoy proxy ports and their functionality</li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/appd_f01_posta2.png alt></p><ul><li>The exposed <code>istiod</code>(Istio Pilot) ports and their functionality</li></ul><p><img src=https://zhannicholas.github.io/assets/istioinaction/appd_f02_posta2.png alt></p><ul><li></li></ul></div><hr><aside><h4>No linked references</h4></aside><br><aside class=related></aside></article></div><div x-cloak x-data="{ atTop: false }"><button id=scrollToTop name="scroll to top button" aria-label="scroll to top button" class="fixed z-50 w-10 h-10 font-bold text-center text-white transition-all duration-1000 ease-in-out transform bg-violet-600 rounded-full cursor-pointer animate-bounce bottom-24 right-8 focus:outline-none" :class="{ 'opacity-0 translate-y-24': !atTop, 'opacity-1 translate-y-2' :  atTop}" @click="window.scrollTo({ top: 0, behavior: 'smooth'})" @scroll.window="atTop = (window.pageYOffset > 200)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 11l3-3m0 0 3 3m-3-3v8m0-13a9 9 0 110 18 9 9 0 010-18z"/></svg></button></div><script src=https://zhannicholas.github.io/js/alpine.js defer></script>
<script src=https://zhannicholas.github.io/js/darkmode.js defer></script><footer class=bg-gray-900><div class="max-w-md px-4 py-12 mx-auto overflow-hidden sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:px-8"><nav class="flex flex-wrap justify-center -mx-5 -my-2" aria-label=Footer><div class="px-5 py-2"><a href=https://zhannicholas.github.io/about class="text-base text-gray-400 hover:text-gray-300">About</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/posts class="text-base text-gray-400 hover:text-gray-300">Posts</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/pages class="text-base text-gray-400 hover:text-gray-300">Notes</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/library class="text-base text-gray-400 hover:text-gray-300">Library</a></div><div class="px-5 py-2"><a href=https://zhannicholas.github.io/contact/ class="text-base text-gray-400 hover:text-gray-300">Contact</a></div></nav><div class="flex justify-center mt-2 space-x-6"><a href=https://github.com/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>GitHub</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483.0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951.0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65.0.0.84-.27 2.75 1.026A9.564 9.564.0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688.0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855.0 1.338-.012 2.419-.012 2.747.0.268.18.58.688.482A10.019 10.019.0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg></a>
<a href=mailto:zhan_nicholas@outlook.com class="text-gray-400 hover:text-gray-300"><span class=sr-only>Email</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M21 7.38246601V5H3V7.38199365l9.0000224 4.50046115L21 7.38246601zm0 2.23606798-9.0000224 4.50001121L3 9.61810635V19H21V9.61853399zM3 3H21c1.1045695.0 2 .8954305 2 2V19c0 1.1045695-.8954305 2-2 2H3c-1.1045695.0-2-.8954305-2-2V5c0-1.1045695.8954305-2 2-2z" clip-rule="evenodd"/></svg></a>
<a href=https://t.me/zhannicholas class="text-gray-400 hover:text-gray-300"><span class=sr-only>Telegram</span><svg class="w-6 h-6" fill="currentcolor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.78754 14.0196C5.83131 14.0344 5.87549 14.0448 5.91963 14.0512 5.96777 14.1644 6.02996 14.3107 6.10252 14.4818c.17707.4176.41566.9825.66194 1.5717C7.2667 17.2552 7.77332 18.4939 7.88521 18.8485 8.02372 19.2868 8.17013 19.5848 8.32996 19.7883 8.4126 19.8935 8.50819 19.9853 8.62003 20.0549 8.67633 20.0899 8.7358 20.1186 8.79788 20.14 8.80062 20.141 8.80335 20.1419 8.80608 20.1428 9.1261 20.2636 9.41786 20.2133 9.60053 20.1518 9.69827 20.1188 9.77735 20.0791 9.8334 20.0469 9.86198 20.0304 9.88612 20.0151 9.90538 20.0021L9.90992 19.9991l2.82618-1.7625 3.2646 2.5028C16.0488 20.7763 16.1014 20.8073 16.157 20.8316 16.5492 21.0027 16.929 21.0624 17.2862 21.0136 17.6429 20.9649 17.926 20.8151 18.1368 20.6464 18.3432 20.4813 18.4832 20.2963 18.5703 20.1589 18.6148 20.0887 18.6482 20.0266 18.6718 19.9791 18.6836 19.9552 18.6931 19.9346 18.7005 19.9181L18.7099 19.8963 18.7135 19.8877 18.715 19.8841 18.7156 19.8824 18.7163 19.8808C18.7334 19.8379 18.7466 19.7935 18.7556 19.7482L21.7358 4.72274C21.7453 4.67469 21.7501 4.62581 21.7501 4.57682 21.7501 4.13681 21.5843 3.71841 21.1945 3.46452 20.8613 3.24752 20.4901 3.23818 20.2556 3.25598 20.0025 3.27519 19.7688 3.33766 19.612 3.38757 19.5304 3.41355 19.4619 3.43861 19.4126 3.45773 19.3878 3.46734 19.3675 3.47559 19.3523 3.48188L19.341 3.48666 2.62725 10.0432 2.62509 10.044C2.61444 10.0479 2.60076 10.053 2.58451 10.0593 2.55215 10.0719 2.50878 10.0896 2.45813 10.1126 2.35935 10.1574 2.22077 10.2273 2.07856 10.3247c-.22719.1556-.74968.5817-.6617 1.285.07019.5611.45457.9057.68876 1.0714C2.23421 12.7721 2.35638 12.8371 2.44535 12.8795 2.48662 12.8991 2.57232 12.9339 2.6095 12.9491L2.61889 12.9529l3.16865 1.0667zM19.9259 4.86786 19.9236 4.86888C19.9152 4.8725 19.9069 4.87596 19.8984 4.87928L3.1644 11.4438C3.15566 11.4472 3.14686 11.4505 3.138 11.4536L3.12869 11.4571C3.11798 11.4613 3.09996 11.4686 3.07734 11.4788 3.06451 11.4846 3.05112 11.491 3.03747 11.4978 3.05622 11.5084 3.07417 11.5175 3.09012 11.5251 3.10543 11.5324 3.11711 11.5374 3.1235 11.54l3.14263 1.058C6.32365 12.6174 6.37727 12.643 6.42649 12.674L16.8033 6.59948 16.813 6.59374C16.8205 6.58927 16.8305 6.58353 16.8424 6.5768 16.866 6.56345 16.8984 6.54568 16.937 6.52603 17.009 6.48938 17.1243 6.43497 17.2541 6.39485 17.3444 6.36692 17.6109 6.28823 17.899 6.38064 18.0768 6.43767 18.2609 6.56028 18.3807 6.76798 18.4401 6.87117 18.4718 6.97483 18.4872 7.06972 18.528 7.2192 18.5215 7.36681 18.4896 7.49424 18.4208 7.76875 18.228 7.98287 18.0525 8.14665 17.9021 8.28706 15.9567 10.1629 14.0376 12.0147 13.0805 12.9381 12.1333 13.8525 11.4252 14.5359l-.465.449 5.8719 4.5018C16.9668 19.5349 17.0464 19.5325 17.0832 19.5274 17.1271 19.5214 17.163 19.5045 17.1997 19.4752 17.2407 19.4424 17.2766 19.398 17.3034 19.3557L17.3045 19.354 20.195 4.78102C20.1521 4.79133 20.1087 4.80361 20.0669 4.81691 20.0196 4.83198 19.9805 4.84634 19.9547 4.85637 19.9418 4.86134 19.9326 4.86511 19.9276 4.86719L19.9259 4.86786zM11.4646 17.2618 10.2931 16.3636 10.0093 18.1693 11.4646 17.2618zM9.21846 14.5814l1.16494-1.1247c.7081-.6835 1.6555-1.5979 2.6127-2.5215l.9725-.9382-6.52007 3.8168L7.48351 13.8963c.1777.4191.41736.9864.664940000000001 1.5788.185129999999999.4429.37872.9093.55504 1.3411l.28304-1.8004C9.01381 14.8422 9.09861 14.692 9.21846 14.5814z" clip-rule="evenodd"/></svg></a></div><p class="mt-2 text-base text-center text-gray-400">2018-2023 &copy; Nicholas Zhan. Licensed under <a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a>.</p><p class="mt-2 text-base text-center text-gray-400">Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/sawhney17/logseq-schrodinger>logseq-schrodinger</a>.</p></div></footer></body></html>